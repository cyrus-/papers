%\documentclass[12pt]{article}
\documentclass[12pt]{article}
\usepackage{fullpage,cmu-titlepage2}
\usepackage{times}
% The following \documentclass options may be useful:
%
% 10pt          To set in 10-point type instead of 9-point.
% 11pt          To set in 11-point type instead of 9-point.
% authoryear    To obtain author/year citation style instead of numeric.
\usepackage{amsmath}
\usepackage{amssymb} 
\usepackage{amsthm}
\usepackage{ stmaryrd }
\usepackage{mathpartir}
\usepackage{enumerate}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{tabularx}
\input{macros-catlam}
\usepackage{morefloats}

\usepackage{times}
\renewcommand{\ttdefault}{txtt}
\usepackage{alltt}
\usepackage{listings}
\lstset{language=ML,
showstringspaces=false,
basicstyle=\ttfamily\footnotesize,
morekeywords={newcase,extends}}

\usepackage{url}
\usepackage{todonotes}
\lefthyphenmin=5
\sloppy

\newcommand{\moutput}{^{\color{gray}+}}
\newcommand{\rulename}[1]{(#1)}
\def \TirNameStyle #1{\small\rulename{#1}}
\renewcommand{\MathparLineskip}{\lineskiplimit=.6\baselineskip\lineskip=.6\baselineskip plus .2\baselineskip}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{definition}{Definition}
\newtheorem{tyconinvariant}{Tycon Invariant}
\newtheorem{assumption}{Assumption}
\newenvironment{proof-sketch}{\noindent{\emph{Proof Sketch.}}}{\qed}
\makeatletter

% Heather-added packages for the fancy table
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{pdflscape}
\usepackage{colortbl}%
\newcommand{\myrowcolour}{\rowcolor[gray]{0.925}}
\usepackage{wasysym}

\renewcommand\topfraction{0.85}
\renewcommand\bottomfraction{0.85}
\renewcommand\textfraction{0.1}
\renewcommand\floatpagefraction{0.85}

\newcommand{\pfcase}[1]{\textbf{Case}~#1. }
\newcommand{\pfcases}[1]{\textbf{Cases}~#1. }

\usepackage{hyperref}
\hypersetup{
    colorlinks,
    citecolor=black,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}

\begin{document}

%\titlebanner{{\tt \textcolor{Red}{{\small Under Review -- distribute within CMU only.}}}}        % These are ignored unless
%\preprintfooter{Distribute within CMU only.}   % 'preprint' option specified.

\title{Modularly Composing Typed Language Fragments (Supplemental Material)}
%\subtitle{Supplemental Material}
%\authorinfo{}{}{}
%\authorinfo{Cyrus Omar \and Jonathan Aldrich}
 %         {Carnegie Mellon University}
  %         {\{comar, aldrich\}@cs.cmu.edu}   

\author{ }

\abstract{
    This document provides the full technical development described in the paper ``Modularly Composing Typed Language Fragments'' submitted to PLDI 2015. 
}
\keywords{Statistical Model Checking, Markov Decision Processes, Reinforcement Learning}

\trnumber{ }

\maketitle

%\category{D.3.2}{Programming Languages}{Language Classifications}[Extensible Languages]
%\category{D.3.4}{Programming Languages}{Processors}[Compilers]
%\category{F.3.1}{Logics \& Meanings of Programs}{Specifying and Verifying and Reasoning about Programs}[Specification Techniques]
%\keywords
%extensible languages; module systems; type abstraction; typed compilation; type-level computation

\tableofcontents 
\listoffigures

\newpage



\section{Internal Language}
\subsection{Semantics}
We assume an internal language where the statics are specified in the standard way by judgements for  type formation {$\iDelta \vdash \tau$}, typing context formation { $\iDelta \vdash \iGamma$} and type assignment {$\iDelta~\iGamma \vdash \iota : \tau\moutput$}. 
%The typing and type formation contexts obey standard structural properties (i.e. weakening, exchange and contraction). 
The internal dynamics are specified as a structural operational semantics with a stepping judgement {\small $\iota \mapsto \iota\moutput$} and a value judgement {$\iota~\mathtt{val}$}. The multi-step judgement $\iota \mapsto^{*} \iota\moutput$ is the reflexive, transitive closure of the stepping judgement and the evaluation judgement $\iota \Downarrow \iota'$ is defined iff $\iota \mapsto^{*} \iota'$ and $\iota'~\mathtt{val}$. Both the static and dynamic semantics of the IL can be found in any standard textbook covering typed lambda calculi (we directly follow \cite{pfpl}), so we assume familiarity and give the lemmas in this section without proof.

Our particular choice in the paper is {$\mathcal{L}\{{\rightharpoonup}\,{\forall}\,{\mu}\,{\iunit}\,{\times}\,{+}\}$}, the syntax for which is shown in Figure \ref{syntax-IL}, as representative of any intermediate language for a typed functional language. In fact, our intention is not to prescribe a particular choice of IL, so we will here only review the key metatheoretic properties that the IL must possess. Each choice of IL is technically a distinct dialect of @$\lambda$, but for the broad class of ILs that enjoy these properties, the metatheory in the remainder of the supplement should follow without trouble.

\begin{assumption}[Internal Type Assignment]
If $\Delta \vdash \Gamma$ and $\Delta~\Gamma \vdash \iota : \tau$ then $\Delta \vdash \tau$.
\end{assumption}

Internal type safety follows the standard methodology: preservation and progress lemmas.

\begin{assumption}[Internal Progress]
If $\emptyset~\emptyset \vdash \iota : \tau$ then either $\iota~\texttt{val}$ or $\iota \mapsto \iota'$.
\end{assumption}
\begin{assumption}[Internal Preservation]
If $\emptyset~\emptyset \vdash \iota : \tau$ and $\iota \mapsto \iota'$ then $\emptyset~\emptyset \vdash \iota' : \tau$. 
\end{assumption}

We assume that typing and type formation contexts, $\Delta$ and $\Gamma$, are identified up to exchange and contraction and the internal semantics obeys weakening. We assume that the names of variables and type variables are unimportant, so that $\alpha$-equivalent terms, types and contexts are identified implicitly throughout this work. 

\subsection{Explicit Substitutions}
We also assume substitution is defined in the usual way. We define explicit $n$-ary substitutions for type variables, $\delta$, and term variables, $\gamma$, also in the standard way, writing $[\delta]\Gamma$, $[\delta]\tau$ and $[\delta]\iota$ for application of type substitutions and $[\gamma]\iota$ for application of term substitutions. We need the definitions of substitution validity shown in Figures \ref{fig:internal-type-substitution-validity} and \ref{fig:internal-term-substitution-validity} and assume the following lemmas.



\begin{assumption}[Internal Term Substitutions] 
\label{assumption:internal-term-substituions}
If $\Delta \vdash \Gamma$ and $\Delta \vdash \Gamma'$ and $\Delta~\Gamma \vdash \gamma : \Gamma'$ and $\Delta~\Gamma\Gamma' \vdash \iota : \tau$ then $\Delta~\Gamma \vdash [\gamma]\iota : \tau$.
\end{assumption}

\begin{assumption}[Internal Type Substitution on Types]
\label{lemma:internal-type-substitution-on-types} If $\Delta \vdash \delta : \Delta'$ and $\Delta\Delta' \vdash \tau$ then $\Delta \vdash [\delta]\tau$.\end{assumption}

\begin{assumption}[Internal Type Substitutions on Typing Contexts] 
\label{lemma:internal-type-substitutions-on-typing-contexts}
If $\Delta \vdash \delta : \Delta'$ and $\Delta\Delta' \vdash \Gamma$ then $\Delta \vdash [\delta]\Gamma$.
\end{assumption}

\begin{assumption}[Internal Type Substitutions on Terms] 
\label{lemma:internal-type-substitutions-on-terms}
If $\Delta \vdash \delta : \Delta'$ and $\Delta\Delta' \vdash \tau$ and $\Delta\Delta' \vdash \Gamma$ and $\Delta\Delta'~\Gamma \vdash \iota : \tau$ then $\Delta~[\delta]\Gamma \vdash [\delta]\iota : [\delta]\tau$.
\end{assumption}



\newpage
\section{Tycon Contexts}
Tycon contexts, $\Phi$, are semantically defined as ordered mappings from tycon names $\tc$ to tycon definitions. As with all ordered mappings, we implicitly assume that all names are unique and that certain operations, e.g. $\text{dom}(\Phi)$, which extracts a set of tycon names, and $\tcdef{\tc}{\psi}{\theta} \in \Phi$, which checks whether a tycon definition is in $\Phi$, and $\Phi\Phi'$, which concatenates two tycon contexts with disjoint domains, are available without defining them explicitly. 

\subsection{Validity}

The tycon context validity judgement $\vdash \Phi$ is specified in Figure \ref{fig:tycon-ctxs}. The kinding and kind formation rules will be given in the next section.



\begin{lemma}[Tycon Context Validity]
\label{lemma:tycon-context-validity}
If (a) $\vdash \Phi$ and (b) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$ then there exists a prefix $\Phi'$ of $\Phi$ such that (i) $\vdash \Phi'$ and (ii) $\vdash \Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$ and (iii) $\keq{}{\ktyidx}$ and (iv) $\sofkz{\emptyset}{\emptyset}{\Phi'}{\stx{schema}}{\ktyidx \rightarrow \kity}$ and (v) $\vdash_{\Phi',  \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$.
\end{lemma}
\begin{proof} Rule induction on (a) and (b).

\pfcase{(tcc-emp)} Does not apply by (b).

\pfcase{(tcc-ext)} We have two cases by (b):\begin{quote}
\pfcase{$\Phi=\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$} In this case, we pick $\Phi'$ and have our conclusions:
\begin{enumerate}
\item[(i)] $\vdash \Phi'$ (premise 1 of (tcc-ext))
\item[(ii)] $\vdash \Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$ (by assumption (a))
\item[(iii)] $\keq{}{\ktyidx}$ (premise 2 of (tcc-ext))
\item[(iv)] $\sofkz{\emptyset}{\emptyset}{\Phi'}{\stx{schema}}{\ktyidx \rightarrow \kity}$ (premise 3 of (tcc-ext))
\item[(v)] $\vdash_{\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$ (premise 4 of (tcc-ext))
\end{enumerate}

\pfcase{$\Phi=\Phi', \tcdef{\tc'}{\psi'}{\theta'}$ for $\tc\neq\tc'$ and (1) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}} \in \Phi'$} We have the following:

\begin{enumerate}
\item[(2)] $\vdash \Phi'$ (premise 1 of (tcc-ext))
\item[] Apply IH to (2) and (1). There exists a prefix $\Phi''$ of $\Phi'$ such that 
\item[(3)] $\vdash \Phi''$
\item[(4)] $\vdash \Phi'', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$
\item[(5)] $\keq{}{\ktyidx}$ 
\item[(6)] $\sofkz{\emptyset}{\emptyset}{\Phi''}{\stx{schema}}{\ktyidx \rightarrow \kity}$
\item[(7)] $\vdash_{\Phi'',  \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$
\end{enumerate}

By transitivity of prefixing, we have that $\Phi''$ is a prefix of $\Phi$. Picking $\Phi''$, conclusions (i-v) are (3-7), respectively.
\end{quote}
\end{proof}


In the final premise of (tcc-ext), the opcon structure is checked against the tycon's signature by the rules in Figure \ref{ocstruct}. Opcon structures and opcon signatures are finite maps, so we implicitly assume that all operator names are unique and standard operations are defined as above.

\begin{lemma}[Intro Opcon Existence and Validity]
\label{lemma:intro-opcon-existence-and-validity}
If $\vdash_\Phi \omega \sim \tcsig{\ktyidx}{\chi}$ then (i) $\keyw{intro}[\klitidx] \in \chi$ and (ii) $\emptyset \vdash \klitidx$ and (iii) $\keyw{ana~intro}=\stx{def}\in\omega$ and (iv) $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$.
\end{lemma}
\begin{proof}
Rule induction on assumption. 

\pfcase{(ocstruct-intro)} We have that $\omega=\keyw{ana~intro}=\stx{def}$ and $\chi=\keyw{intro}[\klitidx]$.

\begin{enumerate}[(i)]
\item $\keyw{intro}[\klitidx] \in \keyw{intro}[\klitidx]$ (by definition)
\item $\emptyset \vdash \klitidx$  (premise 1)
\item  $\keyw{ana~intro}=\stx{def}\in\keyw{ana~intro}=\stx{def}$ (by definition)
\item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$ (premise 2)
\end{enumerate}

\pfcase{(ocstruct-targ)} We have that $\omega=\tcstructc{\omega'}{op}{\stx{def}}$ and  $\chi=\chi'; \opsig{\opname{op}}{\klitidx'}$.
\begin{enumerate}[(1)]
\item $\vdash_\Phi \omega' \sim \tcsig{\ktyidx}{\chi}$ (premise 1)
\item[] Apply IH to (1):
\item $\introsig{\klitidx} \in \chi'$
\item $\emptyset \vdash \klitidx$
\item $\keyw{ana~intro}=\stx{def}\in\omega'$
\item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$
\end{enumerate}
We can now conclude:
\begin{enumerate}[(i)]
\item $\introsig{\klitidx} \in \chi$ by extension of finite mappings on (2)
\item $\emptyset \vdash \klitidx$ by (3)
\item $\keyw{ana~intro}=\stx{def}\in\omega$ by extension of finite mappings on (4)
\item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$ by (5).
\end{enumerate}
\end{proof}
\begin{lemma}[Targeted Opcon Validity]
\label{lemma:targeted-opcon-validity}
If (a) $\vdash_\Phi \omega \sim \tcsig{\ktyidx}{\chi}$ and (b) $\keyw{syn}~\opname{op}=\stx{def} \in \omega$ then (i) $\opname{op}[\klitidx] \in \chi$ and (ii) $\emptyset \vdash \klitidx$ and (iii) $
    \sofkn{\emptyset}{\emptyset}{\Phi}{0}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.
\end{lemma}
\begin{proof}
Rule induction on assumption (a). 

\pfcase{(ocstruct-intro)} Does not apply by (b).

\pfcase{(ocstruct-targ)} We have two cases by (b).\begin{quote}\pfcase{$\omega=\omega'; \keyw{syn}~\opname{op}=\stx{def}$ and $\chi=\chi', \opname{op}[{\klitidx}]$} Conclusion (i) follows by definition and conclusions (ii) and (iii) are premises 2 and 3 of (ocstruct-targ).

\pfcase{$\omega=\omega'; \keyw{syn}~\opname{op}'=\stx{def}'$ such that $\opname{op}\neq\opname{op'}$ and (1) $\keyw{syn}~\opname{op}=\stx{def} \in \omega'$} In this case, we have 
    \begin{enumerate}
    \item[(2)] $\vdash_\Phi \omega' \sim \tcsig{\ktyidx}{\chi'}$ (premise 1 of (ocstruct-targ))
    \end{enumerate}

    Applying the IH to (2) and (1), we have:
    \begin{enumerate}[(1)]
    \item[(3)] $\opname{op}[\klitidx] \in \chi'$
    \item[(4)] $\emptyset \vdash \klitidx$
    \item[(5)] $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$
    \end{enumerate}

    We thus have conclusion (i) by extension of finite mappings on (3), and conclusions (ii) and (iii) are (4) and (5).
\end{quote}
\end{proof}

\subsection{Signature Validity}

For the purposes of the SL, only the type signatures are relevant.\footnote{In fact, only the type index kind is relevant, though in future work the remainder will likely be and it is cleaner to define complete signature checking.} It is thus useful to define judgements for checking tycon signature validity separately. The judgements $\vdash \psi$ for tycon signatures, $\vdash \chi$ for opcon signatures, and $\vdash \Phi~\mathtt{sigsok}$ for all signatures in a tycon context are in Figure \ref{fig:tycon-and-opcon-signature-well-formedness}. Kind and equality kind formation are covered in the next section.

\begin{lemma}[Signatures Define Equality Type Index Kinds]
\label{lemma:sigs-define-eq-type-index-kinds}
If $\vdash \tcsig{\ktyidx}{\chi}$ then $\keq{}{\ktyidx}$.
\end{lemma}
\begin{proof} By rule induction on the assumption. The conclusion is the first premise.
\end{proof}


\begin{lemma}[Valid Opcon Structures Define Valid Opcon Signatures]
\label{lemma:chi-ok}
If $\vdash_\Phi \omega \sim \tcsig{\ktyidx}{\chi}$ then $\vdash \chi$.
\end{lemma}
\begin{proof} By rule induction on the assumption. 

\pfcase{(ocstruct-intro)} We have that $\chi=\introsig{\klitidx}$ and (1) $\emptyset \vdash \ktyidx$. Apply (ocsig-intro-ok) to (1).

\pfcase{(ocstruct-targ-ok)} We have that $\chi=\chi', \opsig{\opname{op}}{\klitidx}$ and (1) $\vdash_\Phi \omega \sim \tcsig{\klitidx}{\chi'}$ and (2) $\emptyset \vdash \klitidx$. Applying the IH to (1), we have (3) $\vdash \chi'$. Apply (ocsig-targ-ok) to (3) and (2). 
\end{proof}

\begin{lemma}[Well-Defined Contexts Have Well-Formed Signatures]
\label{lemma:well-defined-contexts-have-well-formed-signatures}
If $\vdash \Phi$ then $\vdash \Phi~\mathtt{sigsok}$.
\end{lemma}
\begin{proof} By rule induction on the assumption.

\pfcase{(tcc-emp)} Apply (tcc-sigsok-emp).

\pfcase{(tcc-ext)} We have that $\Phi=\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta}$ and (1) $\vdash \Phi'$ and (2) $\keq{}{\ktyidx}$ and (3) $\vdash_\Phi \omega \sim \tcsig{\ktyidx}{\chi}$. 

By the IH on (1), we have (4) $\vdash \Phi'~\mathtt{sigsok}$.

By Lemma \ref{lemma:chi-ok} on (3) we have (5) $\vdash \chi$.

By (tcsig-ok) on (2) and (5) we have (6) $\vdash \tcsig{\ktyidx}{\chi}$.

By (tcc-sigsok-ext) on (4) and (6) we have our conclusion.
\end{proof}

\begin{lemma}[Tycons Have Valid Signatures]
\label{lemma:tycons-have-valid-signatures}
If (a) $\tcdef{\tc}{\psi}{\theta} \in \Phi$ and (b) $\vdash \Phi~\mathtt{sigsok}$ then $\vdash \psi$.
\end{lemma}
\begin{proof} By rule induction on (b) and (a).

\pfcase{(tcc-sigsok-emp)} Does not apply by (a).

\pfcase{(tcc-sigsok-ext)} We have two possible cases by (a):
\begin{quote}
\pfcase{$\Phi=\Phi', \tcdef{\tc}{\psi}{\theta}$} Then the conclusion is premise 2 of (b).

\pfcase{$\Phi=\Phi', \tcdef{\tc'}{\psi'}{\theta'}$ for $\tc\neq\tc'$ and (1) $\tcdef{\tc}{\psi}{\theta} \in \Phi'$} We have (2) $\tccsigok{\Phi'}$ by premise 1 of (b). Apply the IH to (1) and (2).
\end{quote}
\end{proof}

\begin{lemma}[Tycon Context Signature Validity Respects Extension]
If (a) $\tccsigok{\Phi}$ and (b) $\tccsigok{\Phi'}$ and (c) $\text{dom}(\Phi) \cap \text{dom}(\Phi') = \emptyset$ then $\tccsigok{\Phi\Phi'}$.
\end{lemma}
\begin{proof} Rule induction on (b).

\pfcase{(tcc-sigsok-emp)} Here, $\Phi'=\emptyset$ so $\Phi\Phi'=\Phi$ and the conclusion follows by (a).

\pfcase{(tcc-sigsok-ext)} Here, $\Phi'=\Phi'', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$ and (1) $\tccsigok{\Phi''}$ and (2) $\vdash \psi$. 

$\Phi\Phi''$ is well-formed because prefixing respects disjointness and (c).

Applying the IH on (a) and (1), we have that (3) $\tccsigok{\Phi\Phi''}$. 

By (tcc-sigsok-ext) on (3) and (2) we have our conclusion.
\end{proof}
\newpage


% \itm & ::= & \multicolumn{1}{l}{x ~|~ \ilam{\ity}{x}{\itm} ~|~ \iap{\itm}{\itm} ~|~ \ifix{\ity}{x}{\itm} ~|~ \iLam{\alpha}{\itm} ~|~ \iAp{\ity}{\itm}}\\
% & ~|~ & \multicolumn{1}{l}{\ifold{t}{\ity}{\itm} ~|~ \iunfold{\itm} ~|~ \itriv ~|~ \ipair{\itm}{\itm} ~|~ \ifst{\itm} ~|~ \isnd{\itm}}\\
% & ~|~ & \iinl{\ity}{\itm} ~|~ \iinr{\ity}{\itm} ~|~ \icase{\itm}{x}{\itm}{x}{\itm}\\


\section{Static Language}
\subsection{Syntax}

In the paper, we described the static language (SL) as consisting of a total functional core plus three additional kinds. That core is derived directly from \cite{pfpl}. Since the form of the judgements are not technically identical, we will re-state the rules below, but we will only sketch the corresponding cases in the proofs for concision (the core ignores the tycon context, argument bound $n$, etc.). 

The only change from the paper here is that we define the SL as having a built in list kind, rather than the more general mechanism for inductive kinds hinted at in the paper (lists are the only inductive kind we strictly need). The details of inductive kinds are in \cite{pfpl}, but again would distract from our main point and aren't needed to prove our theorems. Another approach is to simply allow recursive kinds, which would make it possible to define static terms that diverge. This does not break our fundamental guarantees, only decidability of typechecking (which we do not go into in detail here, as it is a more practical concern and requires non-trivial proofs of weak normalization that would also distract from our main point). 

As with the IL, each choice of SL forms a dialect of @$\lambda$. We anticipate that the SL (essentially, a domain-specific language for implementing typed translation semantics), and the IL would need to evolve much more slowly than the EL (e.g. the GHC compiler's IL has remained  stable for many years), so dialect formation should be needed far more rarely % mechanized proof of our properties for the SL should begin with an existing language mechanization. 

\subsection{Kinds}\label{sec:kinds}
\subsubsection{Kind Formation}

The kind formation rules are straightforward, shown in Figure \ref{fig:kind-formation}. Kind formation contexts $\kDelta$ are defined as finite mappings and thus are identified up to contraction and exchange, and we can assume the domains are disjoint. We assume substitution is defined in the usual way, so that standard substitution lemmas hold. 

\begin{assumption}[Kind Variable Substitution - Kinds]
\label{lemma:kind-variable-substitution-kinds}
If $\kDelta, \kalpha \vdash \kappa'$ and $\kDelta \vdash \kappa$ then $\kDelta \vdash [\kappa/\kalpha]\kappa'$.
\end{assumption}

\begin{lemma}[Weakening of Kind Formation]
\label{lemma:weakening-of-kind-formation}
If $\kDelta \vdash \kappa$ then $\kDelta\kDelta' \vdash \kappa$.
\end{lemma}
\begin{proof} Rule induction on assumption.

\pfcases{(kf-unit), (kf-ty), (kf-ity), (kf-itm)} These rules are defined for all $\kDelta$, so we re-apply the same rule.

\pfcases{(kf-arrow), (kf-prod), (kf-sum)} Apply the IH to premise 1 to get (1) $\kDelta\kDelta' \vdash \kappa$. Apply the IH to premise 2 to get (2) $\kDelta\kDelta' \vdash \kappa_2$. Re-apply the same rule to (1) and (2).

\pfcase{(kf-list)} Here, $\kappa=\klist{\kappa'}$. Apply the IH to premise 1 to get (1) $\kDelta\kDelta' \vdash \kappa'$. Apply (kf-list) to (1).

\pfcase{(kf-alpha)} By extension of finite mappings, if $\kalpha \in \kDelta$ then (1) $\kalpha \in \kDelta\kDelta'$. Apply (kf-alpha) to (1).

\pfcase{(kf-forall)} Here, $\kappa=\kforall{\kalpha}{\kappa'}$. Apply the IH to premise 1 to get (1) $(\kDelta, \kalpha)\kDelta' \vdash \kappa'$. By exchange, $(\kDelta, \kalpha)\kDelta'=\kDelta\kDelta', \kalpha$ and thus we can apply (kf-forall) to (1).

\end{proof}

\subsubsection{Equality Kinds}

Equality kinds are included to avoid complicating type equality (and guarantee \emph{argument independence} of values, see below). Arrow kinds, polymorphic kinds and term quotation kinds (because they are argument-dependent, see below) are not equality kinds (though an approach for quantifying over only equality kinds could be introduced to allow polymorphic equality kinds, as Standard ML provides \cite{Tofte:89:TheDefinitionOfStandardML}). The rules are given in Figure \ref{fig:equality-kinds}. %We do not define an equational theory for the language at all, so this is merely meant to head off the concerns of those who might wish to develop one in the future.


\begin{lemma}[Equality Kind Well-Formedness]
\label{lemma:equality-kind-well-formedness}
If $\keq{}{\kappa}$ then $\emptyset \vdash \kappa$. 
\end{lemma}
\begin{proof} Rule induction on the assumption.

\pfcase{(keq-list)} We have $\kappa=\klist{\kappa'}$ and (1) $\keq{}{\kappa'}$. Apply IH to (1) to get that (2) $\emptyset \vdash \kappa'$. Apply (kf-list) to (2).

\pfcase{(keq-unit)} We have $\kappa=\kunit$. Apply (kf-unit).

\pfcase{(keq-prod)} We have $\kappa=\kprod{\kappa_1}{\kappa_2}$ and (1) $\keq{}{\kappa_1}$ and $\keq{}{\kappa_2}$. Apply IH to (1) to get (3) $\emptyset \vdash \kappa_1$. Apply IH to (2) to get (4) $\emptyset \vdash \kappa_2$. Apply (kf-prod) to (3) and (4).

\pfcase{(keq-sum)} We have $\kappa=\ksum{\kappa_1}{\kappa_2}$ and (1) $\keq{}{\kappa_1}$ and $\keq{}{\kappa_2}$. Apply IH to (1) to get (3) $\emptyset \vdash \kappa_1$. Apply IH to (2) to get (4) $\emptyset \vdash \kappa_2$. Apply (kf-sum) to (3) and (4).

\pfcase{(keq-ty)} We have $\kappa=\kty$. Apply (kf-ty).

\pfcase{(keq-ity)} We have $\kappa=\kity$. Apply (kf-ity).
\end{proof}


\subsubsection{Kinding Contexts}
Kinding contexts map static variables, written in bold, to kinds. The kinding context formation judgement checks these kinds against a kind formation context. Because both are finite mappings, we implicitly identify them up to exchange and contraction and the domain can be assumed disjoint implicitly. Like the IL, static terms and kinds are implicitly identified up to $\alpha$-renaming of kind and static term variables, and we assume substitution is defined in the usual way.

\begin{lemma}[Kinding Context Lookup]
\label{lemma:kinding-context-lookup} If (a) $\kDelta \vdash \kGamma$ and (b) $\sx :: \kappa \in \kGamma$ then $\kDelta \vdash \kappa$.\end{lemma}
\begin{proof} Rule induction on (a).

\pfcase{(kctx-emp)} Does not apply by (b).

\pfcase{(kctx-ext)} We have that $\kGamma=\kGamma', \sx' :: \kappa'$ and (1) $\kDelta \vdash \kGamma'$ and (2) $\kDelta \vdash \kappa$. There are two cases by (b):
\begin{quote}
\pfcase{$\sx=\sx'$ and $\kappa=\kappa'$} We have our conclusion by (2). 

\pfcase{$\sx\neq\sx'$ and (3) $\sx :: \kappa \in \kGamma'$} Apply the IH to (1) and (3).
\end{quote}
\end{proof}

\begin{lemma}[Weakening of Kinding Context Formation]
\label{lemma:weakening-of-kinding-context-formation}
If $\kDelta \vdash \kGamma$ then $\kDelta\kDelta' \vdash \kGamma$.
\end{lemma}
\begin{proof} Rule induction on assumption

\pfcase{(kctx-emp)} Apply (kctx-emp).

\pfcase{(kctx-ext)} We have $\kGamma=\kGamma', \sx :: \kappa$. Applying the IH to premise 1, we have (1) $\kDelta\kDelta' \vdash \kGamma'$. By Lemma \ref{lemma:weakening-of-kind-formation} on premise 2, we have (2) $\kDelta\kDelta' \vdash \kappa$. Apply (kctx-ext) to (1) and (2).
\end{proof}

\subsection{Kinding}
The kinding rules are given in Figures \ref{fig:kinding-core}-\ref{fig:kinding-ana-syn}. Figure \ref{fig:kinding-core} describes kinding for the core and the rules are directly based on those in \cite{pfpl}, only tacking $\Phi$ and $n$ onto each rule, but never inspecting either one. For cases of our proofs where an existing proof script would be satisfactory by simply inserting these additional subscripts onto the kinding judgement, we will simply note this. Figure \ref{fig:kinding-types} describes kinding for types. Figures \ref{fig:kinding-qity-new} and \ref{fig:kinding-qity-shared} describes kinding for quoted translational internal types. Figures \ref{fig:kinding-qitm-new} and \ref{fig:kinding-qitm-shared} describe kinding for quoted translational internal terms. Only the rules for forms specific to quoted terms in Figures \ref{fig:kinding-qity-new} and \ref{fig:kinding-qitm-new} are interesting; the rules in Figures \ref{fig:kinding-qity-shared} and \ref{fig:kinding-qitm-shared} simply recurse generically over all sub-terms of shared form with $\iota$ or $\tau$. We will give only representative example cases for these shared forms in our proofs, rather than covering each form separately. Figure \ref{fig:kinding-ana-syn} describes kinding for the SL-EL interface.



\begin{lemma}[Kind Assignment]
If (a) $\kDelta \vdash \kGamma$ and (b) $\sofkX{\st}{\kappa}$ then $\kDelta \vdash \kappa$.
\end{lemma}
\begin{proof} By rule induction on (b). The cases for the rules in Figure \ref{fig:kinding-core} follow the usual script and are omitted.

% \pfcase{(k-var)} $\st=\sx$ and (1) $\sx :: \kappa \in \kGamma$. Apply Lemma \ref{lemma:kinding-context-lookup} on (a) and (1).

% \pfcase{(k-abs)} $\st=\slam{\kappa_1}{\sx}{\st'}$ and $\kappa=\kappa_1\rightarrow\kappa_2$ and (1) $\kDelta \vdash \kappa_1$ and (2) $\sofk{\kDelta}{\kGamma, \sx :: \kappa_1}{\Phi}{\st'}{\kappa_2}$. By IH on (a) and (2), we have (3) $\kDelta \vdash \kappa_2$. Apply (kf-arrow) to (1) and (3).

% \pfcase{(k-ap)} $\st=\st_1(\st_2)$ and (1) $\sofkX{\st_1}{\karrow{\kappa_1}{\kappa_2}}$. By IH on (a) and (1), we have (2) $\kDelta \vdash \karrow{\kappa_1}{\kappa_2}$. By inversion of (kf-arrow), $\kDelta \vdash \kappa_2$. 

% \pfcase{(k-kabs)} $\st=\sLam{\kalpha}{\st'}$ and $\kappa=\kforall{\kalpha}{\kappa'}$ and (1) $\sofk{\kDelta, \kalpha}{\kGamma}{\Phi}{\st'}{\kappa}$. By IH to (a) and (1), we have (2) $\kDelta, \kalpha \vdash \kappa$. Apply (kf-forall) on (2).\todo{add context formation steps}

% \pfcase{(k-kap)} $\st=\skap{\kappa'}{\st'}$ and (1) $\sofkX{\st'}{\kforall{\kalpha}{\kappa''}}$ and (2) $\kDelta \vdash \kappa'$ and $\kappa=[\kappa'/\kalpha]\kappa''$. By IH on (a) and (1), we have (2) $\kDelta \vdash \kforall{\kalpha}{\kappa''}$. By inversion of (kf-forall) on (2), we have (3) $\kDelta, \kalpha \vdash \kappa''$. Apply Lemma \ref{lemma:kind-variable-substitution-kinds} on (3) and (2).

% \pfcase{(k-nil)} $\st=\keyw{nil}[\kappa']$ and $\kappa=\klist{\kappa'}$ and (1) $\kDelta \vdash \kappa'$. Apply (kf-list) on (1).

% \pfcase{(k-cons)} $\st=\keyw{cons}(\st_1; \st_2)$ and $\kappa=\klist{\kappa'}$ and (1) $\sofkX{\st_2}{\klist{\kappa'}}$. Apply IH to (a) and (1).

% \pfcase{(k-listrec)} $\st=\keyw{listrec}(\st_1; \st_2; \sx, \sy. \st_3)$ and (1) $\sofkX{\st_2}{\kappa}$. Apply IH to (a) and (1).

% \pfcase{(k-triv)} $\kappa=\iunit$. Apply (kf-unit).

% \pfcase{(k-pair)} $\st=(\st_1, \st_2)$ and $\kappa=\kappa_1\times\kappa_2$ and (1) $\sofkX{\st_1}{\kappa_1}$ and (2) $\sofkX{\st_2}{\kappa_2}$. By IH on (a) and (1), we have (3) $\kDelta \vdash \kappa_1$. By IH on (a) and (2), we have (4) $\kDelta \vdash \kappa_2$. Apply (kf-prod) to (3) and (4).

% \pfcase{(k-fst)} $\st=\sfst{\st'}$ and (1) $\sofkX{\st'}{\kappa\times\kappa_2}$. By IH on (a) and (1), we have (2) $\kDelta \vdash \kappa \times \kappa_2$. Apply left-inversion of (kf-prod) on (2).

% \pfcase{(k-snd)} $\st=\ssnd{\st'}$ and (1) $\sofkX{\st'}{\kappa_1\times\kappa}$. By IH on (a) and (1), we have (2) $\kDelta \vdash \kappa_1 \times \kappa$. Apply right-inversion of (kf-prod) on (2).

% \pfcase{(k-inl)} $\st=\sinl{\kappa}{\st'}$ and (1) $\kDelta \vdash {\kappa}$. Apply (1).

% \pfcase{(k-inr)} $\st=\sinr{\kappa}{\st'}$ and (1) $\kDelta \vdash {\kappa}$. Apply (1).

% \pfcase{(k-raise)} $\st=\sraise{\kappa}$ and (1) $\kDelta \vdash \kappa$. Apply (1).

\pfcases{(k-ty-parr) and (k-ty-ext) and (k-ty-other)} In each case, $\kappa=\kty$. Apply (kf-ty).

\pfcases{(k-tycase-parr) and (k-tycase-ext)} In each case, $\st=\stycase{c}{\st'}{\sx}{\st_1}{\st_2}$ and (1) $\sofkX{\st_2}{\kappa}$. Apply IH to (a) and (1).

\pfcases{[all rules in Figures \ref{fig:kinding-qity-new} and \ref{fig:kinding-qity-shared}]} In each case, $\kappa=\kity$. Apply (kf-ity).

\pfcases{[all rules in Figure \ref{fig:kinding-qitm-new} and \ref{fig:kinding-qitm-shared}]} In each case, $\kappa=\kitm$. Apply (kf-itm).

\pfcase{(k-ana)} We have $\kappa=\kitm$. Apply (kf-itm).

\pfcase{(k-syn)} We have $\kappa=\kty\times\kitm$. Apply (kf-prod). Apply (kf-ty). Apply (kf-itm).
\end{proof}

%\subsubsection{Argument Bounds}
\begin{lemma}[Weakening of Argument Bounds]
\label{lemma:weakening-of-argument-bounds}
\small If (a) $\sofkn{\kDelta}{\kGamma}{\Phi}{n'}{\st}{\kappa}$ and (b) $n' < n$ then $\sofkn{\kDelta}{\kGamma}{\Phi}{n}{\st}{\kappa}$.
\end{lemma}
\begin{proof}Rule induction on (a).

All cases except the following proceed generically by applying the IH to all kinding premises then re-applying the same rule, because they are defined for all $n$ and all premises are checked under the same $n$.

\pfcase{(k-qitm-anatrans)} In this case, $\st=\sqitm{\anatrans{n''}{\st'}}$ and (1) $n'' < n'$ and (2) $\sofkn{\kDelta}{\kGamma}{\Phi}{n'}{\st'}{\kty}$. By transitivity on (1) and (b), we have (3) $n'' < n$. By the IH on (2) and (b), we have (4) $\sofkn{\kDelta}{\kGamma}{n}{\st'}{\kty}$. Apply (k-qitm-anatrans) to (3) and (4).

\pfcase{(k-qitm-syntrans)} In this case, $\st=\sqitm{\syntrans{n''}}$ and (1) $n'' < n'$. By transitivity on (1) and (b), we have (2) $n'' < n$. Apply (k-qitm-syntrans) to (2).

\pfcase{(k-ana)} In this case, $\st=\sana{n''}{\st'}$ and (1) $n'' < n'$ and (2) $\sofkn{\kDelta}{\kGamma}{\Phi}{n'}{\st'}{\kty}$. By transitivity on (1) and (b), we have (3) $n'' < n$. By the IH on (2) and (b), we have (4) $\sofkn{\kDelta}{\kGamma}{n}{\st'}{\kty}$. Apply (k-ana) to (3) and (4).

\pfcase{(k-syn)} In this case, $\st=\ssyn{n''}$ and (1) $n'' < n'$. By transitivity on (1) and (b), we have (2) $n'' < n$. Apply (k-syn) to (2).
\end{proof}




\subsection{Static Dynamics}



Figures \ref{fig:static-dynamics-SL-core} to \ref{fig:static-dynamics-SL-qitm-anasyn} give the dynamics of the SL as a structural operational semantics. Although the number of rules are large, the majority of them are uninteresting. Figure \ref{fig:static-dynamics-SL-core} simply gives the standard dynamics of the core language (i.e. these rules come from \cite{pfpl}, with an $\argEnv$ tacked on to each judgement but never inspected). We assume standard substitution lemmas:

\begin{assumption}[Static Type Variable Substitution]
\label{assumption:static-type-variable-substitution}
If (a) $\sofk{\kDelta, \kalpha}{\kGamma}{\Phi}{\st}{\kappa}$ and (b) ${\kDelta}\vdash {\kappa'}$ then $\sofk{\kDelta}{[\kappa'/\kalpha]\kGamma}{\Phi}{[\kappa'/\kalpha]\st}{[\kappa'/\kalpha]\kappa}$.
\end{assumption}

\begin{assumption}[Static Term Variable Substitution]
\label{assumption:static-term-variable-substitution}
If (a) $\sofk{\kDelta}{\kGamma, \sx :: \kappa'}{\Phi}{\st}{\kappa}$ and (b) $\sofk{\kDelta}{\kGamma}{\Phi}{\st'}{\kappa'}$ then $\sofk{\kDelta}{\kGamma}{\Phi}{[\st'/\sx]\st}{\kappa}$.
\end{assumption}

Figure \ref{fig:static-dynamics-SL-types} gives the dynamics of types and type case analysis.

\begin{definition}[Types]
\label{def:types}
We write $\istype{\st}{\Phi}$ iff $\sofkVX{\st}{\kty}$ and $\sval{\st}{\es;\Upsilon;\Phi}$.
\end{definition}


Figures \ref{fig:static-dynamics-SL-qity-shared}, \ref{fig:static-dynamics-SL-qitm-shared-1} and \ref{fig:static-dynamics-SL-qitm-shared-2} simply recurse through forms shared between the internal language and the translational internal language, to get to one of the forms that are unique to the translational internal language, defined in Figures \ref{fig:static-dynamics-SL-qity-new} and \ref{fig:static-dynamics-SL-qitm-new}. The following lemmas hold:

\begin{lemma}[Stepping Quoted Translational Internal Types]
\label{lemma:stepping-quoted-translational-internal-types}
If $\sstepA{\sqity{\qity}}{\st'}$ then $\st'=\sqity{\qity'}$.
\end{lemma}
\begin{proof}
By rule induction on the assumption. All rules that apply are given in Figure \ref{fig:static-dynamics-SL-qity-shared}, and in all cases the right hand side of the stepping judgement is of the form $\sqity{\qity'}$.
\end{proof}

\begin{lemma}[Stepping Quoted Translational Internal Terms]
\label{lemma:stepping-quoted-translational-internal-terms}
If $\sstepA{\sqitm{\qitm}}{\st'}$ then $\st'=\sqitm{\qitm'}$.
\end{lemma}
\begin{proof}
By rule induction on the assumption. All rules that apply are given in Figure \ref{fig:static-dynamics-SL-qitm-shared-1} and \ref{fig:static-dynamics-SL-qitm-shared-2}, and in all cases the right hand side of the stepping judgement is of the form $\sqitm{\qitm'}$. 
\end{proof}

Figure \ref{fig:static-dynamics-SL-qitm-anasyn} gives the dynamics of the SL-EL interface.

\subsubsection{Canonical Forms}
\begin{lemma}[Static Canonical Forms]
\label{lemma:static-canonical-forms}
Letting $\argEnv=\es;\Upsilon;\Phi$, if (a) $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\st}{\kappa}$ and (b) $\sval{\st}{\argEnv}$ then:
\begin{enumerate}
\item If $\kappa=\karrow{\kappa_1}{\kappa_2}$, then (i) $\st=\slam{\kappa_1}{\sx}{\st'}$ and (ii) $\sofk{\emptyset}{\emptyset, \sx :: \kappa_1}{\Phi}{\st'}{\kappa_2}$.
\item If $\kappa=\kforall{\kalpha}{\kappa}$, then (i) $\st=\sLam{\kalpha}{\st'}$ and (ii) $\sofk{\emptyset, \kalpha}{\emptyset}{\Phi}{\st'}{\kappa}$.
\item If $\kappa=\klist{\kappa}$, then either (i) $\st=\keyw{nil}[\kappa]$ or (ii) (I) $\st=\keyw{cons}(\stx{hd}; \stx{tl})$ and (II) $\sofkVX{\stx{hd}}{\kappa}$ and (III) $\svalA{\stx{hd}}$ and (IV) $\sofkVX{\stx{tl}}{\klist{\kappa}}$ and (V) $\svalA{\stx{tl}}$. 
\item If $\kappa=\kunit$, then $\st=()$.
\item If $\kappa=\kprod{\kappa_1}{\kappa_2}$ then (i) $\st=(\st_1, \st_2)$ and (ii) $\sofkVX{\st_1}{\kappa_1}$ and (iii) $\svalA{\st_1}$ and (iv) $\sofkVX{\st_2}{\kappa_2}$ and (v) $\svalA{\st_2}$. 
\item If $\kappa=\ksum{\kappa_1}{\kappa_2}$ then either (I) (i) $\st=\sinl{\kappa}{\st'}$ and (ii) $\sofkVX{\st'}{\kappa_1}$ and (iii) $\svalA{\st'}$, or (II) (i) $\st=\sinr{\kappa}{\st'}$ and (ii) $\sofkVX{\st'}{\kappa_2}$ and (iii) $\svalA{\st'}$.
\item If $\kappa = \kty$ then either 
    \begin{enumerate}[(I)]
    \item $\st = \sty{\rightharpoonup}{(\st_1, \st_2)}$ and (i) $\istype{\st_1}{\Phi}$ and (ii) $\istype{\st_2}{\Phi}$ and (iii) $\sofkVX{(\st_1, \st_2)}{\kty\times\kty}$ and (iv) $\svalA{(\st_1, \st_2)}$; or
    \item $\st = \sty{\tc}{\sttyidx}$ and (i) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\omega} \in \Phi$ and (ii) $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\st}{\ktyidx}$ and (iii) $\svalA{\sttyidx}$; or
    \item $\st = \sty{\keyw{other}[m; \kappa]}{(\stx{data}, \sqity{\qity})}$ and (i) $\emptyset \vdash \kappa$ and (ii) $\sofkVX{\stx{data}}{\kappa}$ and (iii) $\svalA{\stx{data}}$ and (iv) $\sofkVX{\sqity{\qity}}{\kity}$ and (v) $\svalA{\sqity{\qity}}$.
    \end{enumerate}
\item If $\kappa = \kity$ then $\st=\sqity{\qity}$ and either 
    \begin{enumerate}
    \item[(I)] $\qity = \srep{\st'}$ and $\istype{\st'}{\Phi}$; or
    \item[(II)] The outer form of $\qity$ is shared with $\tau$ and if $\qity'$ is a sub-term of $\qity$ then $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\sqity{\qity'}}{\kity}$ and $\svalNA{\sqity{\qity'}}$.
    \end{enumerate}
\item If $\kappa = \kitm$ then $\st=\sqitm{\qitm}$ and either 
    \begin{enumerate}
    \item[(I)] $\qitm=\anatrans{n'}{\st'}$ and (i) $n' < n$ and $\argEnv=\es;\Upsilon;\Phi'$ and (ii) $|\es| = n''$ and (iii) $n' < n''$ and (iv) $\istype{\st'}{\Phi}$; or
    \item[(II)] $\qitm=\syntrans{n}$ and (i) $n' < n$ and $\argEnv=\es;\Upsilon;\Phi'$ and (ii) $|\es| = n''$ and (iii) $n' < n''$.
    \item[(III)] The outer form of $\qitm$ is shared with $\itm$ and if $\qitm'$ is a sub-term of $\qitm$ then $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\sqitm{\qitm'}}{\kitm}$ and $\sval{\sqitm{\qitm'}}{\argEnv}$ and if $\qity$ is a sub-term of $\qitm$ then $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\sqity{\qity}}{\kity}$ and $\svalNA{\sqity{\qity}}$.
    \end{enumerate}
\end{enumerate}
\end{lemma}
\begin{proof}
The proofs for parts 1-6 follow the usual script and are omitted \cite{pfpl}.

\begin{enumerate}
\item[7.] Rule induction on (a) and (b). There is one form for which a kinding rule where $\kappa$ can be $\kty$ and a value rule are both defined, $\st=\sty{c}{\sttyidx}$. The only value rule that applies is (n-ty-val), so (1) $\svalA{\sttyidx}$.  Case analysis on $c$:

\pfcase{$c=\rightharpoonup$} The only kinding rule that applies is (k-ty-parr), so  (2) $\sofkVX{\sttyidx}{\kty\times\kty}$. 

By the IH on (2) and (1), we thus have that $\sttyidx=(\st_1, \st_2)$ where (3) $\sofkVX{\st_1}{\kty}$ and (4) $\svalA{\st_1}$ and (5) $\sofkVX{\st_2}{\kty}$ and (6) $\svalA{\st_2}$.

By the definition of types applied to (3) and (4), we have (7) $\istype{\st_1}{\Phi}$. 

By the definition of types applied to (5) and (6), we have (8) $\istype{\st_2}{\Phi}$. 

By (k-prod) on (3) and (5), we have (9) $\sofkVX{(\st_1, \st_2)}{\kty\times\kty}$.

By (n-pair-val) on (4) and (6), we have (10) $\svalA{(\st_1, \st_2)}$. 

Thus, we can complete our proof by (I) with (7), (8), (9) and (10).

\pfcase{$c=\tc$} The only kinding rule that applies is (k-ty-ext), so (2) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\omega} \in \Phi$ and (3) $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\st}{\ktyidx}$. Thus, we can complete our proof by (II) with (2), (3) and (1).

\pfcase{$c=\keyw{other}[m;\kappa]$} The only kinding rule that applies is (k-ty-other), so  (2) $\emptyset \vdash \kappa$ and (3) $\sofkVX{\sttyidx}{\kappa\times\kity}$. By the IH on (3), (b), (c) and (1), we thus have that $\sttyidx=(\stx{data}, \stx{trans})$ where (4) $\sofkVX{\stx{data}}{\kappa}$ and (5) $\svalA{\stx{data}}$ and (6) $\sofkVX{\stx{trans}}{\kity}$ and (7) $\svalA{\stx{trans}}$.

By the IH on (6) and (7), we have that $\stx{trans}=\sqity{\qity}$.

Thus, we can complete our proof by (III) with (2), (4), (5), (6) and (7).

\item[8.] Rule induction on (a) and (b). All forms that can be given kind $\kity$ and define a value rule are of the form $\sqity{\qity}$. Case analysis on the form of $\qity$:

\pfcase{$\qity=\qtuq{\st}$} There is no value rule for this form.

\pfcase{$\qity=\srep{\st'}$} The only kinding rule for this form is (k-qity-trans), so  (1) $\sofkVX{\st'}{\kty}$.

The only value rule for this form is (n-q-tytrans-val), so (2) $\svalA{\st'}$. 

By the definition of types on 1 and 2, we have (3) $\istype{\st'}{\Phi}$. We can thus complete our proof by (I) on (3).

\pfcase{[$\qity$ has form shared with $\tau$]} All kinding rules for these forms are given in Figure \ref{fig:kinding-qity-shared}. For each form, there is one rule. That rule has the property that (1) if $\qity'$ is a direct sub-term of $\qity$, then there is a premise of the form $\sofkVX{\sqity{\qity'}}{\kity}$.

All rules in the static dynamics for these forms are given in Figure \ref{fig:static-dynamics-SL-qity-shared}. For each form, there is one value rule. This rule has the property that (2) if $\qity'$ is a sub-term of $\qity$, the rule has a premise of the form (2) $\svalA{\sqity{\qity'}}$.

We can thus complete our proof by (II) on (1) and (2) in each case.

\item[9.] Rule induction on (a) and (b). All forms that can be given kind $\kitm$ and define a value rule are of the form $\sqitm{\qitm}$. Case analysis on the form of $\qitm$:

\pfcase{$\qitm=\quq{\st'}$} There is no value rule for this form.

\pfcase{$\qitm=\anatrans{n'}{\st'}$} The only kinding rule for this form is (k-qitm-anatrans), so (1) $n' < n$ and (2) $\sofkVX{\st'}{\kty}$. 

The only value rule for this form is (n-q-anatrans-val), so $\argEnv = \es;\Upsilon;\Phi'$ and (3) $\svalA{\st'}$ and (4) $|\es|=n''$ and (5) $n' < n''$.

By the definition of types on (2) and (3), we have (6) $\istype{\st'}{\Phi}$. 

We can thus complete our proof by (I) on (1), (4), (5) and (6).

\pfcase{$\qitm=\syntrans{n'}$} The only kinding rule for this form is (k-qitm-syntrans) so (1) $n' < n$.

The only value rule for this form is (n-q-syntrans-val) so  $\argEnv=\es;\Upsilon;\Phi'$ and (2) $|\es|=n''$ and (3) $n' < n''$.

We can thus complete our proof by (II) on (1), (2) and (3).

\pfcase{[$\qitm$ has form shared with $\itm$]} All kinding rules for these forms are given in Figure \ref{fig:kinding-qitm-shared}. For each form, there is one rule. That rule has the property that (1) if $\qitm'$ is a direct sub-term of $\qitm$, then there is a premise of the form $\sofkVX{\sqitm{\qitm'}}{\kitm}$, and (2) if $\qity'$ is a direct sub-term of $\qitm$, then there is a premise of the form $\sofkVX{\sqity{\qity'}}{\kity}$.

All rules in the static dynamics for these forms are given in Figure \ref{fig:static-dynamics-SL-qitm-shared-1} and \ref{fig:static-dynamics-SL-qitm-shared-2}. For each form, there is one value rule. This rule has the property that (3) if $\qitm'$ is a sub-term of $\qitm$, then there is a premise of the form $\svalA{\sqitm{\qitm'}}$, and (4) if $\qity'$ is a sub-term of $\qitm$, then there is a premise of the form $\svalA{\sqity{\qity'}}$.

We can thus complete our proof by (III) on (1), (2), (3) and (4) in each case.
\end{enumerate}
\end{proof}

%\subsubsection{Argument Independence}
As suggested by Lemma \ref{lemma:static-canonical-forms}, only static values of kind $\kitm$ are argument-dependent (i.e. are indexed by a natural number). It is helpful to have a lemma that says that values of other kinds, in particular equality kinds, are argument independent.

\begin{lemma}[Values of Equality Kind are Argument Independent]
\label{lemma:values-of-equality-kind-are-argument-independent}
If (a) $\sofkVX{\st}{\kappa}$ and (b) $\svalA{\st}$ and (c) $\keq{}{\kappa}$ then (i) $\sofkz{\emptyset}{\emptyset}{\Phi}{\st}{\kappa}$ and (ii) $\sval{\st}{\argEnv'}$.
\end{lemma}
\begin{proof}
By rule induction on (c).

\pfcase{(keq-list)} $\kappa=\klist{\kappa'}$ and $\keq{}{\kappa'}$. Rule induction on (a) and (b). There are only twos forms that can have kind $\klist{\kappa'}$ and define value rules, $\st=\keyw{nil}[\kappa']$ and $\st=\keyw{cons}(\st_1; \st_2)$. The only kinding rules that apply are (k-nil) and (k-cons), respectively. The only value rules that apply are (n-nil-val) and (n-cons-val), respectively. All of these rules are defined for all $n$ and all $\argEnv$, and only kind check against equality kinds $\kappa'$ and $\klist{\kappa'}$ in their premises, so we can simply re-apply them inductively to conclude (i) and (ii) in each case.

\pfcase{(keq-unit)} $\kappa=\kunit$. Rule induction on (a) and (b). There is only one form that can have kind $\kunit$ and defines a value rule, $\st=()$. The only kinding rule that applies is (k-unit) and the only value rule that applies is (n-triv-val). Both are defined for all $n$ and all $\argEnv$, and have no premises, so we can simply re-apply them to conclude (i) and (ii).

\pfcase{(keq-prod)} $\kappa=\kappa_1\times\kappa_2$ and $\keq{}{\kappa_1}$ and $\keq{}{\kappa_2}$. Rule induction on (a) and (b). There is only one form that can have kind $\kappa_1\times\kappa_2$ and defines a value rule, $\st=(\st_1, \st_2)$. The only kinding rule that applies is (k-pair). The only value rule that applies is (n-pair-val). Both are defined for all $n$ and all $\argEnv$, and only kind check against equality kinds $\kappa_1$ or $\kappa_2$ in the premises, so we can simply re-apply them inductively to conclude (i) and (ii).

\pfcase{(keq-sum)} $\kappa=\kappa_1+\kappa_2$. Rule induction on (a) and (b). There are two forms that can have kind $\kappa_1 + \kappa_2$ and define value rules, $\st=\sinl{\kappa}{\st_1}$ and $\st=\sinr{\kappa}{\st_2}$. The only kinding rules that apply are (k-inl) and (k-inr), respectively. The only value rules that apply are (n-inl-val) and (n-inr-val), respectively. All of these rules are defined for all $n$ and all $\argEnv$, and only kind check against equality kinds $\kappa_1$ or $\kappa_2$ in the premises, so we can simply re-apply them inductively to conclude (i) and (ii) in each case.

\pfcase{(keq-ty)} $\kappa=\kty$. Rule induction on (a) and (b). There is one form that can have kind $\kty$ and defines value rules, $\st=\sty{c}{\sttyidx}$. The only value rule that applies is (n-ty-val), so we have (1) $\svalA{\sttyidx}$. Three kinding rules might apply:
\begin{quote}
\pfcase{(k-ty-parr)} In this case, $c=\rightharpoonup$ and (2) $\sofkVX{\sttyidx}{\kty\times\kty}$. By (keq-prod) and (keq-ty) and (keq-ty), we have that (3) $\keq{}{\kty\times\kty}$. Applying the IH to (2), (1) and (3), we have that (4) $\sofkz{\emptyset}{\emptyset}{\Phi}{\sttyidx}{\kty\times\kty}$ and (6) $\sval{\sttyidx}{\argEnv'}$. By (k-ty-parr) on (5), we have (i). By (n-ty-val) on (6), we have (ii).

\pfcase{(k-ty-ext)} In this case, $c=\tc$ and (2) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in\Phi$ and (3) $\sofkVX{\sttyidx}{\ktyidx}$. By Lemma \ref{lemma:tycons-have-valid-signatures} on (2), we have that (4) $\vdash \tcsig{\ktyidx}{\chi}$. By Lemma \ref{lemma:sigs-define-eq-type-index-kinds} on (4), we have that (5) $\keq{}{\ktyidx}$. By the IH on (3), (1) and (5) we have (6) $\sofkz{\emptyset}{\emptyset}{\Phi}{\sttyidx}{\ktyidx}$ and (7) $\sval{\sttyidx}{\argEnv'}$. Applying (k-ty-ext) to (2) and (6), we have (i). Applying (n-ty-val) to (1), we have (ii). 

\pfcase{(k-ty-other)} In this case, $c=\keyw{other}[m;\kappa']$ and (2) $\keq{}{\kappa'}$ and (3) $\sofkVX{\sttyidx}{\kappa'\times\kity}$. By (keq-ity), we have (4) $\keq{}{\kity}$. By (keq-prod) on (2) and (4), we have (5) $\keq{}{\kappa'\times\kity}$. By the IH on (3), (1) and (5), we have (6) $\sofkz{\emptyset}{\emptyset}{\sttyidx}{\kappa'\times\kity}$ and (7) $\sval{\sttyidx}{\argEnv'}$. By (k-ty-other) on (2) and (6), we have (i). By (n-ty-val) on (7), we have (ii). 
\end{quote}

\pfcase{(keq-ity)} $\kappa=\kity$. Rule induction on (a) and (b). The only forms that can have kind $\kity$ and define value rules are of the form $\sqity{\qity}$. The kinding rules for these are defined in Figures \ref{fig:kinding-qity-new} and \ref{fig:kinding-qity-shared}. 
\begin{quote}
\pfcase{[k-qity-trans]} In this case, $\qity=\srep{\st'}$ and (1) $\sofkVX{\st'}{\kty}$. The only value rule that applies is (n-q-tytrans-val), so (2) $\svalA{\st'}$. Note that (3) $\keq{}{\kty}$ by (keq-ty). By the IH on (1), (2) and (3), we have (4) $\sofkz{\emptyset}{\emptyset}{\Phi}{\st'}{\kty}$ and (5) $\sval{\st'}{\argEnv'}$. By (k-qity-trans) on (4), we have (i). By (n-q-tytrans-val) on (5), we have (ii).

\pfcase{[all rules in Figure \ref{fig:kinding-qity-shared}]} Observe that all rules where $\qity$ is of shared form are defined for all $n$, and that for all sub-terms $\qity'$ of $\qity$, there is a premise of the form $\sofkVX{\sqity{\qity'}}{\kity}$, and there are no other premises.

The value rules for these are defined in Figures \ref{fig:static-dynamics-SL-qity-shared}. Observe that all rules are defined for all $\argEnv$ and for all sub-terms $\qity'$ of $\qity$, there is a premise of the form $\svalA{\sqity{\qity'}}$, and there are no other premises.

Thus, in every case, we can apply the IH to each sub-term of $\qity$, then reapply the same rules to derive (i) and (ii), respectively.
\end{quote}
\end{proof}

\begin{lemma}[Types are Argument Independent]
\label{lemma:types-are-argument-independent}
$\istype{\st}{\Phi}$ iff (a) $\sofkz{\emptyset}{\emptyset}{\Phi}{\st}{\kty}$ and (b) $\sval{\st}{\cdot;\emptyset;\Phi}$.
\end{lemma}
\begin{proof}
In the forward direction, by the definition of $\istype{\st}{\Phi}$ we have (1) $\sofkVX{\st}{\kty}$ and (2) $\sval{\st}{\es;\Upsilon;\Phi}$. By (keq-ty), we have (3) $\keq{}{\kty}$. By Lemma \ref{lemma:values-of-equality-kind-are-argument-independent} on 1, 2 and 3, we have (a) and (b).

In the backwards direction, apply the definition of $\istype{\st}{\Phi}$ to (a) and (b).
\end{proof}

\subsection{Kind Safety}
Kind safety ensures that normalization of well-kinded static terms cannot go wrong. We can take a standard progress and preservation based approach. 

\begin{theorem}[Static Progress]\label{thm:static-progress}
Letting $\argEnv=\es;\Upsilon;\Phi$, if (a) $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\st}{\kappa}$ and (b) $|\es|=n$  then (I) $\sstep{\st}{\argEnv}{\st'}$ or (II) $\sval{\st}{\argEnv}$ or (III) $\serr{\st}{\argEnv}$.
\end{theorem}
\begin{proof} Rule induction on (a).

\pfcases{[All rules in Figure \ref{fig:kinding-core}]} The proof of progress for core language constructs follows the standard script \cite{pfpl} and is omitted.

\pfcase{(k-ty-parr)} In this case, we have $\st=\sty{\rightharpoonup}{\sttyidx}$ and $\kappa=\kty$ and (1) $\sofkVX{\sttyidx}{\kty\times\kty}$. Applying the IH to (1) and (b), we have three cases:
\begin{quote}
    \pfcase{(2) $\sstepA{\sttyidx}{\sttyidx'}$} Applying (n-ty-step) to (2), we have (3) $\sstepA{\sty{\rightharpoonup}{\sttyidx}}{\sty{\rightharpoonup}{\sttyidx'}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\sttyidx}$} Applying (n-ty-val) to (2), we have (3) $\svalA{\sty{\rightharpoonup}{\sttyidx}}$. We can conclude by (II) on (3).

    \pfcase{(2) $\serrA{\sttyidx}$} Applying (n-ty-err-prop) to (2), we have (3) $\serrA{\sty{\rightharpoonup}{\sttyidx}}$. We can conclude by (III) on (3).
\end{quote}

\pfcase{(k-ty-ext)} In this case, we have $\st=\sty{\tc}{\sttyidx}$ and $\kappa=\kty$  and (1) $\sofkVX{\sttyidx}{\ktyidx}$. Applying the IH to (1) and (b), we have three cases:
\begin{quote}
    \pfcase{(2) $\sstepA{\sttyidx}{\sttyidx'}$} Applying (n-ty-step) to (2), we have (3) $\sstepA{\sty{\tc}{\sttyidx}}{\sty{\rightharpoonup}{\sttyidx'}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\sttyidx}$} Applying (n-ty-val) to (2), we have (3) $\svalA{\sty{\tc}{\sttyidx}}$. We can conclude by (II) on (3).

    \pfcase{(2) $\serrA{\sttyidx}$} Applying (n-ty-err-prop) to (2), we have (3) $\serrA{\sty{\tc}{\sttyidx}}$. We can conclude by (III) on (3).
\end{quote}

\pfcase{(k-ty-other)} In this case, we have $\st=\sty{\otherc{m}{\kappa'}}{\sttyidx}$ and $\kappa=\kty$ and (1) $\sofkVX{\sttyidx}{\kappa'\times\kity}$. Applying the IH to (1) and (b), we have three cases:
\begin{quote}
    \pfcase{(2) $\sstepA{\sttyidx}{\sttyidx'}$} Applying (n-ty-step) to (2), we have (3) $\sstepA{\sty{\tc}{\sttyidx}}{\sty{\otherc{m}{\kappa'}}{\sttyidx'}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\sttyidx}$} Applying (n-ty-val) to (2), we have (3) $\svalA{\sty{\otherc{m}{\kappa'}}{\sttyidx}}$. We can conclude by (II) on (3).

    \pfcase{(2) $\serrA{\sttyidx}$} Applying (n-ty-err-prop) to (2), we have (3) $\serrA{\sty{\otherc{m}{\kappa'}}{\sttyidx}}$. We can conclude by (III) on (3).
\end{quote}

\pfcase{(k-tycase-parr)} In this case, we have $\st=\stycase{\rightharpoonup}{\st'}{\sx}{\st_1}{\st_2}$ and (1) $\sofkVX{\st'}{\kty}$. Applying the IH to (1) and (b), we have three cases:
\begin{quote}
    \pfcase{(2) $\sstepA{\st'}{\st''}$} Applying (n-tycase-step) to (2), we have (3) $$\sstepA{\stycase{{\rightharpoonup}}{\st'}{\sx}{\st_1}{\st_2}}{\stycase{\rightharpoonup}{\st''}{\sx}{\st_1}{\st_2}}$$ We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\st'}$} By Lemma \ref{lemma:static-canonical-forms}.7 on (1) and (2), we have three cases: 
    \begin{quote}
        \pfcase{$\st'=\sty{\rightharpoonup}{(\st_1', \st_2')}$} Applying (n-tycase-elim-1) to (2), we have (3) $$\sstepA{\stycase{\rightharpoonup}{\sty{\rightharpoonup}{(\st_1', \st_2')}}{\sx}{\st_1}{\st_2}}{[(\st_1', \st_2')/\sx]\st_1}$$ We can conclude by (I) on (3).

        \pfcase{$\st'=\sty{\tc}{\sttyidx}$} We have (3) ${\rightharpoonup}\neq\tc$. Applying (n-tycase-elim-2) to (2) and (3), we have (4) $$\sstepA{\stycase{\rightharpoonup}{\sty{\tc}{\sttyidx}}{\sx}{\st_1}{\st_2}}{\st_2}$$ We can conclude by (I) on (4).

        \pfcase{$\st'=\sty{\otherc{m}{\kappa'}}{(\stx{data}, \sqity{\qity})}$} We have  (3) ${\rightharpoonup}\neq\otherc{m}{\kappa'}$. Applying (n-tycase-elim-2) to (2) and (3), we have (4) $$\sstepA{\stycase{\rightharpoonup}{\sty{\otherc{m}{\kappa'}}{(\stx{data}, \sqity{\qity})}}{\sx}{\st_1}{\st_2}}{\st_2}$$ We can conclude by (I) on (4).
    \end{quote}

    \pfcase{(2) $\serrA{\st'}$} Applying (n-tycase-err-prop) to (2), we have (3) $$\serrA{\stycase{\rightharpoonup}{\st'}{\sx}{\st_1}{\st_2}}$$ We can conclude by (III) on (3). 
\end{quote}

\pfcase{(k-tycase-ext)} In this case, we have $\st=\stycase{\tc}{\st'}{\sx}{\st_1}{\st_2}$ and (1) $\sofkVX{\st'}{\kty}$. Applying the IH to (1) and (b), we have  three cases:
\begin{quote}
    \pfcase{(2) $\sstepA{\st'}{\st''}$} Applying (n-tycase-step) to (2), we have (3) $$\sstepA{\stycase{{\tc}}{\st'}{\sx}{\st_1}{\st_2}}{\stycase{\tc}{\st''}{\sx}{\st_1}{\st_2}}$$ We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\st'}$} By Lemma \ref{lemma:static-canonical-forms}.7 on (1) and (2), we have three cases: 
    \begin{quote}
        \pfcase{$\st'=\sty{\rightharpoonup}{(\st_1', \st_2')}$} We have (3) $\tc\neq{\rightharpoonup}$. Applying (n-tycase-elim-2) to (2) and (3), we have (4) $$\sstepA{\stycase{\tc}{\sty{\rightharpoonup}{(\st_1', \st_2')}}{\sx}{\st_1}{\st_2}}{\st_2}$$ We can conclude by (I) on (4).

        \pfcase{$\st'=\sty{\tc'}{\sttyidx}$ and (3) $\svalA{\sttyidx}$} There are two cases:
        \begin{quote}
            \pfcase{$\tc=\tc'$} Applying (n-tycase-elim-1) to (3), we have (4) $$\sstepA{\stycase{\tc}{\sty{\tc}{\sttyidx}}{\sx}{\st_1}{\st_2}}{[\sttyidx/\sx]\st_1}$$ We can conclude by (I) on (4).

            \pfcase{(4) $\tc\neq\tc'$} Applying (n-tycase-elim-2) to (3) and (4), we have (5) $$\sstepA{\stycase{\tc}{\sty{\tc'}{\sttyidx}}{\sx}{\st_1}{\st_2}}{\st_2}$$ We can conclude by (I) on (5).
        \end{quote}

        \pfcase{$\st'=\sty{\otherc{m}{\kappa'}}{(\stx{data}, \sqity{\qity})}$} We have  (3) $\tc\neq\otherc{m}{\kappa'}$. Applying (n-tycase-elim-2) to (2) and (3), we have (4) $$\sstepA{\stycase{\rightharpoonup}{\sty{\otherc{m}{\kappa'}}{(\stx{data}, \sqity{\qity})}}{\sx}{\st_1}{\st_2}}{\st_2}$$ We can conclude by (I) on (4).
    \end{quote}

    \pfcase{(2) $\serrA{\st'}$} Applying (n-tycase-err-prop) to (2), we have (3) $$\serrA{\stycase{\rightharpoonup}{\st'}{\sx}{\st_1}{\st_2}}$$ We can conclude by (III) on (3). 
\end{quote}

\pfcase{(k-qity-unquote)} We have $\st=\sqity{\qtuq{\st'}}$ and (1) $\sofkVX{\st'}{\kity}$. Applying the IH to (1) and (b), we have three cases:

\begin{quote}
    \pfcase{(2) $\sstepA{\st'}{\st''}$} Applying (n-q-t-unquote-step) to (2), we have (3) $\sstepA{\sqity{\qtuq{\st'}}}{\sqity{\qtuq{\st''}}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\st'}$} Applying Lemma \ref{lemma:static-canonical-forms}.8 to (1) and (2), we have that (3) $\st'=\sqity{\qity}$. Applying (n-q-t-unquote-elim) to (3), we have (4) $\sstepA{\sqity{\qtuq{\sqity{\qity}}}}{\sqity{\qity}}$. We can conclude by (I) on (4).

    \pfcase{(2) $\serrA{\st'}$} Applying (n-q-t-unquote-err-prop) on (2), we have (3) $\serrA{\sqity{\qtuq{\st'}}}$. We can conclude by (III) on (3).
\end{quote}

\pfcase{(k-qity-trans)} We have $\st=\sqity{\srep{\st'}}$ and (1) $\sofkVX{\st'}{\kty}$. Applying the IH to (1) and (b), we have three cases:

\begin{quote}
    \pfcase{(2) $\sstepA{\st'}{\st''}$} Applying (n-q-tytrans-step) to (2), we have (3) $\sstepA{\sqity{\srep{\st'}}}{\sqity{\srep{\st''}}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\st'}$} Applying (n-q-tytrans-val) to (2), we have (3) $\svalA{\sqity{\srep{\st'}}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\serrA{\st'}$} Applying (n-q-tytrans-err-prop) on (2), we have (3) $\serrA{\sqity{\qtuq{\st'}}}$. We can conclude by (III) on (3).
\end{quote}

\pfcases{[All rules in Figure \ref{fig:kinding-qity-shared}]} We give an example base case and inductive cases with 0, 1 and 2 sub-terms. All rules with the same number of sub-terms follow the corresponding script, replacing only the forms and rule names:

\begin{quote}
    \pfcase{(k-qity-alpha)} We have that $\st=\sqity{\alpha}$. Applying (n-q-alpha-val), we have (1) $\svalA{\sqity{\alpha}}$. We can conclude by (II) on (1).

    \pfcase{(k-qity-forall)} We have that $\st=\sqity{\iforall{\alpha}{\qity}}$ and (1) $\sofkVX{\sqity{\qity}}{\kity}$. Applying the IH to (1) and (b), we have three cases:

    \begin{quote}
        \pfcase{(2) $\sstepA{\sqity{\qity}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (2), we have $\st'=\sqity{\qity'}$. Applying (n-q-forall-step) to (2), we have (3) $\sstepA{\sqity{\iforall{\alpha}{\qity}}}{\sqity{\iforall{\alpha}{\qity'}}}$. We can conclude by (I) on (3).

        \pfcase{(2) $\svalA{\sqity{\qity}}$} Applying (n-q-forall-val) to (2), we have (3) $\svalA{\sqity{\iforall{\alpha}{\qity}}}$. We can conclude by (II) on (3).

        \pfcase{(2) $\serrA{\sqity{\qity}}$} Applying (n-q-forall-err-prop) to (2), we have (3) $\serrA{\sqity{\iforall{\alpha}{\qity}}}$. We can conclude by (III) on (3).
    \end{quote}

    \pfcase{(k-qity-parr)} We have that $\st=\sqity{\iparr{\qity_1}{\qity_2}}$ and (1) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (2) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1), there are three possibilities:

    \begin{quote}
        \pfcase{(3) $\sstepA{\sqity{\qity_1}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity_1'}$. Applying (n-q-parr-step-1) to (3), we have (4) $\sstepA{\sqity{\iparr{\qity_1}{\qity_2}}}{\sqity{\iparr{\qity_1'}{\qity_2}}}$. We can conclude by (I) on (4).

        \pfcase{(3) $\svalA{\sqity{\qity_1}}$} Applying the IH to (2), there are three possibilities:

        \begin{quote}
            \pfcase{(4) $\sstepA{\sqity{\qity_2}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (4), $\st_2'=\sqity{\qity_2'}$. By (n-q-parr-step-2) on (3) and (4), we have (5) $\sstepA{\sqity{\iparr{\qity_1}{\qity_2}}}{\sqity{\iparr{\qity_1}{\qity_2'}}}$. We can conclude by (I) on (5).

            \pfcase{(4) $\svalA{\sqity{\qity_2}}$} Applying (n-q-parr-val) to (3) and (4), we have (5) $\svalA{\sqity{\iparr{\qity_1}{\qity_2}}}$. We can conclude by (II) on (5).

            \pfcase{(4) $\serrA{\sqity{\qity_2}}$} Applying (n-q-parr-err-prop-2) to (4), we have (5) $\serrA{\sqity{\iparr{\qity_1}{\qity_2}}}$. We can conclude by (III) on (5).
        \end{quote}

        \pfcase{(3) $\serrA{\sqity{\qity_1}}$} Applying (n-q-parr-err-prop-1) to (3), we have (4) $\serrA{\sqity{\iparr{\qity_1}{\qity_2}}}$. We can conclude by (III) on (4).
    \end{quote}
\end{quote}

% \pfcase{(k-qity-t)} We have that $\st=\sqity{t}$. Applying (n-q-t-val), we have (1) $\svalA{\sqity{t}}$. We can conclude by (II) on (1).

% \pfcase{(k-qity-mu)} We have that $\st=\sqity{\imu{t}{\qity}}$ and (1) $\sofkVX{\sqity{\qity}}{\kity}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(2) $\sstepA{\sqity{\qity}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (2), we have $\st'=\sqity{\qity'}$. Applying (n-q-mu-step) to (2), we have (3) $\sstepA{\sqity{\imu{t}{\qity}}}{\sqity{\imu{t}{\qity'}}}$. We can conclude by (I) on (3).

%     \pfcase{(2) $\svalA{\sqity{\qity}}$} Applying (n-q-mu-val) to (2), we have (3) $\svalA{\sqity{\imu{t}{\qity}}}$. We can conclude by (II) on (3).

%     \pfcase{(2) $\serrA{\sqity{\qity}}$} Applying (n-q-mu-err-prop) to (2), we have (3) $\serrA{\sqity{\imu{t}{\qity}}}$. We can conclude by (III) on (3).
% \end{quote}

% \pfcase{(k-qity-unit)} We have that $\st=\sqity{()}$. Applying (n-q-unit-val), we have (1) $\svalA{\sqity{())}}$. We can conclude by (II) on (1).

% \pfcase{(k-qity-prod)} We have that $\st=\sqity{\iprod{\qity_1}{\qity_2}}$ and (1) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (2) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1), there are three possibilities:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqity{\qity_1}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity_1'}$. Applying (n-q-prod-step-1) to (3), we have (4) $\sstepA{\sqity{\iprod{\qity_1}{\qity_2}}}{\sqity{\iprod{\qity_1'}{\qity_2}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqity{\qity_1}}$} Applying the IH to (2), there are three possibilities:

%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqity{\qity_2}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (4), $\st_2'=\sqity{\qity_2'}$. By (n-q-prod-step-2) on (3) and (4), we have (5) $\sstepA{\sqity{\iprod{\qity_1}{\qity_2}}}{\sqity{\iprod{\qity_1}{\qity_2'}}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\svalA{\sqity{\qity_2}}$} Applying (n-q-prod-val) to (3) and (4), we have (5) $\svalA{\sqity{\iprod{\qity_1}{\qity_2}}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\serrA{\sqity{\qity_2}}$} Applying (n-q-prod-err-prop-2) to (4), we have (5) $\serrA{\sqity{\iprod{\qity_1}{\qity_2}}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqity{\qity_1}}$} Applying (n-q-prod-err-prop-1) to (3), we have (4) $\serrA{\sqity{\iprod{\qity_1}{\qity_2}}}$. We can conclude by (III) on (4).
% \end{quote}

% \pfcase{(k-qity-sum)} We have that $\st=\sqity{\isum{\qity_1}{\qity_2}}$ and (1) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (2) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1), there are three possibilities:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqity{\qity_1}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity_1'}$. Applying (n-q-sum-step-1) to (3), we have (4) $\sstepA{\sqity{\isum{\qity_1}{\qity_2}}}{\sqity{\isum{\qity_1'}{\qity_2}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqity{\qity_1}}$} Applying the IH to (2), there are three possibilities:

%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqity{\qity_2}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (4), $\st_2'=\sqity{\qity_2'}$. By (n-q-sum-step-2) on (3) and (4), we have (5) $\sstepA{\sqity{\isum{\qity_1}{\qity_2}}}{\sqity{\isum{\qity_1}{\qity_2'}}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\svalA{\sqity{\qity_2}}$} Applying (n-q-sum-val) to (3) and (4), we have (5) $\svalA{\sqity{\isum{\qity_1}{\qity_2}}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\serrA{\sqity{\qity_2}}$} Applying (n-q-sum-err-prop-2) to (4), we have (5) $\serrA{\sqity{\isum{\qity_1}{\qity_2}}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqity{\qity_1}}$} Applying (n-q-sum-err-prop-1) to (3), we have (4) $\serrA{\sqity{\isum{\qity_1}{\qity_2}}}$. We can conclude by (III) on (4).
% \end{quote}

\pfcase{(k-qitm-unquote)} We have $\st=\sqitm{\quq{\st'}}$ and (1) $\sofkVX{\st'}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

\begin{quote}
    \pfcase{(2) $\sstepA{\st'}{\st''}$} Applying (n-q-unquote-step) to (2), we have (3) $\sstepA{\sqitm{\quq{\st'}}}{\sqitm{\quq{\st''}}}$. We can conclude by (I) on (3).

    \pfcase{(2) $\svalA{\st'}$} Applying Lemma \ref{lemma:static-canonical-forms}.9 to (1) and (2), we have that (3) $\st'=\sqitm{\qitm}$. Applying (n-q-unquote-elim) to (3), we have (4) $\sstepA{\sqitm{\quq{\sqitm{\qitm}}}}{\sqitm{\qitm}}$. We can conclude by (I) on (4).

    \pfcase{(2) $\serrA{\st'}$} Applying (n-q-unquote-err-prop) on (2), we have (3) $\serrA{\sqitm{\quq{\st'}}}$. We can conclude by (III) on (3).
\end{quote}

\pfcase{(k-qitm-anatrans)} We have $\st=\sqitm{\anatrans{n'}{\st'}}$ and (1) $n' < n$ and (2) $\sofkVX{\st'}{\kty}$. Applying the IH to (2), we have three cases:

\begin{quote}
    \pfcase{(3) $\sstepA{\st'}{\st''}$} Applying (n-q-anatrans-step) to (3), we have (4) $\sstepA{\sqitm{\anatrans{n'}{\st'}}}{\sqitm{\anatrans{n'}{\st''}}}$. We can conclude by (I) on (4).

    \pfcase{(3) $\svalA{\st'}$} Applying (n-q-anatrans-val) to (2), (b) and (1), we have (4) $\svalA{\sqitm{\anatrans{n'}{\st'}}}$. We can conclude by (II) on (4).

    \pfcase{(3) $\serrA{\st'}$} Applying (n-q-anatrans-err-prop) to (3), we have (4) $\serrA{\sqitm{\anatrans{n'}{\st'}}}$. We can conclude by (III) on (4).
\end{quote}

\pfcase{(k-qitm-syntrans)} We have $\st=\sqitm{\syntrans{n'}}$ and (1) $n' < n$. Applying (n-q-syntrans-val) to (b) and (1), we have (2) $\svalA{\sqitm{\syntrans{n'}}}$. We can conclude by (II) on (2).

\pfcases{[All rules in Figure \ref{fig:kinding-qitm-shared}]} We give an example base case and inductive cases with 0, 1, 2 and 3 sub-terms. All rules with the same number of sub-terms follow the corresponding script, replacing only the forms and rule names:

\begin{quote}
    \pfcase{[k-qitm-var]} In this case, $\st=\sqitm{x}$. Applying (n-q-x-val), we have (1) $\svalA{\sqitm{x}}$. We can conclude by (II) on (1).

    \pfcase{(k-qitm-tabs)} We have that $\st=\sqitm{\iLam{\alpha}{\qitm}}$ and (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

    \begin{quote}
        \pfcase{(2) $\sstepA{\sqitm{\qitm}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (2), we have $\st'=\sqitm{\qitm'}$. Applying (n-q-tabs-step) to (2), we have (3) $\sstepA{\sqitm{\iLam{\alpha}{\qitm}}}{\sqitm{\iLam{\alpha}{\qitm'}}}$. We can conclude by (I) on (3).

        \pfcase{(2) $\svalA{\sqitm{\qitm}}$} Applying (n-q-tabs-val) to (2), we have (3) $\svalA{\sqitm{\iLam{\alpha}{\qitm}}}$. We can conclude by (II) on (3).

        \pfcase{(2) $\serrA{\sqitm{\qitm}}$} Applying (n-q-tabs-err-prop) to (2), we have (3) $\serrA{\sqitm{\iLam{\alpha}{\qitm}}}$. We can conclude by (III) on (3).
    \end{quote}

    \pfcase{[k-qitm-abs]} In this case, $\st=\sqitm{\ilam{\qity}{x}{\qitm}}$ and (1) $\sofkVX{\sqity{\qity}}{\kity}$ and (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

    \begin{quote}
        \pfcase{(3) $\sstepA{\sqity{\qity}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity'}$. Applying (n-q-abs-step-1) on (3), we have (4) $\sstepA{\sqitm{\ilam{\qity}{x}{\qitm}}}{\sqitm{\ilam{\qity'}{x}{\qitm}}}$. We can conclude by (I) on (4).

        \pfcase{(3) $\svalA{\sqity{\qity}}$} Applying the IH (2) and (b), we have three cases:
        \begin{quote}
            \pfcase{(4) $\sstepA{\sqitm{\qitm}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), we have $\st_2'=\sqitm{\qitm'}$. Applying (n-q-abs-step-2) to (3) and (4), we have (5) $\qstep{\ilam{\qity}{x}{\qitm}}{\ilam{\qity}{x}{\qitm'}}$. We can conclude by (I) on (5).

            \pfcase{(4) $\qval{\qitm}$} Applying (n-q-abs-val) to (3) and (4), we have (5) $\qval{\ilam{\qity}{x}{\qitm}}$. We can conclude by (II) on (5).

            \pfcase{(4) $\qerr{\qitm}$} Applying (n-q-abs-err-prop-2) to (4), we have (5) $\qerr{\ilam{\qity}{x}{\qitm}}$. We can conclude by (III) on (5).
        \end{quote}

        \pfcase{(3) $\serrA{\sqity{\qity}}$} Applying (n-q-abs-err-prop-2) to (3), we have (4) $\qerr{\ilam{\qity}{x}{\qitm}}$. We can conclude by (III) on (4).
    \end{quote}

    \pfcase{(k-qitm-case)} In this case $\st=\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}$ and (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (2) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

    \begin{quote}
        \pfcase{(4) $\sstepA{\sqitm{\qitm}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), $\st'=\sqitm{\qitm'}$. Applying (n-q-case-step-1) to (4), we have (5) $\sstepA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}{\sqitm{\icase{\qitm'}{x}{\qitm_1}{x}{\qitm_2}}}$. We can conclude by (I) on (5).

        \pfcase{(4) $\svalA{\sqitm{\qitm}}$} Applying the IH to (2) and (b), we have three cases:

        \begin{quote}
            \pfcase{(5) $\sstepA{\sqitm{\qitm_1}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (5), $\st_1'=\sqitm{\qitm_1'}$. Applying (n-q-case-step-2) to (4) and (5), we have (6) $\sstepA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}{\sqitm{\icase{\qitm}{x}{\qitm_1'}{x}{\qitm_2}}}$. We can conclude by (I) on (6).

            \pfcase{(5) $\svalA{\sqitm{\qitm_1}}$} Applying the IH to (3) and (b), we have three cases:

            \begin{quote}
                \pfcase{(6) $\sstepA{\sqitm{\qitm_2}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (6), $\st_2'=\sqitm{\qitm_2'}$. Applying (n-q-case-step-3) to (4), (5) and (6), we have (7) $\sstepA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2'}}}$. We can conclude by (I) on (7).

                \pfcase{(6) $\svalA{\sqitm{\qitm_2}}$} Applying (n-q-case-val) to (4), (5) and (6), we have (7) $\svalA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}$. We can conclude by (II) on (7).

                \pfcase{(6) $\serrA{\sqitm{\qitm_2}}$} Applyig (n-q-case-err-prop-3) to (6), we have (7) $\serrA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}$. We can conclude by (III) on (7).
            \end{quote}

            \pfcase{(5) $\serrA{\sqitm{\qitm_1}}$} Applying (n-q-case-err-prop-2) to (5), we have (6) $\serrA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}$. We can conclude by (III) on (6).
        \end{quote}

        \pfcase{(4) $\serrA{\sqitm{\qitm}}$} Applying (n-q-case-err-prop-1) to (4), we have (5) $\serrA{\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}}$. We can conclude by (III) on (5).
    \end{quote}

\end{quote}

% \pfcase{[k-qitm-ap]} In this case, $\st=\sqitm{\iap{\st_1}{\st_2}}$ and (1) $\sofkVX{\sqitm{\qitm_1}}$ and (2) $\sofkVX{\sqitm{\qitm_2}}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqitm{\qitm_1}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (3), $\st_1'=\sqitm{\qitm_1'}$. Applying (n-q-ap-step-1) on (3), we have (4) $\sstepA{\sqitm{\iap{\qitm_1}{\qitm_2}}}{\sqitm{\iap{\qitm_1'}{\qitm_2}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqitm{\qitm_1}}$} Applying the IH (2) and (b), we have three cases:
%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqitm{\qitm_2}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), we have $\st_2'=\sqitm{\qitm_2'}$. Applying (n-q-ap-step-2) to (3) and (4), we have (5) $\qstep{\iap{\qitm_1}{\qitm_2}}{\iap{\qitm_1}{\qitm_2'}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\qval{\qitm_2}$} Applying (n-q-ap-val) to (3) and (4), we have (5) $\qval{\iap{\qitm_1}{\qitm_2}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\qerr{\qitm_2}$} Applying (n-q-ap-err-prop-2) to (4), we have (5) $\qerr{\iap{\qitm_1}{\qitm_2}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqitm{\qitm_1}}$} Applying (n-q-ap-err-prop-2) to (3), we have (4) $\qerr{\iap{\qitm_1}{\qitm_2}}$. We can conclude by (III) on (4).
% \end{quote}



% \pfcase{(k-qitm-tap)} We have that $\st=\sqitm{\iAp{\qity}{\qitm}}$ and (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (2) $\sofkVX{\sqity{\qity}}{\kity}$. Applying the IH to (1), there are three possibilities:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqitm{\qitm}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (3), $\st_1'=\sqitm{\qitm'}$. Applying (n-q-tap-step-1) to (3), we have (4) $\sstepA{\sqitm{\iAp{\qity}{\qitm}}}{\sqitm{\iAp{\qity}{\qitm'}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqitm{\qitm}}$} Applying the IH to (2), there are three possibilities:

%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqity{\qity}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (4), $\st_2'=\sqity{\qity'}$. By (n-q-tap-step-2) on (3) and (4), we have (5) $\sstepA{\sqity{\iAp{\qity}{\qitm}}}{\sqity{\iAp{\qity'}{\qitm}}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\svalA{\sqity{\qity}}$} Applying (n-q-tap-val) to (3) and (4), we have (5) $\svalA{\sqity{\iAp{\qity}{\qitm}}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\serrA{\sqity{\qity}}$} Applying (n-q-tap-err-prop-2) to (4), we have (5) $\serrA{\sqity{\iAp{\qity}{\qitm}}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqitm{\qitm}}$} Applying (n-q-tap-err-prop-1) to (3), we have (4) $\serrA{\sqitm{\iAp{\qity}{\qitm}}}$. We can conclude by (III) on (4).
% \end{quote}

% \pfcase{[k-qitm-fold]} In this case, $\st=\sqitm{\ifold{t}{\qity}{\qitm}}$ and (1) $\sofkVX{\sqity{\qity}}{\kity}$ and (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqity{\qity}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity'}$. Applying (n-q-fold-step-1) on (3), we have (4) $\sstepA{\sqitm{\ifold{t}{\qity}{\qitm}}}{\sqitm{\ifold{t}{\qity'}{\qitm}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqity{\qity}}$} Applying the IH (2) and (b), we have three cases:
%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqitm{\qitm}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), we have $\st_2'=\sqitm{\qitm'}$. Applying (n-q-fold-step-2) to (3) and (4), we have (5) $\qstep{\ifold{t}{\qity}{\qitm}}{\ifold{t}{\qity}{\qitm'}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\qval{\qitm}$} Applying (n-q-fold-val) to (3) and (4), we have (5) $\qval{\ifold{t}{\qity}{\qitm}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\qerr{\qitm}$} Applying (n-q-fold-err-prop-2) to (4), we have (5) $\qerr{\ifold{t}{\qity}{\qitm}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqity{\qity}}$} Applying (n-q-fold-err-prop-2) to (3), we have (4) $\qerr{\ifold{t}{\qity}{\qitm}}$. We can conclude by (III) on (4).
% \end{quote}

% \pfcase{(k-qitm-unfold)} We have that $\st=\sqitm{\iunfold{\qitm}}$ and (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(2) $\sstepA{\sqitm{\qitm}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (2), we have $\st'=\sqitm{\qitm'}$. Applying (n-q-unfold-step) to (2), we have (3) $\sstepA{\sqitm{\iunfold{\qitm}}}{\sqitm{\iunfold{\qitm'}}}$. We can conclude by (I) on (3).

%     \pfcase{(2) $\svalA{\sqitm{\qitm}}$} Applying (n-q-unfold-val) to (2), we have (3) $\svalA{\sqitm{\iunfold{\qitm}}}$. We can conclude by (II) on (3).

%     \pfcase{(2) $\serrA{\sqitm{\qitm}}$} Applying (n-q-unfold-err-prop) to (2), we have (3) $\serrA{\sqitm{\iunfold{\qitm}}}$. We can conclude by (III) on (3).
% \end{quote}

% \pfcase{[k-qitm-triv]} In this case, $\st=\sqitm{())}$. Applying (n-q-triv-val), we have (1) $\svalA{\sqitm{()}}$. We can conclude by (II) on (1).


% \pfcase{[k-qitm-pair]} In this case, $\st=\sqitm{\ipair{\st_1}{\st_2}}$ and (1) $\sofkVX{\sqitm{\qitm_1}}$ and (2) $\sofkVX{\sqitm{\qitm_2}}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqitm{\qitm_1}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (3), $\st_1'=\sqitm{\qitm_1'}$. Applying (n-q-pair-step-1) on (3), we have (4) $\sstepA{\sqitm{\ipair{\qitm_1}{\qitm_2}}}{\sqitm{\ipair{\qitm_1'}{\qitm_2}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqitm{\qitm_1}}$} Applying the IH (2) and (b), we have three cases:
%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqitm{\qitm_2}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), we have $\st_2'=\sqitm{\qitm_2'}$. Applying (n-q-pair-step-2) to (3) and (4), we have (5) $\qstep{\ipair{\qitm_1}{\qitm_2}}{\ipair{\qitm_1}{\qitm_2'}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\qval{\qitm_2}$} Applying (n-q-pair-val) to (3) and (4), we have (5) $\qval{\ipair{\qitm_1}{\qitm_2}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\qerr{\qitm_2}$} Applying (n-q-pair-err-prop-2) to (4), we have (5) $\qerr{\ipair{\qitm_1}{\qitm_2}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqitm{\qitm_1}}$} Applying (n-q-pair-err-prop-2) to (3), we have (4) $\qerr{\ipair{\qitm_1}{\qitm_2}}$. We can conclude by (III) on (4).
% \end{quote}


% \pfcase{(k-qitm-fst)} We have that $\st=\sqitm{\ifst{\qitm}}$ and (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(2) $\sstepA{\sqitm{\qitm}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (2), we have $\st'=\sqitm{\qitm'}$. Applying (n-q-fst-step) to (2), we have (3) $\sstepA{\sqitm{\ifst{\qitm}}}{\sqitm{\ifst{\qitm'}}}$. We can conclude by (I) on (3).

%     \pfcase{(2) $\svalA{\sqitm{\qitm}}$} Applying (n-q-fst-val) to (2), we have (3) $\svalA{\sqitm{\ifst{\qitm}}}$. We can conclude by (II) on (3).

%     \pfcase{(2) $\serrA{\sqitm{\qitm}}$} Applying (n-q-fst-err-prop) to (2), we have (3) $\serrA{\sqitm{\ifst{\qitm}}}$. We can conclude by (III) on (3).
% \end{quote}


% \pfcase{(k-qitm-snd)} We have that $\st=\sqitm{\isnd{\qitm}}$ and (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(2) $\sstepA{\sqitm{\qitm}}{\st'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (2), we have $\st'=\sqitm{\qitm'}$. Applying (n-q-snd-step) to (2), we have (3) $\sstepA{\sqitm{\isnd{\qitm}}}{\sqitm{\isnd{\qitm'}}}$. We can conclude by (I) on (3).

%     \pfcase{(2) $\svalA{\sqitm{\qitm}}$} Applying (n-q-snd-val) to (2), we have (3) $\svalA{\sqitm{\isnd{\qitm}}}$. We can conclude by (II) on (3).

%     \pfcase{(2) $\serrA{\sqitm{\qitm}}$} Applying (n-q-snd-err-prop) to (2), we have (3) $\serrA{\sqitm{\isnd{\qitm}}}$. We can conclude by (III) on (3).
% \end{quote}


% \pfcase{[k-qitm-inl]} In this case, $\st=\sqitm{\iinl{\qity}{\qitm}}$ and (1) $\sofkVX{\sqity{\qity}}{\kity}$ and (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqity{\qity}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity'}$. Applying (n-q-inl-step-1) on (3), we have (4) $\sstepA{\sqitm{\iinl{\qity}{\qitm}}}{\sqitm{\iinl{\qity'}{\qitm}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqity{\qity}}$} Applying the IH (2) and (b), we have three cases:
%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqitm{\qitm}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), we have $\st_2'=\sqitm{\qitm'}$. Applying (n-q-inl-step-2) to (3) and (4), we have (5) $\qstep{\iinl{\qity}{\qitm}}{\iinl{\qity}{\qitm'}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\qval{\qitm}$} Applying (n-q-inl-val) to (3) and (4), we have (5) $\qval{\iinl{\qity}{\qitm}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\qerr{\qitm}$} Applying (n-q-inl-err-prop-2) to (4), we have (5) $\qerr{\iinl{\qity}{\qitm}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqity{\qity}}$} Applying (n-q-inl-err-prop-2) to (3), we have (4) $\qerr{\iinl{\qity}{\qitm}}$. We can conclude by (III) on (4).
% \end{quote}


% \pfcase{[k-qitm-inr]} In this case, $\st=\sqitm{\iinr{\qity}{\qitm}}$ and (1) $\sofkVX{\sqity{\qity}}{\kity}$ and (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (b), we have three cases:

% \begin{quote}
%     \pfcase{(3) $\sstepA{\sqity{\qity}}{\st_1'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-types} on (3), $\st_1'=\sqity{\qity'}$. Applying (n-q-inr-step-1) on (3), we have (4) $\sstepA{\sqitm{\iinr{\qity}{\qitm}}}{\sqitm{\iinr{\qity'}{\qitm}}}$. We can conclude by (I) on (4).

%     \pfcase{(3) $\svalA{\sqity{\qity}}$} Applying the IH (2) and (b), we have three cases:
%     \begin{quote}
%         \pfcase{(4) $\sstepA{\sqitm{\qitm}}{\st_2'}$} By Lemma \ref{lemma:stepping-quoted-translational-internal-terms} on (4), we have $\st_2'=\sqitm{\qitm'}$. Applying (n-q-inr-step-2) to (3) and (4), we have (5) $\qstep{\iinr{\qity}{\qitm}}{\iinr{\qity}{\qitm'}}$. We can conclude by (I) on (5).

%         \pfcase{(4) $\qval{\qitm}$} Applying (n-q-inr-val) to (3) and (4), we have (5) $\qval{\iinr{\qity}{\qitm}}$. We can conclude by (II) on (5).

%         \pfcase{(4) $\qerr{\qitm}$} Applying (n-q-inr-err-prop-2) to (4), we have (5) $\qerr{\iinr{\qity}{\qitm}}$. We can conclude by (III) on (5).
%     \end{quote}

%     \pfcase{(3) $\serrA{\sqity{\qity}}$} Applying (n-q-inr-err-prop-2) to (3), we have (4) $\qerr{\iinr{\qity}{\qitm}}$. We can conclude by (III) on (4).
% \end{quote}


\pfcase{(k-ana)} We have $\st=\sana{n'}{\st'}$ and (1) $n' < n$ and (2) $\sofkVX{\st'}{\kty}$. Applying the IH to (2) and (b), we have three cases:
\begin{quote}
    \pfcase{(3) $\sstepA{\st'}{\st''}$} Applying (n-ana-step) to (3), we have (4) $\sstepA{\sana{n'}{\st'}}{\sana{n'}{\st''}}$. We can conclude by (I) on (4).

    \pfcase{(3) $\svalA{\st'}$} By (1) and (b), we have (4) $\keyw{nth}[n'](\es)=e$.

    Because our semantics are non-deterministic (the bracketed premise of (n-ana-fail) is assumed to be only advisory to implementors), by applying (n-ana-fail) to (3) and (4), we have (5) $\serrA{\sana{n'}{\st'}}$. We can conclude by (III) on (5).

    \pfcase{(3) $\serrA{\st'}$} Applying (n-ana-err-prop) to (3), we have (4) $\serrA{\sana{n'}{\st'}}$. We can conclude by (III) on (4).
\end{quote}

\pfcase{(k-syn)} We have $\st=\ssyn{n'}$ and (1) $n' < n$. By (1) and (b), we have (2) $\keyw{nth}[n](\es)=e$. Because our semantics are non-deterministic (the bracketed premise of (n-syn-fail) is assumed to be only advisory to implementors), by applying (n-syn-fail) to (2), we have (3) $\serrA{\ssyn{n'}}$. We can conclude by (III) on (3).
\end{proof}

\begin{theorem}[Static Preservation]\label{thm:static-preservation}
Letting $\argEnv=\es;\Upsilon;\Phi$, if (a) $\sstep{\st}{\es; \Upsilon; \Phi}{\st'}$ and (b) $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\st}{\kappa}$ and (c) $\vdash \Phi$ and (d) $\Upsilon~\mathtt{ctx}_{\Phi}$ then $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\st'}{\kappa}$.
\end{theorem}
\begin{proof} Rule induction on (a).

\pfcase{[All rules in Figure \ref{fig:static-dynamics-SL-core}]} The cases for the core language follow the standard script and are omitted for concision.

\pfcase{(n-ty-step)} In this case, we have $\st=\sty{c}{\sttyidx}$ and $\st'=\sty{c}{\sttyidx'}$ and $\kappa=\kty$ and (1) $\sstepA{\sttyidx}{\sttyidx'}$. Rule induction on (b). Only three rules apply:
\begin{quote}
    \pfcase{(k-ty-parr)} In this case, we have $c={\rightharpoonup}$ and (2) $\sofkVX{\sttyidx}{\kty\times\kty}$. Applying the IH to (1), (2), (c) and (d), we have (3) $\sofkVX{\sttyidx'}{\kty\times\kty}$. Apply (k-ty-parr) to (3).

    \pfcase{(k-ty-ext)} In this case, we have $c=\tc$ and (2) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi$ and (3) $\sofkVX{\sttyidx}{\ktyidx}$. Applying the IH to (1), (3), (c) and (d), we have (4) $\sofkVX{\sttyidx'}{\ktyidx}$. Apply (k-ty-ext) to (2) and (4).

    \pfcase{(k-ty-other)} In this case, we have $c=\otherc{m}{\kappa'}$ and (2) $\keq{}{\kappa'}$ and (3) $\sofkVX{\sttyidx}{\kappa'\times\kity}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sttyidx'}{\kappa'\times\kity}$. Apply (k-ty-other) to (2) and (4).
\end{quote}

\pfcase{(n-tycase-step)} In this case, we have $\st=\stycase{c}{\st''}{\sx}{\st_1}{\sx}{\st_2}$ and $\st'=\stycase{c}{\st'''}{\sx}{\st_1}{\sx}{\st_2}$ and (1) $\sstepA{\st''}{\st'''}$. Rule induction on (b). Only two rules apply:
\begin{quote}
    \pfcase{(k-tycase-parr)} In this case, we have $c={\rightharpoonup}$ and (2) $\sofkVX{\st''}{\kty}$ and (3) $\sofk{\emptyset}{\emptyset, \sx :: \kty\times\kty}{\Phi}{\st_1}{\kappa}$ and (4) $\sofk{\emptyset}{\emptyset}{\Phi}{\st_2}{\kappa}$. Applying the IH to (1) and (2), we have that (5) $\sofkVX{\st'''}{\kty}$. Apply (k-tycase-parr) to (5), (3) and (4).

    \pfcase{(k-tycase-ext)} In this case, have $c=\tc$ and (2) $\sofkVX{\st''}{\kty}$ and (3) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi$ and (4) $\sofk{\emptyset}{\emptyset, \sx :: \ktyidx}{\Phi}{\st_1}{\kappa}$ and (5) $\sofkVX{\st_2}{\kappa}$. Applying the IH to (1) and (2), we have that (6) $\sofkVX{\st'''}{\kty}$. Apply (k-tycase-ext) to (6), (3), (4) and (5).
\end{quote}

\pfcase{(n-tycase-elim-1)} In this case, we have $\st=\stycase{c}{\sty{c}{\sttyidx}}{\sx}{\st_1}{\st_2}$ and $\st'=[\sttyidx/\sx]\st_1$ and (1) $\svalA{\sty{c}{\sttyidx}}$. Rule induction on (b). Only two rules apply:
\begin{quote}
    \pfcase{(k-tycase-parr)} In this case, we have $c={\rightharpoonup}$ and (2) $\sofkVX{\sty{\rightharpoonup}{\sttyidx}}{\kty}$ and (3) $\sofk{\emptyset}{\emptyset, \sx :: \kty\times\kty}{\Phi}{\st_1}{\kappa}$. Applying Lemma \ref{lemma:static-canonical-forms}.7 to (1) and (2), we have that (4) $\sttyidx=(\st_1, \st_2)$ and (5) $\sofkVX{\sttyidx}{\kty\times\kty}$. Apply Assumption \ref{assumption:static-term-variable-substitution} to (3) and (5). 

    \pfcase{(k-tycase-ext)} In this case, we have $c=\tc$ and (2) $\sofkVX{\sty{\tc}{\sttyidx}}{\kty}$ and (3) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta}$ and (4) $\sofk{\emptyset}{\emptyset, \sx :: \ktyidx}{\st_1}{\kappa}$. Applying Lemma 18.7 to (1) and (2), we have that (5) $\sofkVX{\sttyidx}{\ktyidx}$. Apply Assumption \ref{assumption:static-term-variable-substitution} to (4) and (5).
\end{quote}

\pfcase{(n-tycase-elim-2)} In this case, we have $\st=\stycase{c}{\sty{c'}{\sttyidx}}{\sx}{\st_1}{\st_2}$ and $\st'=\st_2$. Rule induction on (b). Only two rules apply:
\begin{quote}
    \pfcase{(k-tycase-parr)} In this case, we have (1) $\sofkVX{\st_2}{\kappa}$. We can conclude by (1).

    \pfcase{(k-tycase-ext)} In this case, we have (1) $\sofkVX{\st_2}{\kappa}$. We can conclude by (1).
\end{quote}

\pfcase{(n-q-t-unquote-step)} In this case, we have $\st=\sqity{\qtuq{\st''}}$ and $\st'=\sqity{\qtuq{\st'''}}$ and $\kappa=\kity$ and (1) $\sstepA{\st''}{\st'''}$. Rule induction on (b). Only rule (k-qity-unquote) applies, so (2) $\sofkVX{\st''}{\kity}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\st'''}{\kity}$. Apply (k-qity-unquote) to (3).

\pfcase{(n-q-t-unquote-elim)} In this case, we have $\st=\sqity{\qtuq{\sqity{\qity}}}$ and $\st'=\sqity{\qity}$ and $\kappa=\kity$. Rule induction on (b). Only rule (k-qity-unquote) applies, so (1) $\sofkVX{\sqity{\qity}}{\kity}$. We can conclude by (1).

\pfcase{(n-q-tytrans-step)} In this case, we have $\st=\sqity{\srep{\st''}}$ and $\st'=\sqity{\srep{\st'''}}$ and $\kappa=\kity$ and (1) $\sstepA{\st''}{\st'''}$. Rule induction on (b). Only rule (k-qity-trans) applies, so (2) $\sofkVX{\st''}{\kity}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\st'''}{\kity}$. Apply (k-qity-trans) to (3).

\pfcases{[All rules in Figure \ref{fig:static-dynamics-SL-qity-shared}]} We give an example for forms with 1 and 2 sub-terms. All rules with the same number of sub-terms follow the corresponding script, replacing only the forms and rule names.

\begin{quote}
    \pfcase{(n-q-forall-step)} In this case, we have $\st=\sqity{\iforall{\alpha}{\qity}}$ and $\st'=\sqity{\iforall{\alpha}{\qity'}}$ and (1) $\qtstep{\qity}{\qity'}$. Rule induction on (b). Only rule (k-qity-forall) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\sqity{\qity'}}{\kity}$. Apply (k-qity-forall) to (3). 

    \pfcase{(n-q-parr-step-1)} In this case, we have $\st=\sqity{\iparr{\qity_1}{\qity_2}}$ and $\st'=\sqity{\iparr{\qity_1'}{\qity_2}}$ and (1) $\qtstep{\qity_1}{\qity_1'}$. Rule induction on (b). Only rule (k-qity-parr) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity_1'}}{\kity}$. Apply (k-qity-parr) to (4) and (3).

    \pfcase{(n-q-parr-step-2)} In this case, we have $\st=\sqity{\iparr{\qity_1}{\qity_2}}$ and $\st'=\sqity{\iparr{\qity_1}{\qity_2'}}$ and (1) $\qtstep{\qity_2}{\qity_2'}$. Rule induction on (b). Only rule (k-qity-parr) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqity{\qity_2'}}{\kity}$. Apply (k-qity-parr) to (2) and (4).
\end{quote}
% \pfcase{(n-q-mu-step)} In this case, we have $\st=\sqity{\imu{t}{\qity}}$ and $\st'=\sqity{\imu{t}{\qity'}}$ and (1) $\qtstep{\qity}{\qity'}$. Rule induction on (b). Only rule (k-qity-mu) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\sqity{\qity'}}{\kity}$. Apply (k-qity-mu) to (3). 

% \pfcase{(n-q-prod-step-1)} In this case, we have $\st=\sqity{\iprod{\qity_1}{\qity_2}}$ and $\st'=\sqity{\iprod{\qity_1'}{\qity_2}}$ and (1) $\qtstep{\qity_1}{\qity_1'}$. Rule induction on (b). Only rule (k-qity-prod) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity_1'}}{\kity}$. Apply (k-qity-prod) to (4) and (3).

% \pfcase{(n-q-prod-step-2)} In this case, we have $\st=\sqity{\iprod{\qity_1}{\qity_2}}$ and $\st'=\sqity{\iprod{\qity_1}{\qity_2'}}$ and (1) $\qtstep{\qity_2}{\qity_2'}$. Rule induction on (b). Only rule (k-qity-prod) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqity{\qity_2'}}{\kity}$. Apply (k-qity-prod) to (2) and (4).

% \pfcase{(n-q-sum-step-1)} In this case, we have $\st=\sqity{\isum{\qity_1}{\qity_2}}$ and $\st'=\sqity{\isum{\qity_1'}{\qity_2}}$ and (1) $\qtstep{\qity_1}{\qity_1'}$. Rule induction on (b). Only rule (k-qity-sum) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity_1'}}{\kity}$. Apply (k-qity-sum) to (4) and (3).

% \pfcase{(n-q-sum-step-2)} In this case, we have $\st=\sqity{\isum{\qity_1}{\qity_2}}$ and $\st'=\sqity{\isum{\qity_1}{\qity_2'}}$ and (1) $\qtstep{\qity_2}{\qity_2'}$. Rule induction on (b). Only rule (k-qity-sum) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqity{\qity_2}}{\kity}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqity{\qity_2'}}{\kity}$. Apply (k-qity-sum) to (2) and (4).

\pfcase{(n-q-unquote-step)} In this case, we have $\st=\sqitm{\quq{\st''}}$ and $\st'=\sqitm{\quq{\st'''}}$ and $\kappa=\kitm$ and (1) $\sstepA{\st''}{\st'''}$. Rule induction on (b). Only rule (k-qitm-unquote) applies, so (2) $\sofkVX{\st''}{\kitm}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\st'''}{\kitm}$. Apply (k-qitm-unquote) to (3).

\pfcase{(n-q-unquote-elim)} In this case, we have $\st=\sqitm{\quq{\sqitm{\qitm}}}$ and $\st'=\sqitm{\qitm}$ and $\kappa=\kitm$. Rule induction on (b). Only rule (k-qitm-unquote) applies, so (1) $\sofkVX{\sqitm{\qitm}}{\kitm}$. We can conclude by (1).

\pfcase{(n-q-anatrans-step)} In this case, we have $\st=\sqitm{\anatrans{n'}{\st''}}$ and $\st'=\sqitm{\anatrans{n'}{\st'''}}$ and $\kappa=\kitm$ and (1) $\sstepA{\st''}{\st'''}$. Rule induction on (b). Only rule (k-qitm-anatrans) applies, so (2) $\sofkVX{\st''}{\kitm}$ and (3) $n' < n$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\st'''}{\kitm}$. Apply (k-qitm-trans) to (3) and (4).

\pfcases{[All rules in Figures \ref{fig:static-dynamics-SL-qitm-shared-1} and \ref{fig:static-dynamics-SL-qitm-shared-2}]} We give an example for forms with 1, 2 and 3 sub-terms. All rules with the same number of sub-terms follow the corresponding script, replacing only the forms and rule names.

\begin{quote}
    \pfcase{(n-q-tabs-step)} In this case, we have $\st=\sqitm{\iLam{\alpha}{\qitm}}$ and $\st'=\sqitm{\iLam{\alpha}{\qitm'}}$ and (1) $\qtstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-tabs) applies, so (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-tabs) to (3). 

    \pfcase{(n-q-abs-step-1)} In this case, we have $\st=\sqitm{\ilam{\qity_1}{x}{\qitm_2}}$ and $\st'=\sqitm{\ilam{\qity_1'}{x}{\qitm_2}}$ and (1) $\qtstep{\qity_1}{\qity_1'}$. Rule induction on (b). Only rule (k-qitm-abs) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity_1'}}{\kity}$. Apply (k-qitm-abs) to (4) and (3).

    \pfcase{(n-q-abs-step-2)} In this case, we have $\st=\sqitm{\ilam{\qity_1}{x}{\qitm_2}}$ and $\st'=\sqitm{\ilam{\qity_1}{x}{\qitm_2'}}$ and (1) $\qstep{\qitm_2}{\qitm_2'}$. Rule induction on (b). Only rule (k-qitm-abs) applies, so (2) $\sofkVX{\sqity{\qity_1}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm_2'}}{\kitm}$. Apply (k-qitm-abs) to (2) and (4).

    \pfcase{(n-q-case-step-1)} In this case, we have $\st=\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}$ and $\st'=\sqitm{\icase{\qitm'}{x}{\qitm_1}{x}{\qitm_2}}$ and (1) $\qstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-case) applies, so (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (4) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (2), we have (5) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-case) to (5), (3) and (4). 

    \pfcase{(n-q-case-step-2)} In this case, we have $\st=\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}$ and $\st'=\sqitm{\icase{\qitm}{x}{\qitm_1'}{x}{\qitm_2}}$ and (1) $\qstep{\qitm_1}{\qitm_1'}$. Rule induction on (b). Only rule (k-qitm-case) applies, so (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (4) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (3), we have (5) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-case) to (2), (5) and (4). 

    \pfcase{(n-q-case-step-3)} In this case, we have $\st=\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2}}$ and $\st'=\sqitm{\icase{\qitm}{x}{\qitm_1}{x}{\qitm_2'}}$ and (1) $\qstep{\qitm_2}{\qitm_2'}$. Rule induction on (b). Only rule (k-qitm-case) applies, so (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (4) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (4), we have (5) $\sofkVX{\sqitm{\qitm_2'}}{\kitm}$. Apply (k-qitm-case) to (2), (3) and (5). 
\end{quote}
% \pfcase{(n-q-ap-step-1)} In this case, we have $\st=\sqitm{\iap{\qitm_1}{\qitm_2}}$ and $\st'=\sqitm{\iap{\qitm_1'}{\qitm_2}}$ and (1) $\qstep{\qitm_1}{\qitm_1'}$. Rule induction on (b). Only rule (k-qitm-ap) applies, so (2) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqitm{\qitm_1'}}{\kitm}$. Apply (k-qitm-ap) to (4) and (3).

% \pfcase{(n-q-ap-step-2)} In this case, we have $\st=\sqitm{\iap{\qitm_1}{\qitm_2}}$ and $\st'=\sqitm{\iap{\qitm_1}{\qitm_2'}}$ and (1) $\qstep{\qitm_2}{\qitm_2'}$. Rule induction on (b). Only rule (k-qitm-ap) applies, so (2) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm_2'}}{\kitm}$. Apply (k-qitm-ap) to (2) and (4).


% \pfcase{(n-q-tap-step-1)} In this case, we have $\st=\sqitm{\iAp{\qity}{\qitm}}$ and $\st'=\sqitm{\iAp{\qity}{\qitm'}}$ and (1) $\qstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-tap) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-tap) to (2) and (4).

% \pfcase{(n-q-tap-step-2)} In this case, we have $\st=\sqitm{\iAp{\qity}{\qitm}}$ and $\st'=\sqitm{\iAp{\qity'}{\qitm}}$ and (1) $\qtstep{\qity}{\qity'}$. Rule induction on (b). Only rule (k-qitm-tap) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity'}}{\kity}$. Apply (k-qitm-tap) to (4) and (3).

% \pfcase{(n-q-fold-step-1)} In this case, we have $\st=\sqitm{\ifold{t}{\qity}{\qitm}}$ and $\st'=\sqitm{\ifold{t}{\qity'}{\qitm}}$ and (1) $\qtstep{\qity}{\qity'}$. Rule induction on (b). Only rule (k-qitm-fold) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity'}}{\kity}$. Apply (k-qitm-fold) to (4) and (3).

% \pfcase{(n-q-fold-step-2)} In this case, we have $\st=\sqitm{\ifold{t}{\qity}{\qitm}}$ and $\st'=\sqitm{\ifold{t}{\qity}{\qitm'}}$ and (1) $\qstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-fold) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-fold) to (2) and (4).

% \pfcase{(n-q-unfold-step)} In this case, we have $\st=\sqitm{\iunfold{\qitm}}$ and $\st'=\sqitm{\iunfold{\qitm'}}$ and (1) $\qtstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-unfold) applies, so (2) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (2), we have (3) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-unfold) to (3). 

% \pfcase{(n-q-pair-step-1)} In this case, we have $\st=\sqitm{\ipair{\qitm_1}{\qitm_2}}$ and $\st'=\sqitm{\ipair{\qitm_1'}{\qitm_2}}$ and (1) $\qstep{\qitm_1}{\qitm_1'}$. Rule induction on (b). Only rule (k-qitm-pair) applies, so (2) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqitm{\qitm_1'}}{\kitm}$. Apply (k-qitm-pair) to (4) and (3).

% \pfcase{(n-q-pair-step-2)} In this case, we have $\st=\sqitm{\ipair{\qitm_1}{\qitm_2}}$ and $\st'=\sqitm{\ipair{\qitm_1}{\qitm_2'}}$ and (1) $\qstep{\qitm_2}{\qitm_2'}$. Rule induction on (b). Only rule (k-qitm-pair) applies, so (2) $\sofkVX{\sqitm{\qitm_1}}{\kitm}$ and (3) $\sofkVX{\sqitm{\qitm_2}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm_2'}}{\kitm}$. Apply (k-qitm-pair) to (2) and (4).

% \pfcase{(n-q-inl-step-1)} In this case, we have $\st=\sqitm{\iinl{\qity}{\qitm}}$ and $\st'=\sqitm{\iinl{\qity'}{\qitm}}$ and (1) $\qtstep{\qity}{\qity'}$. Rule induction on (b). Only rule (k-qitm-inl) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity'}}{\kity}$. Apply (k-qitm-inl) to (4) and (3).

% \pfcase{(n-q-inl-step-2)} In this case, we have $\st=\sqitm{\iinl{\qity}{\qitm}}$ and $\st'=\sqitm{\iinl{\qity}{\qitm'}}$ and (1) $\qstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-inl) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-inl) to (2) and (4).

% \pfcase{(n-q-inr-step-1)} In this case, we have $\st=\sqitm{\iinr{\qity}{\qitm}}$ and $\st'=\sqitm{\iinr{\qity'}{\qitm}}$ and (1) $\qtstep{\qity}{\qity'}$. Rule induction on (b). Only rule (k-qitm-inr) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (2), we have (4) $\sofkVX{\sqity{\qity'}}{\kity}$. Apply (k-qitm-inr) to (4) and (3).

% \pfcase{(n-q-inr-step-2)} In this case, we have $\st=\sqitm{\iinr{\qity}{\qitm}}$ and $\st'=\sqitm{\iinr{\qity}{\qitm'}}$ and (1) $\qstep{\qitm}{\qitm'}$. Rule induction on (b). Only rule (k-qitm-inr) applies, so (2) $\sofkVX{\sqity{\qity}}{\kity}$ and (3) $\sofkVX{\sqitm{\qitm}}{\kitm}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\sqitm{\qitm'}}{\kitm}$. Apply (k-qitm-inr) to (2) and (4).


\pfcase{(n-ana-step)} In this case, we have $\st=\sana{n'}{\st''}$ and $\st'=\sana{n'}{\st'''}$ and (1) $\sstepA{\st''}{\st'''}$. Rule induction on (b). Only rule (k-ana) applies, so (2) $n' < n$ and (3) $\sofkVX{\st''}{\kty}$. Applying the IH to (1) and (3), we have (4) $\sofkVX{\st'''}{\kty}$. Apply (k-ana) to (2) and (4).

\pfcase{(n-ana-success)} In this case, we have $\st=\sana{n'}{\st''}$ and $\st'=\sqitm{\anatrans{n'}{\st''}}$. Rule induction on (b). Only rule (k-ana) applies, so (2) $n' < n$ and (3) $\sofkVX{\st''}{\kty}$. Apply (k-qitm-anatrans) to (2) and (3).

\pfcase{(n-syn-success)} In this case, we have $\st=\ssyn{n'}$ and (1) $\keyw{nth}[n'](\es)=e$ and (2) $\eanaX{e}{\st''}{\iota}$ and $\st'=(\st'', \sqitm{\syntrans{n'}})$. Rule induction on (b). Only rule (k-syn) applies, so (3) $n' < n$. Applying Theorem \ref{lemma:type-synthesis} to (c), (d), (2), we have that (4) $\sofkVX{\st''}{\kty}$. Applying (k-qitm-syntrans) to (3), we have (5) $\sofkVX{\sqitm{\syntrans{n'}}}{\kitm}$. Applying (k-prod) to (4) and (5), we have that $\sofkVX{(\st'', \sqitm{\syntrans{n'}})}{\kty\times\kitm}$. 

\end{proof}

The final case in the proof of Theorem \ref{thm:static-preservation}, for (n-syn-success), requires that Theorem \ref{lemma:type-synthesis}, shown in Sec. \ref{sec:type-synthesis-and-kind-safety} be mutually defined (we give a metric there that strictly decreases, to ensure that the mutual induction is well-founded). 

Preservation extends straightforwardly to the multistep judgement $\smanystep{\st}{\argEnv}{\st'}$ in Figure \ref{fig:static-multistep-dynamics}, which is simply the reflexive, transitive closure of the stepping judgement.

\begin{lemma}[Static Multistep Preservation]
\label{lemma:static-multistep-preservation}
Letting $\argEnv=\es; \Upsilon; \Phi$, if (a) $\smanystep{\st}{\argEnv}{\st'}$ and (b) $\sofkVX{\st}{\kappa}$ and (c) $\vdash \Phi$ and (d) $\Upsilon~\mathtt{ctx}_\Phi$ then $\sofkVX{\st}{\kappa}$.
\end{lemma}
\begin{proof} Rule induction on (a). 

\pfcase{(n-multi-refl)} In this case, $\st'=\st$, so the conclusion is assumption (b).

\pfcase{(n-multi-step)} In this case, (1) $\smanystep{\st}{\argEnv}{\st''}$ and (2) $\sstepA{\st''}{\st'}$. Applying the IH to (1), (b), (c) and (d), we have that (3) $\sofkVX{\st''}{\kappa}$. Applying Theorem \ref{thm:static-preservation} to (b), (3), (c) and (d), we have our conclusion.
\end{proof}

The normalization judgement is defined as follows:

\begin{definition}[Static Normalization]
\label{definition:static-normalization}
$\st \Downarrow_\argEnv \st'$ iff $\smanystep{\st}{\argEnv}{\st'}$ and $\svalA{\st'}$.
\end{definition}

\begin{corollary}[Static Normalization Preservation]
\label{lemma:static-normalization-preservation}
If (a) $\st \Downarrow_\argEnv \st'$ and (b) $\sofkVX{\st}{\kappa}$ and (c) $\vdash \Phi$ and (d) $\Upsilon~\mathtt{ctx}_\Phi$ then $\sofkVX{\st'}{\kappa}$.
\end{corollary}
\begin{proof} By Definition \ref{definition:static-normalization} on (a), we have (1) $\smanystep{\st}{\argEnv}{\st'}$. By Lemma \ref{lemma:static-multistep-preservation} on (1), (b), (c) and (d), we have our conclusion.
\end{proof}

\subsection{Stability}

\begin{lemma}[Stability of Kinding]
\label{lemma:stability-of-kinding}
If (a) $\tccsigok{\Phi}$ and (b) $\sofkX{\st}{\kappa}$ and (c) $\tccsigok{\Phi'\Phi}$  then $\sofk{\kDelta}{\kGamma}{\Phi'\Phi}{\st}{\kappa}$.
\end{lemma}
\begin{proof} By rule induction on (c). All cases except the following proceed by  application of the IH to all kinding premises and re-application of the same rule, because they are defined for all $\Phi$ and all premises are checked under the same $\Phi$.


\pfcase{(k-ty-ext)} We have $\st=\sty{\tc}{\sttyidx}$ and (1) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi$ and (2) $\sofkX{\sttyidx}{\ktyidx}$. By the definition of prepending on ordered mappings, we have (3) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi'\Phi$. By the IH on (a), (2) and (c), we have (4) $\sofk{\kDelta}{\kGamma}{\Phi'\Phi}{\sttyidx}{\ktyidx}$. Apply (k-ty-ext) on (3) and (4). 

\pfcase{(k-tycase-ext)} We have $\st=\stycase{\tc}{\st'}{\sx}{\st_1}{\st_2}$ and (1) $\sofkX{\st'}{\kty}$ and (2) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi$ and (3) $\sofk{\kDelta}{\kGamma, \sx :: \ktyidx}{\Phi}{\st_1}{\kappa}$ and (4) $\sofkX{\st_2}{\kappa}$.

By the IH on (a), (1) and (c), we have (5) $\sofk{\kDelta}{\kGamma}{\Phi'\Phi}{\st'}{\kty}$.

By the definition of prepending on ordered mappings, we have (6) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi'\Phi$. 

By the IH on (a), (3) and (c), we have (7)  $\sofk{\kDelta}{\kGamma, \sx :: \ktyidx}{\Phi'\Phi}{\st_1}{\kappa}$.

By the IH on (a), (4) and (c), we have (8) $\sofk{\kDelta}{\kGamma}{\Phi'\Phi}{\st_2}{\kappa}$.

Apply (k-tycase-ext) to (5), (6), (7) and (8).
\end{proof}

\begin{lemma}[Stability of Kinding 2]
\label{lemma:stability-of-kinding-2}
If (a) $\tccsigok{\Phi}$ and (b) $\sofkX{\st}{\kappa}$ and (c) $\tccsigok{\Phi\Phi'}$  then $\sofk{\kDelta}{\kGamma}{\Phi\Phi'}{\st}{\kappa}$.
\end{lemma}
\begin{proof} By rule induction on (c). All cases except the following proceed by  application of the IH to all kinding premises and re-application of the same rule, because they are defined for all $\Phi$ and all premises are checked under the same $\Phi$.

\pfcase{(k-ty-ext)} We have $\st=\sty{\tc}{\sttyidx}$ and (1) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi$ and (2) $\sofkX{\sttyidx}{\ktyidx}$. By the definition of appending ordered mappings, we have (3) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi\Phi'$. By the IH on (a), (2) and (c), we have (4) $\sofk{\kDelta}{\kGamma}{\Phi\Phi'}{\sttyidx}{\ktyidx}$. Apply (k-ty-ext) on (3) and (4). 

\pfcase{(k-tycase-ext)} We have $\st=\stycase{\tc}{\st'}{\sx}{\st_1}{\st_2}$ and (1) $\sofkX{\st'}{\kty}$ and (2) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi$ and (3) $\sofk{\kDelta}{\kGamma, \sx :: \ktyidx}{\Phi}{\st_1}{\kappa}$ and (4) $\sofkX{\st_2}{\kappa}$.

By the IH on (a), (1) and (c), we have (5) $\sofk{\kDelta}{\kGamma}{\Phi\Phi'}{\st'}{\kty}$.

By the definition of appending ordered mappings, we have (6) $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\theta} \in \Phi\Phi'$. 

By the IH on (a), (3) and (c), we have (7)  $\sofk{\kDelta}{\kGamma, \sx :: \ktyidx}{\Phi\Phi'}{\st_1}{\kappa}$.

By the IH on (a), (4) and (c), we have (8) $\sofk{\kDelta}{\kGamma}{\Phi\Phi'}{\st_2}{\kappa}$.

Apply (k-tycase-ext) to (5), (6), (7) and (8). \end{proof}

\begin{corollary}[Stability of Kinding 3]
\label{lemma:stability-of-kinding-3}
If (a) $\vdash \Phi$ and (b) $\sofkX{\st}{\kappa}$ and (c) $\vdash \Phi\Phi'$ then $\sofk{\kDelta}{\kGamma}{\Phi\Phi'}{\st}{\kappa}$.
\end{corollary}
\begin{proof}
Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} on (a), we have (1) $\tccsigok{\Phi}$.

Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} on (c), we have (2) $\tccsigok{\Phi\Phi'}$.

Apply Lemma \ref{lemma:stability-of-kinding-2} to (1), (b) and (2).
\end{proof}

We can now give corresponding stability lemmas about tycon context extension.

\begin{lemma}[Stability of Opcon Structure Validity]
\label{lemma:stability-of-opcon-structure-validity}
If (a) $\tccsigok{\Phi}$ and (b) $\vdash_\Phi \omega \sim \psi$ and (c)  $\tccsigok{\Phi'\Phi}$ then $\vdash_{\Phi'\Phi} \omega \sim \psi$. 
\end{lemma}
\begin{proof} Rule induction on (b).

\pfcase{(ocstruct-intro)} We have $\omega=\tcstructn{\stx{def}}$ and (1) $\emptyset \vdash \klitidx$ and (2) $
    \sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$.

    By Lemma \ref{lemma:stability-of-kinding} on (a), (2) and (c), we have (3) $
    \sofkz{\emptyset}{\emptyset}{\Phi'\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$.

    Apply (ocstruct-intro) to (1) and (3).

\pfcase{(ocstruct-targ)} We have $\omega=\tcstructc{\omega'}{op}{\stx{def}}$ and $\psi=\tcsig{\ktyidx}{\chi; \opsig{\opname{op}}{\klitidx}}$ and (1) $\vdash_\Phi \omega' \sim \tcsig{\ktyidx}{\chi}$ and (2) $\emptyset \vdash \klitidx$ and (3) $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.

By the IH on (a), (1) and (c), we have (4) $\vdash_{\Phi'\Phi} \omega' \sim \tcsig{\ktyidx}{\chi}$.

By Lemma \ref{lemma:stability-of-kinding} on (a), (3) and (c), we have (5) $\sofkn{\emptyset}{\emptyset}{\Phi'\Phi}{0}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.

Apply (ocstruct-targ) to (4), (2) and (5).
\end{proof}

\begin{lemma}[Stability of Opcon Structure Validity 2]
\label{lemma:stability-of-opcon-structure-validity-2}
If (a) $\tccsigok{\Phi}$ and (b) $\vdash_\Phi \omega \sim \psi$ and (c)  $\tccsigok{\Phi\Phi'}$ then $\vdash_{\Phi\Phi'} \omega \sim \psi$. 
\end{lemma}
\begin{proof} Rule induction on (b).

\pfcase{(ocstruct-intro)} We have $\omega=\tcstructn{\stx{def}}$ and (1) $\emptyset \vdash \klitidx$ and (2) $
    \sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$.

    By Lemma \ref{lemma:stability-of-kinding-2} on (a), (2) and (c), we have (3) $
    \sofkz{\emptyset}{\emptyset}{\Phi\Phi'}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$.

    Apply (ocstruct-intro) to (1) and (3).

\pfcase{(ocstruct-targ)} We have $\omega=\tcstructc{\omega'}{op}{\stx{def}}$ and $\psi=\tcsig{\ktyidx}{\chi; \opsig{\opname{op}}{\klitidx}}$ and (1) $\vdash_\Phi \omega' \sim \tcsig{\ktyidx}{\chi}$ and (2) $\emptyset \vdash \klitidx$ and (3) $\sofkn{\emptyset}{\emptyset}{\Phi}{0}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.

By the IH on (a), (1) and (c), we have (4) $\vdash_{\Phi\Phi'} \omega' \sim \tcsig{\ktyidx}{\chi}$.

By Lemma \ref{lemma:stability-of-kinding} on (a), (3) and (c), we have (5) $\sofkn{\emptyset}{\emptyset}{\Phi\Phi'}{0}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.

Apply (ocstruct-targ) to (4), (2) and (5).
\end{proof}

\begin{corollary}[Stability of Opcon Structure Validity 3]
\label{lemma:stability-of-opcon-structure-validity-3}
If (a) $\vdash \Phi$ and (b) $\vdash_\Phi \omega \sim \psi$ and (c) $\vdash \Phi\Phi'$ then $\vdash_{\Phi\Phi'} \omega \sim \psi$.
\end{corollary}
\begin{proof} Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} to (a), we have (1) $\tccsigok{\Phi}$. 

Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} to (c), we have (2) $\tccsigok{\Phi\Phi'}$.

Apply Lemma \ref{lemma:stability-of-opcon-structure-validity-2} to (1), (b) and (2).
\end{proof}

\begin{lemma}[Tycon Context Extension]
If (a) $\vdash \Phi$ and (b) $\vdash \Phi'$ and (c) $\text{dom}(\Phi) \cap \text{dom}(\Phi') = \emptyset$ then $\vdash \Phi\Phi'$.
\end{lemma}
\begin{proof} Rule induction on (b).

\pfcase{(tcc-emp)} Here, $\Phi'=\emptyset$, so $\Phi\Phi'=\Phi$ and $\vdash \Phi$ by (a).

\pfcase{(tcc-ext)} Here, $\Phi'=\Phi'', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$ and (1) $\vdash \Phi''$ and (2) $\keq{}{\ktyidx}$ and (3) $
    \sofkz{\emptyset}{\emptyset}{\Phi''}{\stx{schema}}{\ktyidx \rightarrow \kity}$ and (4) $
        \vdash_{\Phi'',  \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$.

        By the fact that $\Phi''$ is a prefix of $\Phi'$ and (c), we have that (5) $\text{dom}(\Phi) \cap \text{dom}(\Phi'')$. 

        By the IH on (a), (1) and (5), we have (6) $\vdash \Phi\Phi''$.

        By Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} on (6), we have (7) $\tccsigok{\Phi\Phi''}$. 

        By Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} on (1), we have (8) $\tccsigok{\Phi''}$.

        By Lemma \ref{lemma:stability-of-kinding} on (8), (3) and (7), we have (9) $\sofkz{\emptyset}{\emptyset}{\Phi\Phi''}{\stx{schema}}{\ktyidx \rightarrow \kity}$.

        By Lemma \ref{lemma:chi-ok} on (4), we have (10) $\vdash \chi$.

        By (tcsig-ok) on (2) and (10), we have (11) $\vdash \tcsig{\ktyidx}{\chi}$.

        By (tcc-sigok-ext) on (7) and (11), we have (12) $\tccsigok{\Phi\Phi'', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}}$. 

        By (tcc-sigok-ext) on (8) and (11), we have (13) $\tccsigok{\Phi'', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}}$.

        By Lemma \ref{lemma:stability-of-opcon-structure-validity} on (13), (4) and (12), we have (14) $
        \vdash_{\Phi\Phi'',  \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$. 

        By (tcc-ext) on (6), (2), (9) and (14), we have our conclusion. 
\end{proof}

\newpage
\section{External Language}
\subsection{Syntax}
We now turn to the external language. The abstract syntax of the external language is given in Figure \ref{syntax-EL} and Figures \ref{fig:example-intro-desugarings} and \ref{fig:example-targeted-desugarings} give various desugarings.  Although we do not detail it here, we expect a technique based on \cite{TSLs} could be introduced to allow new desugarings to be introduced composably. 

Argument lists, $\es$, are assumed to be defined as metatheoretic lists, so we assume standard operations like computing the length, written $|\es|=n$, or retrieving an element, written $\keyw{nth}[n](\es)=e$, are already defined and obey standard metatheoretic properties.

\subsection{Typing}
The typing rules are given in Figure \ref{fig:typing}. We will cover their premises in the next several subsections, then return to the metatheory after that.

\subsection{Argument Interfaces}

\begin{definition}[Argument Interface Kind]
The kind abbreviated $\karg$ is defined as\[\karg := (\kty \rightarrow \kitm) \times (\kunit \rightarrow \kty\times\kitm)\]
\end{definition}

\begin{lemma}[Argument Interface Kind is a Kind] 
\label{lemma:argument-interface-kind-is-kind}
We have that $\emptyset \vdash \karg$.
\end{lemma}
\begin{proof} We apply the following sequences of rules to construct the derivation in a bottom up, left-to-right manner:

Apply (kf-prod). Apply (kf-arrow). Apply (kf-ty). Apply (kf-itm). Apply (kf-arrow). Apply (kf-unit). Apply (kf-prod). Apply (kf-ty). Apply (kf-itm).
\end{proof}

The argument interfaces that populate the list provided to opcon definitions is derived from the argument list $\es$ by the judgement $\keyw{args}(n)= \stx{args}$, where the $n$ we use is the length of the argument list (including the target argument when applicable). This judgement is defined in Figure \ref{fig:arg-interface-list} with an auxiliary judgement $\keyw{args}(n, m)=\stx{args}$, where $m$ is used to count up to $n$ so that the argument indices are in the correct order.

\begin{lemma}[Argument Interface Lists (Auxiliary)]
\label{lemma:argument-interface-lists-aux}
If $\keyw{args}(n, m)=\stx{args}$ then (i) $\svalA{\stx{args}}$ and (ii) $\sofkn{\emptyset}{\emptyset}{\Phi}{n+m}{\stx{args}}{\kargs}$.
\end{lemma}
\begin{proof} Rule induction on the assumption.

\pfcase{(mk-arg-interface-nil)} In this case, $n=0$ and thus $n+m=m$, and $\stx{args}=\keyw{nil}[\karg]$. Applying (n-nil-val), we have (i) $\svalA{\keyw{nil}[\karg]}$. By Lemma \ref{lemma:argument-interface-kind-is-kind}, we have (1) $\emptyset \vdash \karg$. Applying (k-nil) to (1), we have (ii) $\sofkn{\emptyset}{\emptyset}{\Phi}{m}{\keyw{nil}[\karg]}{\klist{\karg}}$.

\pfcase{(mk-arg-interface-cons)} In this case, $n=n'+1$ and (1) $\keyw{args}(n', m+1)=\stx{args}'$ and $$\stx{args}=\keyw{cons}((\slam{\svar{ty}}{\kty}{\sana{m}{\svar{ty}}}, \slam{\kunit}{\_}{\ssyn{m}}); \stx{args}')$$

Applying the IH to (1), we have that (2) $\svalA{\stx{args}'}$ and (3) $\sofkn{\emptyset}{\emptyset}{\Phi}{n'+(m+1)}{\stx{args}'}{\kargs}$. Noting that $(n'+1)+m=n'+(m+1)$ by the usual properties of arithmetic, we thus have that (4) $\sofkn{\emptyset}{\emptyset}{\Phi}{(n'+1)+m}{\stx{args}'}{\kargs}$.

Applying (kf-ty), we have (5) $\emptyset \vdash \kty$.

Applying (k-var), we have that (6) $\sofkn{\emptyset}{\emptyset, \svar{ty} :: \kty}{\Phi}{(n' + 1) + m}{\svar{ty}}{\kty}$.

We have that (7) $m < (n' + 1) + m$ by the usual properties of arithmetic inequalities.

Applying (k-ana) to (7) and (6), we have (8) $\sofkn{\emptyset}{\emptyset, \svar{ty} :: \kty}{\Phi}{(n' + 1) + m}{\sana{m}{\svar{ty}}}{\kitm}$.

Applying (k-abs) to (5) and (8), we have (9) $\sofkn{\emptyset}{\emptyset}{\Phi}{(n'+1)+m}{\slam{\kty}{\svar{ty}}{\sana{m}{\svar{ty}}}}{\karrow{\kty}{\kitm}}$.

Applying (k-syn) to (7), we have (10) $\sofkn{\emptyset}{\emptyset, \_ :: \kunit}{\Phi}{(n' + 1) + m}{\ssyn{m}}{\kty\times\kitm}$.

Applying (kf-unit), we have (11) $\emptyset \vdash \kunit$.

Applying (k-abs) to (11) and (1), we have (12) $\sofkn{\emptyset}{\emptyset}{\Phi}{(n' + 1) + m}{\slam{\kunit}{\_}{\ssyn{m}}}{\karrow{\kunit}{\kty\times\kitm}}$.

Applying (k-pair) to (9) and (12), we have (13) $$\sofkn{\emptyset}{\emptyset}{\Phi}{(n' + 1) + m}{(\slam{\svar{ty}}{\kty}{\sana{m}{\svar{ty}}}, \slam{\kunit}{\_}{\ssyn{m}})}{\karg}$$

Applying (k-cons) to (12) and (4), we have (ii)  $$\sofkn{\emptyset}{\emptyset}{\Phi}{(n' + 1) + m}{\keyw{cons}((\slam{\svar{ty}}{\kty}{\sana{m}{\svar{ty}}}, \slam{\kunit}{\_}{\ssyn{m}}); \stx{args}')}{\kargs}$$

Applying (n-abs-val), we have (14) $\svalA{\slam{\svar{ty}}{\kty}{\sana{m}{\svar{ty}}}}$. 

Applying (n-abs-val), we have (15) $\svalA{\slam{\kunit}{\_}{\ssyn{m}}}$.

Applying (n-pair-val) to (14) and (15), we have (16) $\svalA{(\slam{\svar{ty}}{\kty}{\sana{m}{\svar{ty}}}, \slam{\kunit}{\_}{\ssyn{m}})}$.

Applying (n-cons-val) to (16) and (2), we have (i) $$\svalA{\keyw{cons}((\slam{\svar{ty}}{\kty}{\sana{m}{\svar{ty}}}, \slam{\kunit}{\_}{\ssyn{m}}); \stx{args}')}$$
\end{proof}

\begin{lemma}[Argument Interface Lists]
\label{lemma:argument-interface-lists}
If $\keyw{args}(n)=\stx{args}$ then (i) $\svalA{\stx{args}}$ and (ii) $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\stx{args}}{\kargs}$.
\end{lemma}
\begin{proof} Rule induction on the assumption. There is only one rule, (mk-arg-interface), so we have that (1) $\keyw{args}(n, 0)=\stx{args}$. Applying Lemma \ref{lemma:argument-interface-lists-aux} to (1) and noting that $n+0=n$ by definition, we have (i) $\svalA{\stx{args}}$ and (ii) $\sofkn{\emptyset}{\emptyset}{\Phi}{n}{\stx{args}}{\kargs}$.
\end{proof}


\subsection{Type Synthesis and Static Preservation}\label{sec:type-synthesis-and-kind-safety}

To prove the type synthesis theorem below, we need a notion of external typing context validity, defined by the judgement $\Upsilon~\mathtt{ctx}_{\Phi}$ in Figure \ref{fig:typing-context-well-formedness}. It simply ensures that all bindings in $\Upsilon$ map to types.


\begin{lemma}[Typing Context Validity]
\label{lemma:typing-context-validity}
If (a) $\Upsilon~\mathtt{ctx}_{\Phi}$ and (b) $x : \st \in \Upsilon$ then $\istype{\st}{\Phi}$.
\end{lemma}
\begin{proof} Rule induction on (a) and (b).

\pfcase{(tctx-ok-emp)} Does not apply by (b).

\pfcase{(tctx-ok-ext)} In this case, $\Upsilon=\Upsilon', x' : \st'$ and (1) $\Upsilon~\mathtt{ctx}_{\Phi}'$ and (2) $\istype{\st'}{\Phi}$. We have two cases by (b):

\begin{quote}
    \pfcase{$x = x'$ and $\st=\st'$} In this case, we have our conclusion by (2).

    \pfcase{$x \neq x'$ and (3) $x : \st \in \Upsilon'$} In this case, we apply our IH to (1) and (3) to conclude.
\end{quote}
\end{proof}

\begin{theorem}[Type Synthesis]
\label{lemma:type-synthesis}
If (a) $\vdash \Phi$ and (b) $\Upsilon~\mathtt{ctx}_{\Phi}$ and (c) $\esynX{e}{\st}{\iota}$ then $\istype{\st}{\Phi}$.
\end{theorem}
\begin{proof}Rule induction on (c).

\pfcase{(ascribe)} In this case, we have $e=e' : \st'$ and (1) $\sofkVXz{\st'}{\kty}$ and (2) $\st' \Downarrow_{\cdot;\emptyset;\Phi} \st$. By Corollary \ref{lemma:static-normalization-preservation} on (2), (1), (a) and (b), we have (3) $\sofkVXz{\st}{\kty}$. By Definition \ref{definition:static-normalization} on (2), we have (4) $\sval{\st}{\cdot;\emptyset;\Phi}$. Apply Definition \ref{def:types} to (3) and (4). 

\pfcase{(var)} In this case, we have (1) $x : \st \in \Upsilon$. Apply Lemma \ref{lemma:typing-context-validity} to (a) and (1).

\pfcase{(syn-lam)} In this case, we have $e=\elam{\st_1}{x}{e'}$ and $\st=\sty{\rightharpoonup}{(\st_1', \st_2)}$ and (1) $\sofkVXz{\st_1}{\kty}$ and (2) $\st_1 \Downarrow_{\cdot;\emptyset;\Phi} \st_1'$ and (3) $\esyn{\Upsilon, x : \st_1'}{\Phi}{e'}{\st_2}{\iota'}$. 

By Corollary \ref{lemma:static-normalization-preservation} on (2), (1), (a) and (b), we have (3) $\sofkVXz{\st_1'}{\kty}$. By Definition \ref{definition:static-normalization} on (2), we have (4) $\sval{\st_1'}{\cdot;\emptyset;\Phi}$. By Definition \ref{def:types} on (3) and (4), we have (5) $\istype{\st_1'}{\Phi}$.

By (tctx-ok-ext) to (b) and (5), we have (6) $\Upsilon, x : \st_1'~\mathtt{ctx}_\Phi$.

Applying the IH to (a), (6) and (3), we have (7) $\istype{\st_2}{\Phi}$ and so by Definition \ref{def:types} on (7), we have (8) $\sofkVXz{\st_2}{\kty}$ and (9) $\sval{\st_2}{\cdot;\emptyset;\Phi}$.

Applying (k-pair) to (3) and (8), we have (10) $\sofkVXz{(\st_1', \st_2)}{\kty\times\kty}$.

Applying (k-ty-parr) to (10), we have (11) $\sofkVXz{\sty{\rightharpoonup}{(\st_1', \st_2)}}{\kty}$.

Applying (n-pair-val) to (4) and (9), we have (12) $\sval{(\st_1', \st_2)}{\cdot;\emptyset;\Phi}$.

Applying (n-ty-val) to (12), we have $\sval{\sty{\rightharpoonup}{(\st_1', \st_2)}}{\cdot;\emptyset;\Phi}$.

Apply Definition \ref{def:types} to (11) and (13).

\pfcase{(syn-ap)} In this case, $e=\eap{e_1}{e_2}$ and (1) $\esynX{e_1}{\sty{\rightharpoonup}{(\st_1, \st)}}{\iota_1}$. Applying the IH to (a), (b) and (1), we have (2) $\istype{\sty{\rightharpoonup}{(\st_1, \st)}}{\Phi}$. By Definition \ref{def:types} on (2), we have (3) $\sofkVXz{\sty{\rightharpoonup}{(\st_1, \st)}}{\kty}$ and (4) $\svalA{\sty{\rightharpoonup}{(\st_1, \st)}}$. By Lemma \ref{lemma:static-canonical-forms} on (4) and (3), we have $\istype{\st}{\Phi}$. 

\pfcase{(syn-targ)} In this case, $e=\etarg{\opname{op}}{\stx{tmidx}}{e_\text{targ}}{\es}$ and \begin{enumerate}[(1)]
\item $\esynX{e_\text{targ}}{\sty{\tc}{\sttyidx}}{\iota_\text{targ}}$ and 
\item $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$ and
\item $\opsig{\opname{op}}{\klitidx} \in \chi$ and
\item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stmidx}{\klitidx}$ and
\item $\keyw{syn~}\opname{op}={\stx{def}} \in \omega$ and
\item $|e_\text{targ}; \es| = n$ and
\item $\keyw{args}(n)=\stx{args}$ and
\item $\stx{def}(\sttyidx)(\stmidx)(\stx{args}) \Downarrow_{(e_\text{targ}; \es);\Upsilon;\Phi} (\st, \sqitm{\qitm})$.
\end{enumerate}

Applying the IH to (a), (b) and (1), we have (9) $\istype{\sty{\tc}{\sttyidx}}{\Phi}$. By Lemma \ref{lemma:static-canonical-forms}.7 on (9), we have (10) $\sofkVXz{\sttyidx}{\ktyidx}$. Applying Lemma \ref{lemma:weakening-of-argument-bounds} to (10), we have (11) $\sofkVX{\sttyidx}{\ktyidx}$.

Applying Lemma \ref{lemma:tycon-context-validity} to (2), we have that there is a prefix $\Phi'$ of $\Phi$ such that (12) $\vdash \Phi'$ and (13) $\vdash \Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$ and (14) $\vdash_{\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$.

Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} to (12), we have (15) $\tccsigok{\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}}$. Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} to (a), taking by the definition of prefixing that $\Phi=(\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}})\Phi''$, we have (16) $\tccsigok{(\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}})\Phi''}$. Applying Lemma \ref{lemma:stability-of-opcon-structure-validity} to (15), (14) and (16), we have that (17) $\vdash_{\Phi} \omega \sim \tcsig{\ktyidx}{\chi}$.


Applying Lemma \ref{lemma:targeted-opcon-validity} to (17) and (5), we have that (18) $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$. Applying Lemma \ref{lemma:weakening-of-argument-bounds} to (18), we have (19) $\sofk{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.

Applying Lemma \ref{lemma:argument-interface-lists} to (7), we have that (20) $\sofkVX{\stx{args}}{\kargs}$. 

Applying (k-ap) three times with (19), (11), (4) and (20), we have that (21) $\sofkVX{\stx{def}(\sttyidx)(\stx{tmidx})(\stx{args})}{\kty\times\kitm}$. 

Applying Corollary \ref{lemma:static-normalization-preservation} (see note on well-foundedness below) to (8), (21), (a) and (b), we have that (22) $\sofkVX{(\st, \sqitm{\qitm})}{\kty\times\kitm}$. By Definition \ref{definition:static-normalization} on (8), we have (23) $\sval{(\st, \sqitm{\qitm})}{(e_\text{targ}; \es); \Upsilon; \Phi}$. 

Applying Lemma \ref{lemma:static-canonical-forms}.5 to (23) and (22), we have that (24) $\sofkVX{\st}{\kty}$ and (25) $\sval{\st}{(e_\text{targ}; \es); \Upsilon; \Phi}$.  Apply Definition \ref{def:types} to (24) and (25).

\pfcase{(syn-targ-other)} In this case, we have that $\st=\etarg{\opname{op}}{(\st, \sqitm{\qitm})}{e_\text{targ}}{\es}$ and (1) $\istype{\st}{\Phi}$, so we can conclude by (1).
\end{proof}
The mutual induction is well-founded because the total number of intro and targeted terms that remain to be typechecked strictly decreases. In particular, we define the following metrics:

\newcommand{\esize}[1]{\|#1\|}

\begin{definition}[Extension Operation Count] The extension operation count, written $\esize{e}=n$ on external terms and $\esize{\es}=n$ on argument lists, is mutually defined as follows:
\[\begin{array}{rcl}
\esize{x} & = & 0\\
\esize{\eanalam{x}{e}} & = & \esize{e}\\
\esize{\elam{\st}{x}{e}} & = & \esize{e}\\
\esize{\eap{e_1}{e_2}} & = & \esize{e_1} + \esize{e_2}\\
\esize{\efix{x}{e}} & = & \esize{e}\\
\esize{e : \st} & = & \esize{e}\\
\esize{\eintro{\st}{\es}} & = & \esize{\es} + 1\\
\esize{\etarg{\opname{op}}{\st}{e_\text{targ}}{\es}} & = & \esize{e_\text{targ}} + \esize{\es} + 1\\
\\
\esize{\cdot} & = & 0\\
\esize{\es; e} & = & \esize{\es} + \esize{e}
\end{array}\]
\end{definition}

In the proof of Theorem \ref{lemma:type-synthesis} for an external term $e$ such that $\esize{e}=n$, Corollary \ref{lemma:static-normalization-preservation} (of Theorem \ref{thm:static-preservation}) is invoked only when $e=\etarg{\opname{op}}{\st'}{e_\text{targ}}{\es'}$ with an argument list $\es=e_\text{targ}; \es'$. By definition, $\esize{e}=\esize{e_\text{targ}} + \esize{\es'} + 1$ and $\esize{\es}=\esize{e_\text{targ}} + \esize{\es'}$, so $\esize{\es} < \esize{e}$.

In the proof of Theorem \ref{thm:static-preservation} with an argument list $\es$ such that $\esize{\es}=n$, Theorem \ref{lemma:type-synthesis} is invoked only on a term $e$ extracted from $\es$, so by definition $\esize{e} \leq \esize{\es}$. 

This metric strictly decreases every time we pass into Theorem \ref{thm:static-preservation} and does not increase in passing back to Theorem \ref{lemma:type-synthesis}, so mutual induction is well-founded.

\subsection{Type and Typing Context Translations}
The type translation judgement $\tytransX{\st}{\tau}$ specified in Figure \ref{fig:type-translation} simply checks that $\st$ is a type, then generates any selectively abstracted type translation and applies the type substitution it implies, discussed below.

\begin{lemma}[Types with Translations are Types]
\label{lemma:types-with-translations-are-types}
If $\tytransX{\st}{\tau}$ then $\istype{\st}{\Phi}$.
\end{lemma}
\begin{proof} Rule induction on the assumption. The conclusion is the first premise of the only rule.\end{proof}

Because typing contexts map variables to types, we need an analagous context translation judgement, $\ctxtransX{\Upsilon}{\Gamma}$, specified in Figure \ref{fig:typing-context--translation}.

\begin{lemma}[Typing Contexts with Translations are Valid Typing Contexts]
If $\ctxtransX{\Upsilon}{\Gamma}$ then $\vdash_\Phi \Upsilon$.
\end{lemma}
\begin{proof} Rule induction on the assumption.

\pfcase{(ctx-trans-emp)} Apply (tctx-ok-emp).

\pfcase{(ctx-trans-ext)} We have that $\Upsilon=\Upsilon', x : \st$ and (1) $\ctxtransX{\Upsilon'}{\Gamma'}$ and (2) $\tytransX{\st}{\tau}$. 

Applying the IH to (1), we have that (3) $\vdash_\Phi \Upsilon'$. Applying Lemma \ref{lemma:types-with-translations-are-types} to (2), we have (4) $\istype{\st}{\Phi}$. Apply (tctx-ok-ext) to (3) and (4).
\end{proof}

\subsubsection{Selectively Abstracted Type Translations}
The rules for generating selectively abstracted type translations are given in Figure \ref{fig:selectively-abstracted-type-translations}. They make use of a type translation store, $\memD$. For our metatheory, we need a notion of a valid type translation store under tycon context $\Phi$ for delegated tycon $c$, written $\tytsvX{\memD}$ and specified in Figure \ref{fig:type-translation-store-validity}. Each type translation store implies a type variable substitution and internal type formation context, $\Delta$, by the internalization judgement $\memD \leadsto \delta : \Delta$, specified in Figure \ref{fig:type-translation-store-Internalization}.

\begin{lemma}[Type Translation Store Validity]
\label{lemma:type-translation-store-validitiy}
If (a) $\tytsvX{\memD}$ and (b) $\sty{c'}{\sttyidx} \leftrightarrow \tau/\alpha \in \memD$ then (i) $c\neq c'$ and (ii) $\tytransX{\sty{c'}{\sttyidx}}{\tau}$ and (iii) $\emptyset \vdash \tau$.
\end{lemma}
\begin{proof} Rule induction on (a) and (b).

\pfcase{(tyts-ok-emp)} Does not apply by (b).

\pfcase{(tyts-ok-ext)} We have two cases by (b):
\begin{quote}
    \pfcase{$\memD=\memD', \sty{c'}{\sttyidx}$ and (1) $c\neq c'$ and (2) $\tytransX{\sty{c'}{\sttyidx}}{\tau}$} and (3) $\emptyset \vdash \tau$. We can conclude with (1) and (2).

    \pfcase{$\memD=\memD', \sty{c''}{\sttyidx'} \leftrightarrow \tau/\alpha$ for $c'\neq c''$ and (1) $\sty{c'}{\sttyidx} \leftrightarrow \tau/\alpha \in \memD$ and (2) $\tytsvX{\memD'}$} Apply the IH to  (2) and (1).
\end{quote}
\end{proof}

\begin{lemma}[Selective Type Translation Abstraction Caching]
\label{lemma:type-translation-stores-are-idempotent}
If (a) $\sofkVX{\sqity{\qity}}{\kity}$ and (b) $\sval{\sqity{\qity}}{\es;\Upsilon;\Phi}$ and (c) $\vdash \Phi$ and (d) $\tytsvX{\memD_1}$ and (e) $\tdeabs{\Phi}{c}{\qity}{\memD_1}{\ity}{\memD_2}$ then (i) $\tdeabs{\Phi}{c}{\qity}{\memD_2}{\ity}{\memD_2}$ and (ii) $\tdeabs{\Phi}{c}{\qity}{\emptyset}{\ity}{\memD_2}$.
\end{lemma}
\begin{proof} Rule induction on (e).

The proof follows by a straightforward application of the IH and re-application of the same rule in all cases except the following.

\pfcase{(abs-ext-not-delegated-new), (abs-other-not-delegated-new)} In these cases, we can apply (abs-ty-stored) to arrive at (i). Conclusion (ii) follows by the IH.

\pfcase{(abs-ty-stored)} In this case, conclusion (i) follows by re-applying (abs-ty-stored). Conclusion (ii) follows by applying Lemma \ref{lemma:type-translation-store-validitiy}, then inverting (ty-trans) and applying the IH. 
\end{proof}

\begin{lemma}[Selective Type Translation Abstraction]
\label{lemma:selective-type-translation-abstraction}
If (a) $\sofkVX{\sqity{\qity}}{\kity}$ and (b) $\sval{\sqity{\qity}}{\es;\Upsilon;\Phi}$ and (c) $\vdash \Phi$ and (d) $\tytsvX{\memD_1}$ and (e) $\tdeabs{\Phi}{c}{\qity}{\memD_1}{\ity}{\memD_2}$ then (i) $\tytsvX{\memD_2}$ and given $\memD_1 \leadsto \delta_1 : \Delta_1$, (ii) $\memD_2 \leadsto \delta_1\delta_2 : \Delta_1\Delta_2$ and (iii) $\emptyset \vdash \delta_1\delta_2 : \Delta_1\Delta_2$ and (iv) if $\qity=\srep{\st}$ then $\Delta_1\Delta_2 \vdash \tau$.
\end{lemma}
\begin{proof} Rule induction on (e). 

\pfcase{(abs-parr)} In this case, we have $\qity=\srep{\sty{\rightharpoonup}{(\st_1, \st_2)}}$ and $\ity=\iparr{\tau_1}{\tau_2}$ and \begin{enumerate}[(1)]
\item $\tdeabs{\Phi}{c}{\srep{\st_1}}{\memD_1}{\tau_1}{\memD'}$
\item $\tdeabs{\Phi}{c}{\srep{\st_2}}{\memD'}{\tau_2}{\memD_2}$
\end{enumerate}

By Lemma \ref{lemma:static-canonical-forms}.8 on (a) and (b), we have (3) $\istype{\sty{\rightharpoonup}{(\st_1, \st_2)}}{\Phi}$. By Lemma \ref{lemma:static-canonical-forms}.7 on (3), we have (4) $\istype{\st_1}{\Phi}$ and (5) $\istype{\st_2}{\Phi}$.  

By Definition \ref{def:types} on (4), we have (6) $\sofkVX{\st_1}{\kty}$ and (7) $\sval{\st_1}{\es;\Upsilon;\Phi}$.


By Definition \ref{def:types} on (5), we have (8) $\sofkVX{\st_2}{\kty}$ and (9) $\sval{\st_2}{\es;\Upsilon;\Phi}$.

By (k-qity-parr) on (6), we have (10) $\sofkVX{\sqity{\srep{\st_1}}}{\kity}$. By (n-qity-parr) on (7), we have (11) $\sval{\sqity{\srep{\st_1}}}{\es;\Upsilon;\Phi}$.

By (k-qity-parr) on (8), we have (12) $\sofkVX{\sqity{\srep{\st_2}}}{\kity}$. By (n-qity-parr) on (9), we have (13) $\sval{\sqity{\srep{\st_2}}}{\es;\Upsilon;\Phi}$.

By the IH on (10), (11), (c), (d) and (1), we have (14) $\tytsvX{\memD'}$ and (15) $\memD' \leadsto \delta_1\delta' : \Delta_1\Delta'$ and (16) $\emptyset \vdash \delta_1\delta' : \Delta_1\Delta'$ and (17) $\Delta_1\Delta \vdash \tau_1$.

By the IH on (12), (13), (c), (14) and (2), we have (i) $\tytsvX{\memD_2}$ and (ii) $\memD_2 \leadsto \delta_1\delta'\delta_2 : \Delta_1\Delta'\Delta_2$ and (iii) $\emptyset \vdash \delta_1\delta'\delta_2 : \Delta_1\Delta'\Delta_2$ and (18) $\Delta_1\Delta'\Delta_2 \vdash \tau_2$.

By Weakening on (17), we have that (19) $\Delta_1\Delta'\Delta_2 \vdash \tau_1$ and so by (18) and (19) and the usual rules of internal type formation, we have (iv) $\Delta_1\Delta'\Delta_2 \vdash \iparr{\tau_1}{\tau_2}$.

\pfcase{(abs-ext-delegated)} In this case, we have $\qity=\srep{\sty{\tc}{\sttyidx}}$ and \begin{enumerate}[(1)]
\item $\tcdef{\tc}{\psi}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$
\item $\stx{schema}(\stx{tyidx}) \Downarrow_{\cdot;\emptyset;\Phi} \sqity{\qity'}$
\item $\tdeabs{\Phi}{\tc}{\qity'}{\memD_1}{\tau}{\memD_2}$
\item $\memD_2 \leadsto \delta : \Delta$
\item $\Delta \vdash \tau$
\end{enumerate}

By Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} on (1), we have that there exists a prefix $\Phi'$ of $\Phi$ such that (6) $\vdash \Phi'$ and (7) $\sofkz{\emptyset}{\emptyset}{\Phi'}{\stx{schema}}{\ktyidx \rightarrow \kity}$. By Corollary \ref{lemma:stability-of-kinding-3} on (6), (7) and (c), we have (8) $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{schema}}{\ktyidx \rightarrow \kity}$.

By Lemma \ref{lemma:static-canonical-forms}.8 on (a) and (b), we have (9) $\istype{\sty{\tc}{\sttyidx}}{\Phi}$. By Lemma \ref{lemma:types-are-argument-independent} on (9), we have (10) $\sofkVXz{\sttyidx}{\ktyidx}$ and (11) $\sval{\sttyidx}{\es;\Upsilon;\Phi}$.

By (k-ap) on (8) and (10), we have (12) $\sofkVXz{\stx{schema}(\sttyidx)}{\kity}$.

By (tctx-ok-emp), we have (13) $\vdash_\Phi \emptyset$.

By Corollary \ref{lemma:static-normalization-preservation} on (2), (12), (c) and (13), we have (14) $\sofkVXz{\sqity{\qity'}}{\kity}$.

By Definition \ref{definition:static-normalization} on (2), we have (15) $\sval{\sqity{\qity'}}{\es;\Upsilon;\Phi}$. 

Applying the IH to (14), (15), (c), (d) and (3), which is well-founded by the metric defined below, we have (i), (ii) and (iii). By (5), we have (iv).

\pfcase{(abs-ext-not-delegated-new)} In this case, we have $\qity=\srep{\sty{\tc}{\sttyidx}}$ and $\memD_2=\memD', \sty{\tc}{\sttyidx} \leftrightarrow [\delta]\tau'/\alpha$  and \begin{enumerate}[(1)]
    \item $c\neq\tc$
    \item $\sty{\tc}{\sttyidx} \notin \text{dom}(\memD_1)$
    \item $\tcdef{\tc}{\psi}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$
    \item $\stx{schema}(\stx{tyidx}) \Downarrow_{\cdot;\emptyset;\Phi} \sqity{\qity'}$
    \item $\tdeabs{\Phi}{c}{\qity}{\memD_1}{\tau'}{\memD'}$
    \item $\memD' \leadsto \delta : \Delta$
    \item $\Delta \vdash \tau'$
\end{enumerate}
By Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} on (1), we have that there exists a prefix $\Phi'$ of $\Phi$ such that (6) $\vdash \Phi'$ and (7) $\sofkz{\emptyset}{\emptyset}{\Phi'}{\stx{schema}}{\ktyidx \rightarrow \kity}$. By Corollary \ref{lemma:stability-of-kinding-3} on (6), (7) and (c), we have (8) $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{schema}}{\ktyidx \rightarrow \kity}$.

By Lemma \ref{lemma:static-canonical-forms}.8 on (a) and (b), we have (9) $\istype{\sty{\tc}{\sttyidx}}{\Phi}$. By Lemma \ref{lemma:types-are-argument-independent} on (9), we have (10) $\sofkVXz{\sttyidx}{\ktyidx}$ and (11) $\sval{\sttyidx}{\es;\Upsilon;\Phi}$.

By (k-ap) on (8) and (10), we have (12) $\sofkVXz{\stx{schema}(\sttyidx)}{\kity}$.

By (tctx-ok-emp), we have (13) $\vdash_\Phi \emptyset$.

By Corollary \ref{lemma:static-normalization-preservation} on (2), (12), (c) and (13), we have (14) $\sofkVXz{\sqity{\qity'}}{\kity}$.

By Definition \ref{definition:static-normalization} on (2), we have (15) $\sval{\sqity{\qity'}}{\es;\Upsilon;\Phi}$. 

Applying the IH to (14), (15), (c), (d) and (3), which is well-founded by the metric defined below, we have (16) $\tytsvX{\memD'}$ and (17) $\memD' \leadsto \delta_1\delta' : \Delta_1\Delta'$ and (18) $\emptyset \vdash \delta_1\delta' : \Delta_1\Delta'$.

Applying (ty-store-int-ext) to (6) we have (19) $\memD_2 \leadsto (\delta_1\delta', [\delta_1\delta']\tau/\alpha) : \Delta_1\Delta', \alpha$, i.e. (ii).  By (7) and Weakening, we have (iv).

By definition,  $[\delta_1\delta', [\delta_1\delta']\tau'/\alpha]\alpha=[\delta_1\delta']\tau'$.

By Lemma \ref{lemma:type-translation-stores-are-idempotent} on (a-e), we have (20) $\tytransX{\st}{[\delta_1\delta']\tau'}$.

Applying (ty-trans) to (9), (20) and (19), we have (21) $\tytransX{\sty{\tc}{\sttyidx}}{[\delta_1\delta']\tau'}$. 

By Assumption \ref{assumption:static-type-variable-substitution} on (7) and (iii), we have (22) $\emptyset \vdash [\delta_1\delta']\tau'$.

Applying (tyts-ok-ext) to (16), (21) and (19) and (22), we have (i). By (tysub-ext) on (18) and (22), we have (iii).

\pfcase{(abs-other-delegated)} In this case, $\qity=\srep{\sty{\otherc{m}{\kappa}}{(\stx{data}, \sqity{\qity'})}}$ and \begin{enumerate}
    \item $\tdeabs{\Phi}{\otherc{m}{\kappa}}{\qity'}{\memD_1}{\tau}{\memD_2}$.
    \item $\memD_2 \leadsto \delta : \Delta$
    \item $\Delta \vdash \tau$
\end{enumerate}

By Lemma \ref{lemma:static-canonical-forms} iterated on (a) and (b), we have (4) $\sofkVX{\sqity{\qity'}}{\kity}$ and (5) $\sval{\sqity{\qity'}}{\es;\Upsilon;\Phi}$. Apply the IH to (4), (5), (c), (d) and (1).

\pfcase{(abs-other-not-delegated-new)} In this case, $\qity=\srep{\sty{\otherc{m}{\kappa}}{(\stx{data}, \sqity{\qity'})}}$ and $\tau=\alpha$ and $\memD_2 = \memD', \sty{\otherc{m}{\kappa}}{(\stx{data}, \sqity{\qity'})} \leftrightarrow [\delta]\tau'/\alpha$ and \begin{enumerate}
    \item $c \neq \otherc{m}{\kappa}$
    \item $\sty{\otherc{m}{\kappa}}{(\stx{data}, \sqity{\qity'})} \notin \text{dom}(\memD)$
    \item $\tdeabs{\Phi}{c}{\qity'}{\memD_1}{\tau'}{\memD'}$.
    \item $\memD' \leadsto \delta : \Delta$
    \item $\Delta \vdash \tau'$
\end{enumerate}

By Lemma \ref{lemma:static-canonical-forms} iterated on (a) and (b), we have (6) $\istype{\sty{\otherc{m}{\kappa}}{(\stx{data}, \sqity{\qity'})}}{\Phi}$ and (7) $\sofkVX{\sqity{\qity'}}{\kity}$ and (8) $\sval{\sqity{\qity'}}{\es;\Upsilon;\Phi}$. Applying the IH to (7), (8), (c), (d) and (3), we have (9) $\tytsvX{\memD'}$ and (10) $\memD' \leadsto \delta_1\delta' : \Delta_1\Delta'$ and (11) $\emptyset \vdash \delta_1\delta' : \Delta_1\Delta'$.

Applying (ty-store-int-ext) to (4) we have (12) $\memD_2 \leadsto (\delta_1\delta', [\delta_1\delta']\tau/\alpha) : \Delta_1\Delta', \alpha$, i.e. (ii). By (5) and Weakening, we have (iv).

By definition, (13) $[\delta_1\delta', [\delta_1\delta']\tau'/\alpha]\alpha=[\delta_1\delta']\tau'$.

Applying Lemma \ref{lemma:type-translation-stores-are-idempotent} on (a-e), we have its conclusion as (14).


Applying (ty-trans) to (6), (14) and (12), we have (15) $\tytransX{\sty{\otherc{m}{\kappa}}{(\stx{data}, \sqity{\qity'})}}{[\delta]\tau'}$. 

By Assumption \ref{assumption:static-type-variable-substitution} on (5) and (iii), we have (16) $\emptyset \vdash [\delta_1\delta']\tau'$.

Applying (tyts-ok-ext) to (6), (1), (15) and (16), we have (i). By (tysub-ext) on (11) and (16), we have (iii).

\pfcase{(abs-ty-stored)} Apply \ref{lemma:type-translation-store-validitiy} to (d).

\pfcases{(abs-i-alpha), (abs-i-t), (abs-i-unit)} Apply (d).

\pfcases{(abs-i-parr), (abs-i-forall), (abs-i-mu), (abs-i-prod), (abs-i-sum)} These cases follow by iterated application of the IH and Lemma \ref{lemma:static-canonical-forms}.8.
\end{proof}

The induction in this case is justified for cases (-not-delegated-new) because the number of sub-terms of the form $\sty{c}{\st}$ is strictly decreasing by kinding.

\subsection{Translation Validation}
\subsubsection{Type and Typing Context Translation Validation}
\begin{lemma}[Type Translation]
\label{lemma:type-translation}
If (a) $\vdash \Phi$ and (b) $\tytransX{\st}{\tau}$ then $\emptyset \vdash \tau$.
\end{lemma}
\begin{proof} Rule induction on (b). There is only one rule, so we have $\tau=[\delta]\tau'$ \begin{enumerate}[(1)]
\item $\istype{\st}{\Phi}$
\item $\tytsvX{\memD}$
\item $\tdeabs{\Phi}{c}{\srep{\st}}{\memD}{\tau'}{\memD'}$
\item $\memD' \leadsto \delta : \Delta$
\end{enumerate}
Taking $\memD=\emptyset$ and applying Lemma \ref{lemma:selective-type-translation-abstraction}, we have $\Delta \vdash \tau'$ and $\emptyset \vdash \delta : \Delta$. Applying Assumption \ref{lemma:internal-type-substitution-on-types}, we have our conclusion.
\end{proof}

\begin{lemma}[Typing Context Translation]
If (a) $\vdash \Phi$ and (b) $\ctxtransX{\Upsilon}{\Gamma}$ then $\emptyset \vdash \Gamma$.\end{lemma}
\begin{proof} Rule induction on the assumption.

\pfcase{(ctx-trans-emp)} We have $\emptyset \vdash \Gamma$ by (ictx-emp).

\pfcase{(ctx-trans-ext)} We have that $\Upsilon=\Upsilon', x : \st$ and $\Gamma=\Gamma', x : \tau$ and (1) $\ctxtransX{\Upsilon'}{\Gamma}$ and (2) $\tytransX{\st}{\tau}$.

Applying the IH to (a) and (1), we have (3) $\emptyset \vdash \Gamma'$.

Applying Lemma \ref{lemma:type-translation} to (a) and (2) we have (4) $\emptyset \vdash \tau$. Applying (ictx-ext) to (3) and (4), we have $\emptyset \vdash \Gamma', x : \tau$.
\end{proof}

\begin{lemma}[Typing Context Translation Membership]
\label{lemma:typing-context-translation-membership}
If (a) $\vdash \Phi$ and (b) $\ctxtransX{\Upsilon}{\Gamma}$ and (c) $x : \sty{c}{\st} \in \Upsilon$ then (i) $\tytransX{\st}{\tau}$ and (ii) $x : \tau \in \Gamma$.
\end{lemma}
\begin{proof} Rule induction on (b) and (c).

\pfcase{(ctx-trans-emp)} Does not apply by (c).

\pfcase{(ctx-trans-ext)} We have that $\Upsilon=\Upsilon', x' : \st'$ and  (1) $\ctxtransX{\Upsilon'}{\Gamma'}$. We have two cases by (c):

\begin{quote}
    \pfcase{$x=x'$} We have our conclusion as the second premise.

    \pfcase{$x\neq x'$ and (2) $x : \sty{c}{\st} \in \Upsilon'$} Applying the IH to (1) and (2), we have our conclusion.
\end{quote}
\end{proof}

\subsubsection{Selectively Abstracted Term Translations}
The rules for selectively abstracted term translations are specified in Figures \ref{fig:selectively-abstracted-term-translations-1} and \ref{fig:selectively-abstracted-term-translations-2}. The auxiliary judgement for validating a type and term translation store together is $\tmtsvX{\memD}{\memG}$, specified in Figure \ref{fig:term-translation-store-validity}. The internalization judgement $\memG \leadsto \gamma : \Gamma$ is specified in Figure \ref{fig:term-translation-store-Internalization}.

\begin{lemma}
\label{lemma:get-D}
If $\tmtsvX{\memD}{\memG}$ then $\tytsvX{\memD}$.
\end{lemma}
\begin{proof}
    The conclusion is a premise of each rule for the assumption.
\end{proof}

\begin{lemma}[Argument Translation]
\label{lemma:argument-translation}
If (a) $\tmtsvX{\memD}{\memG}$ and (b) $n : \st \leadsto \iota/x : \tau$ then \begin{enumerate}[(i)]
\item $\tytsvX{\memD}$
\item $\tdeabs{\Phi}{c}{\srep{\st}}{\memD}{\tau}{\memD}$
\item $\memD \leadsto \delta : \Delta$
\item $\tytransX{\st}{[\delta]\tau}$
\item $\keyw{nth}[n](\es)=e$
\item $\eanaX{e}{\st}{\iota}$
\end{enumerate}
\end{lemma}
\begin{proof} Rule induction on (a) and (b).

\pfcase{(tmts-ok-emp)} Does not apply by (b).

\pfcase{(tmts-ok-ext)} We have $\memG=\memG', n' : \st' \leadsto \iota'/x' :\tau'$ There are two cases by (b).
\begin{quote}
    \pfcase{$n=n'$} The conclusions are the premises.

    \pfcase{$n\neq n'$} Apply the IH.
\end{quote}
\end{proof}

\begin{lemma}[Selectively Abstracted Term Translation]
\label{lemma:selectively-abstracted-term-translations}
If (a) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (b) $\sval{\sqitm{\qitm}}{\es;\Upsilon;\Phi}$ and (c) $|\es|=n$ and (d) $\vdash \Phi$ and (e) $\ctxtransX{\Upsilon}{\Gamma}$ and (f) $\tmtsvX{\memD}{\memG}$ and (g) $\edeabs{c}{\es;\Upsilon;\Phi}{\qitm}{\memD}{\memG}{\itm}{\memD'}{\memG'}$ then $\tmtsvX{\memD'}{\memG'}$.
\end{lemma}
\begin{proof} Rule induction on (g).

\pfcase{(abs-anatrans-new)} In this case, $\qitm=\anatrans{n'}{\st}$ and $\itm=x$ and $\memG'=\memG, n' : \st \leadsto \iota/x : \tau$ and \begin{enumerate}
    \item $n' \notin \text{dom}(\memG)$
    \item $\keyw{nth}[n'](\es)=e$
    \item $\eanaX{e}{\st}{\iota}$
    \item $\tdeabs{\Phi}{c}{\srep{\st}}{\memD}{\tau}{\memD'}$
\end{enumerate}

By Lemma \ref{lemma:get-D} on (f), we have (5) $\tytsvX{\memD}$.

By iterated application of Lemma \ref{lemma:static-canonical-forms}, we have (6) $\sofkVX{\sqity{\srep{\st}}}{\kity}$ and (7) $\sval{\sqity{\srep{\st}}}{\es;\Upsilon;\Phi}$ and (8) $\istype{\st}{\Phi}$.

By Lemma \ref{lemma:selective-type-translation-abstraction} on (6), (7), (d), (5) and (4) we have (9) $\tytsvX{\memD'}$ and (10) $\memD' \leadsto \delta : \Delta$.

By Lemma \ref{lemma:type-translation-stores-are-idempotent} on (6), (7), (d) and (4) we have (11) $\tdeabs{\Phi}{c}{\srep{\st}}{\emptyset}{\tau}{\memD'}$ and (12) $\tdeabs{\Phi}{c}{\srep{\st}}{\memD'}{\tau}{\memD'}$.

By (ty-trans) on (8), (11) and (10), we have (13) $\tytransX{\st}{[\delta]\tau}$.

Apply (tmts-ok-ext) to (5), (7), (10), (13), (2) and (3).

\pfcase{(abs-anatrans-stored)} We have $\memD'=\memD$ and $\memG'=\memG$. Apply (e).

\pfcase{(abs-syntrans-new)}  In this case, $\qitm=\syntrans{n'}$ and $\itm=x$ and $\memG'=\memG, n' : \st \leadsto \iota/x : \tau$ and \begin{enumerate}
    \item $n' \notin \text{dom}(\memG)$
    \item $\keyw{nth}[n'](\es)=e$
    \item $\esynX{e}{\st}{\iota}$
    \item $\tdeabs{\Phi}{c}{\srep{\st}}{\memD}{\tau}{\memD'}$
\end{enumerate}

By Lemma \ref{lemma:get-D} on (f), we have (5) $\tytsvX{\memD}$.

By Lemma \ref{lemma:type-synthesis} and kinding rules, we have (6) $\sofkVX{\sqity{\srep{\st}}}{\kity}$ and (7) $\sval{\sqity{\srep{\st}}}{\es;\Upsilon;\Phi}$ and (8) $\istype{\st}{\Phi}$.

By Lemma \ref{lemma:selective-type-translation-abstraction} on (6), (7), (d), (5) and (4) we have (9) $\tytsvX{\memD'}$ and (10) $\memD' \leadsto \delta : \Delta$.

By Lemma \ref{lemma:type-translation-stores-are-idempotent} on (6), (7), (d) and (4) we have (11) $\tdeabs{\Phi}{c}{\srep{\st}}{\emptyset}{\tau}{\memD'}$ and (12) $\tdeabs{\Phi}{c}{\srep{\st}}{\memD'}{\tau}{\memD'}$.

By (ty-trans) on (8), (11) and (10), we have (13) $\tytransX{\st}{[\delta]\tau}$.

Apply (tmts-ok-ext) to (5), (7), (10), (13), (2) and (3).

\pfcase{(abs-syntrans-stored)} We have $\memD'=\memD$ and $\memG'=\memG$. Apply (e).

\pfcases{(abs-x), (abs-triv)} We have $\memD'=\memD$ and $\memG'=\memG$. Apply (e).

\pfcases{(all remaining cases)} These cases follow by iterative application of the IH and Lemma \ref{lemma:static-canonical-forms}.9.

\end{proof}

\subsubsection{Translation Validation}
The translation validation judgement is specified in Figure \ref{fig:translation-validation} and discussed together with type-preserving translation below.

\subsection{Type-Preserving Translation and Type Safety}
\begin{theorem}[Type-Preserving Translation] 
\label{thm:type-preserving-translation}
\begin{enumerate}
\item[] ~
\item[1)] If (a) $\vdash \Phi$ and (b) $\ctxtransX{\Upsilon}{\Gamma}$ and (c) $\esynX{e}{\st}{\iota}$ then (i) $\tytransX{\st}{\tau}$ and (ii) $\emptyset~\Gamma \vdash \iota : \tau$.
\item[2)] If (a) $\vdash \Phi$ and (b) $\ctxtransX{\Upsilon}{\Gamma}$ and (c) $\istype{\st}{\Phi}$ and (d) $\eanaX{e}{\st}{\iota}$ then (i) $\tytransX{\st}{\tau}$ and (ii) $\emptyset~\Gamma \vdash \iota : \tau$.
\end{enumerate}
\end{theorem}
\begin{proof}
\pfcase{(subsume)} In this case of 2), we have that (1) $\esynX{e}{\st}{\iota}$. Apply the IH to (a), (b) and (1).

\pfcase{(ascribe)} In this case of 1), we have that $e=e' : \st'$ and (1) $\sofkVXz{\st'}{\kty}$ and (2) $\st' \Downarrow_{\cdot;\emptyset;\Phi} \st$ and (3) $\eanaX{e}{\st}{\iota}$.

Applying Definition \ref{definition:static-normalization} to (2), we have (4) $\sval{\st}{\cdot;\emptyset;\Phi}$. Applying Corollary \ref{lemma:static-normalization-preservation} to (1) and (2), we have (5) $\sofkVXz{\st}{\kty}$. Applying Definition \ref{def:types} to (4) and (5), we have (6) $\istype{\st}{\Phi}$. Apply the IH to (a), (b), (6) and (3).

\pfcase{(syn-var)} In this case of 1), We have $e=x$ and $\iota=x$ and (1) $x : \st \in \Upsilon$. Applying Lemma \ref{lemma:typing-context-translation-membership} to (a) and (b) and (1), we have (i) and (2) $x : \tau \in \Gamma$. Applying the standard typing variable rule for the IL to (2), we have $\emptyset \Gamma \vdash x : \tau$.

\pfcase{(ana-fix)} In this case of 2), we have $e=\efix{x}{e'}$ and $\iota=\ifix{\tau}{x}{\iota'}$ and (1) $\eana{\Upsilon, x : \st}{e'}{\st}{\iota'}$ and (2) $\tytransX{\st}{\tau}$, i.e. (i). 

Applying (ctx-trans-ext) to (b) and (2), we have (3) $\ctxtransX{\Upsilon, x : \st}{\Gamma, x : \tau}$. 

Applying Lemma \ref{lemma:types-with-translations-are-types} to (2), we have (4) $\istype{\st}{\Phi}$.

Applying the IH to (a), (3), (4) and (1), we have (5) $\emptyset~\Gamma, x : \tau \vdash \iota' : \tau$.

Applying Lemma \ref{lemma:type-translation} to (2), we have (6) $\emptyset \vdash \tau$.

By the standard typing rule for fixpoints in the IL on (6) and (5), we have (i) $\emptyset~\Gamma, x : \tau \vdash \ifix{\tau}{x}{\iota'}$.

\pfcase{(syn-lam)} In this case of 1), we have $e=\elam{\st_1}{x}{e'}$ and $\st=\sty{\rightharpoonup}{(\st_1, \st_2)}$ and $\iota=\ilam{\tau_1}{x}{\iota'}$ and (1) $\sofkVXz{\st_1}{\kty}$ and (2) $\st_1 \Downarrow_{\cdot;\emptyset;\Phi} \st_1'$ and (3) $\esyn{\Upsilon, x : \st_1'}{e'}{\st_2}{\iota'}$ and (4) $\tytransX{\st_1'}{\tau_1}$.

Applying Definition \ref{definition:static-normalization} to (2), we have (5) $\sval{\st_1'}{\cdot;\emptyset;\Phi}$. Applying Corollary \ref{lemma:static-normalization-preservation} to (1) and (2), we have (6) $\sofkVXz{\st_1'}{\kty}$. Applying Definition \ref{def:types} to (5) and (6), we have (7) $\istype{\st_1'}{\Phi}$.

Applying (ctx-trans-ext) to (b) and (4), we have (8) $\ctxtransX{\Upsilon, x : \st_1'}{\Gamma, x : \tau_1}$.

Applying the IH to (a), (8) and (3), we have (9) $\tytransX{\st_2}{\tau_2}$ and (10) $\emptyset~\Gamma, x : \tau_1 \vdash \iota' : \tau_2$.

By Lemma \ref{fig:type-translation} on (9), we have (11) $\emptyset \vdash \tau_2$.

By the standard typing rule for lambdas in the IL on (10) and (9), we have (ii).

%\pfcase{(ana-lam)} This case follows the script above.\todo{copy pasta}

\pfcase{(syn-ap)} In this case of 1), we have $e=e_1(e_2)$ and $\iota=\iota_1(\iota_2)$ and (1) $\esynX{e_1}{\sty{\rightharpoonup}{(\st_1, \st_2)}}{\iota_1}$ and (2) $\eanaX{e_2}{\st_1}{\iota_2}$.

Applying the IH to (a), (b) and (1), we have (3) $\tytransX{\st_1}{\tau_1}$ and (4) $\emptyset~\Gamma \vdash \iota_1 : \tau_1$.

Applying the IH to (a), (b) and (2), we have (5) $\tytransX{\st_2}{\tau_2}$ and (6) $\emptyset~\Gamma \vdash \iota_2 : \tau_2$.

By the standard typing rule for application in the IL on (4) and (6), we have (ii).

\pfcase{(ana-intro)} In this case of 2), we have $e=\eintro{\sttmidx}{\es}$ and $\st=\sty{\tc}{\sttyidx}$ and \begin{enumerate}[(1)]
  \item $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$
  \item $\introsig{\klitidx} \in \chi$
  \item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stmidx}{\klitidx}$
  \item $\keyw{ana~intro}={\stx{def}} \in \omega$
  \item $|\es| = n$
  \item $\keyw{args}(n)=\stx{args}$
  \item $\stx{def}(\sttyidx)(\stmidx)(\stx{args}) \Downarrow_{\es;\Upsilon;\Phi} \sqitm{\qitm}$
  \item $\trvalidate{\es;\Upsilon;\Phi}{\tc}{\qitm}{{\sty{\tc}{\sttyidx}}}{\iota}$
\end{enumerate}

Apply Lemma \ref{lemma:tycon-context-validity} to (1), we have that there exists a prefix $\Phi'$ of $\Phi$ such that (9) $\vdash_{\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \psi$ and (10) $\vdash \Phi'$.

Apply Lemma \ref{lemma:stability-of-opcon-structure-validity-3} to (10), (9) and (a), we have (11) $\vdash_{\Phi} \omega \sim \psi$

Applying Lemma \ref{lemma:intro-opcon-existence-and-validity} to (11) and (4), we have (12) $\sofkVXz{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$. 

Applying Lemma \ref{lemma:weakening-of-argument-bounds} to (12), we have (13) $\sofkVXz{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow \kitm}$. 

Applying Lemma \ref{lemma:static-canonical-forms} on (c), we have that (14) $\sofkVX{\sttyidx}{\ktyidx}$.

Apply Lemma \ref{lemma:argument-interface-lists}, we have that (15) $\sofkVX{\stx{args}}{\kargs}$.

Applying (k-ap) three times with (13), (14), (3) and (15), we have that (16) $\sofkVX{\stx{def}(\sttyidx)(\stmidx)(\stx{args})}{\kitm}$.

Applying Lemma \ref{lemma:static-normalization-preservation} to (16) and (7), we have (17) $\sofkVX{\sqitm{\qitm}}{\kitm}$.

Applying Definition \ref{definition:static-normalization} to (7), we have (18) $\sval{\sqitm{\qitm}}{\es;\Upsilon;\Phi}$.

Apply Lemma \ref{lemma:translation-validation} to (a), (b), (c), (17), (18), (5) and (7).

\pfcase{(syn-targ)} In this case of 1), we have $e=\etarg{\opname{op}}{\stx{tmidx}}{e_\text{targ}}{\es}$ and \begin{enumerate}[(1)]
\item $\esynX{e_\text{targ}}{\sty{\tc}{\sttyidx}}{\iota_\text{targ}}$ and 
\item $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$ and
\item $\opsig{\opname{op}}{\klitidx} \in \chi$ and
\item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stmidx}{\klitidx}$ and
\item $\keyw{syn~}\opname{op}={\stx{def}} \in \omega$ and
\item $|e_\text{targ}; \es| = n$ and
\item $\keyw{args}(n)=\stx{args}$ and
\item $\stx{def}(\sttyidx)(\stmidx)(\stx{args}) \Downarrow_{(e_\text{targ}; \es);\Upsilon;\Phi} (\st, \sqitm{\qitm})$.
\end{enumerate}

Applying Lemma \ref{lemma:type-synthesis} to (a), (b) and (1), we have (9) $\istype{\sty{\tc}{\sttyidx}}{\Phi}$. By Lemma \ref{lemma:static-canonical-forms}.7 on (9), we have (10) $\sofkVXz{\sttyidx}{\ktyidx}$. Applying Lemma \ref{lemma:weakening-of-argument-bounds} to (10), we have (11) $\sofkVX{\sttyidx}{\ktyidx}$.

Applying Lemma \ref{lemma:tycon-context-validity} to (2), we have that there is a prefix $\Phi'$ of $\Phi$ such that (12) $\vdash \Phi'$ and (13) $\vdash \Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}$ and (14) $\vdash_{\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}} \omega \sim \tcsig{\ktyidx}{\chi}$.

Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} to (12), we have (15) $\tccsigok{\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}}$. Applying Lemma \ref{lemma:well-defined-contexts-have-well-formed-signatures} to (a), taking by the definition of prefixing that $\Phi=(\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}})\Phi''$, we have (16) $\tccsigok{(\Phi', \tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}})\Phi''}$. Applying Lemma \ref{lemma:stability-of-opcon-structure-validity} to (15), (14) and (16), we have that (17) $\vdash_{\Phi} \omega \sim \tcsig{\ktyidx}{\chi}$.


Applying Lemma \ref{lemma:targeted-opcon-validity} to (17) and (5), we have that (18) $\sofkz{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$. Applying Lemma \ref{lemma:weakening-of-argument-bounds} to (18), we have (19) $\sofk{\emptyset}{\emptyset}{\Phi}{\stx{def}}{\ktyidx \rightarrow \klitidx \rightarrow \kargs \rightarrow (\kty \times \kitm)}$.

Applying Lemma \ref{lemma:argument-interface-lists} to (7), we have that (20) $\sofkVX{\stx{args}}{\kargs}$. 

Applying (k-ap) three times with (19), (11), (4) and (20), we have that (21) $\sofkVX{\stx{def}(\sttyidx)(\stx{tmidx})(\stx{args})}{\kty\times\kitm}$. 

Applying Corollary \ref{lemma:static-normalization-preservation} to (8), (21), (a) and (b), we have that (22) $\sofkVX{(\st, \sqitm{\qitm})}{\kty\times\kitm}$. By Definition \ref{definition:static-normalization} on (8), we have (23) $\sval{(\st, \sqitm{\qitm})}{(e_\text{targ}; \es); \Upsilon; \Phi}$. 

Applying Lemma \ref{lemma:static-canonical-forms} to (23) and (22), we have that (24) $\sofkVX{\st}{\kty}$ and (25) $\sval{\st}{(e_\text{targ}; \es); \Upsilon; \Phi}$ and (26) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (27) $\sval{\sqitm{\qitm}}{(e_\text{targ}; \es);\Upsilon;\Phi}$.  Applying Definition \ref{def:types} to (24) and (25) we have (28) $\istype{\st}{\Phi}$.

Apply Lemma \ref{lemma:translation-validation} to (a), (b), (28), (26), (27), (6) and (8).

\pfcase{(ana-intro-other)} In this case, we have that $e=\eintro{\sqitm{\qitm}}{\es}$ and $\st=\sty{\otherc{m}{\kappa}}{\sttyidx}$ and \begin{enumerate}[(1)]
    \item $|\es|=n$
    \item $\sofkVX{\sqitm{\qitm}}{\kitm}$
    \item $\sval{\sqitm{\qitm}}{\es; \Upsilon; \Phi}$
    \item $\trvalidate{\es;\Upsilon;\Phi}{\keyw{other}[m;\kappa]}{\qitm}{{\sty{\keyw{other}[m;\kappa]}{\sttyidx}}}{\iota}$
\end{enumerate}

Apply Lemma \ref{lemma:translation-validation} to (a), (b), (c), (2), (3), (1) and (4).

\pfcase{(syn-targ-other)} In this case, we have that $e=\etarg{\opname{op}}{\sqitm{\qitm}}{e_\text{targ}}{\es}$ and \begin{enumerate}[(1)]
    \item $\esynX{e_\text{targ}}{\sty{\keyw{other}[m;\kappa]}{\sttyidx}}{\iota_\text{targ}}$
    \item $|e_\text{targ}; \es| = n$
    \item $\sofk{\emptyset}{\emptyset}{\Phi}{\sqitm{\qitm}}{\kitm}$
    \item $\sval{\sqitm{\qitm}}{(e_\text{targ}; \es); \Upsilon; \Phi}$
    \item $\istype{\st}{\Phi}$
    \item $\trvalidate{(e_\text{targ}; \es);\Upsilon;\Phi}{\keyw{other}[m;\kappa]}{\qitm}{{\st}}{\iota}$
\end{enumerate}

Apply Lemma \ref{lemma:translation-validation} to (a), (b), (9), (3), (4), (2), (5) and (6).
\end{proof}

\begin{lemma}[Translation Validation]
\label{lemma:translation-validation}
If (a) $\vdash \Phi$ and (b) $\ctxtransX{\Upsilon}{\Gamma}$ and (c) $\istype{\st}{\Phi}$ and (d) $\sofkVX{\sqitm{\qitm}}{\kitm}$ and (e) $\sval{\sqitm{\qitm}}{\es;\Upsilon;\Phi}$ and (f) $|\es|=n$ and (g) $\vdash_{\es;\Upsilon;\Phi}^c \qitm : \st \leadsto \iota$ then (i) $\tytransX{\st}{\tau}$ and (ii) $\emptyset~\Gamma \vdash \iota : \tau$.
\end{lemma}
\begin{proof}
    Rule induction on (g). There is one rule, so we have \begin{enumerate}[(1)]
        \item $\tdeabs{\Phi}{c}{\srep{\st}}{\emptyset}{\ity_\text{abs}}{\memD}$
        \item $\edeabs{c}{{\es;\Upsilon;\Phi}}{\qitm}{\memD}{\emptyset}{\iota_\text{abs}}{\memD'}{\memG}$
        \item $\memD' \leadsto \delta : \Delta_\text{abs}$
        \item $\memG \leadsto \gamma : \Gamma_\text{abs}$
        \item $\Delta_\text{abs}~\Gamma_\text{abs} \vdash \iota_\text{abs} : \tau_\text{abs}$
    \end{enumerate}

    Applying Lemma \ref{lemma:selective-type-translation-abstraction} on (1), we have that (6) $\tytsvX{\memD}$.

    Applying Lemma \ref{lemma:selectively-abstracted-term-translations} to (6), we have (7) $\tmtsvX{\memD}{\memG}$.

    Applying Lemma \ref{lemma:BINGO}, we have that (8) $\memD \leadsto \delta : \Delta_\text{abs}$ and (9) $\memG \leadsto \gamma : \Gamma_\text{abs}$ and (10) $\emptyset \vdash \delta : \Delta_\text{abs}$ and (11) $\Delta~\Gamma \vdash \gamma : \Gamma_\text{abs}$.

    By Assumptions \ref{assumption:internal-term-substituions} and \ref{lemma:internal-type-substitutions-on-terms} and (5) and (10) and (11), we have that $\emptyset~\Gamma \vdash [\delta][\gamma]\iota_\text{abs} : \tau_\text{abs}$.
\end{proof}

\begin{lemma}
\label{lemma:BINGO}
    If (a) $\tmtsvX{\memD}{\memG}$ and (b) $\ctxtransX{\Upsilon}{\Gamma}$ and (c) $\memD \leadsto \delta : \Delta_\text{abs}$ and (d) $\memG \leadsto \gamma : \Gamma_\text{abs}$ then (i) $\emptyset \vdash \delta : \Delta$ and (ii) $\Delta~\Gamma \vdash \gamma : \Gamma_\text{abs}$.
\end{lemma}\begin{proof} Inversion on (a).

    (i) follows from Lemma \ref{lemma:type-translation-store-validitiy}.
    (ii) follows by inductive appeal to Theorem \ref{thm:type-preserving-translation}, justified by the same metric as Theorem \ref{lemma:type-synthesis}.
\end{proof}

% \subsection{Stability}
% \todo{}

% \subsection{Unicity}
% Need determinism of static dynamics for this.

% The rules are structured so that if a term is well-typed, both its type and translation are unique.%\todo{could move this whole thing to supplement if room needed}
% \begin{theorem}[Unicity]
% If $\vdash \Phi$ and $\Upsilon~\mathtt{ctx}_{\Phi} \leadsto \Gamma$ and $\vdash_\Phi \st \leadsto \tau$ and $\vdash_\Phi \st' \leadsto \tau'$ and $\eanaX{e}{\st}{\iota}$ and $\eanaX{e}{\st'}{\iota'}$ then $\st = \st'$ and $\tau=\tau'$ and $\iota = \iota'$.
% \end{theorem}

\subsection{Conservativity}
\subsubsection{Backprojection}
To avoid having to give a large number of rules that do nothing interesting, we define backprojection on static terms definitionally. In the discussion below, let $\Phi'=\Phi, \tcdef{\tc'}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}}}{\st}{\kappa}$.

\newcommand{\bprj}[4]{{}^{m}\mathcal{B}_{#1}^{#2}(#3)=#4}
\newcommand{\bprjX}[2]{\bprj{\Phi'}{\tc'}{#1}{#2}}
\begin{definition}[Backprojection (Static values)]
We write $\bprjX{\st}{\st'}$ for the backprojection of $\st$ when $\sofk{\emptyset}{\emptyset}{\Phi'}{\st}{\kappa}$ and $\sval{\st}{\argEnv}$ and $\stx{schema}(\sttyidx) \Downarrow_{\cdot;\emptyset;\Phi'} \sqity{\qity}$. We generate $\st'$ by replacing all sub-terms of the form $\sty{\tc'}{\sttyidx}$ with a sub-term of the form $\sty{\otherc{m}{\ktyidx}}{(\sttyidx, \sqity{\qity})}$. 
\end{definition}

All interesting properties about static values (in particular, that they are values and their kind) are preserved under backprojection.

\begin{lemma}
If $\sofk{\emptyset}{\emptyset}{\Phi'}{\st}{\kappa}$ and $\sval{\st}{\argEnv}$ and $\bprjX{\st}{\st'}$ then $\sofkVX{\st'}{\kappa}$ and $\sval{\st'}{\argEnv}$.
\end{lemma}

For types, backprojection preserves the type translation (essentially trivially, since the translational internal type is contained directly in the index) and for all types other than those constructed by $\tc$, their tycons.

\begin{lemma}
If $\sofk{\emptyset}{\emptyset}{\Phi'}{\st}{\kty}$ and $\sval{\st}{\argEnv}$ and $\tytrans{\Phi'}{\st}{\tau}$ and $\bprjX{\st}{\st'}$ then $\tytransX{\st}{\tau}$ and if $\st=\sty{c}{\sttyidx}$ and $c\neq\tc'$ then $\bprjX{\sttyidx}{\sttyidx'}$ and $\st'=\sty{c}{\sttyidx'}$.
\end{lemma}

We can map backprojection over typing contexts in the same way.
\begin{definition}[Backprojection (Typing Contexts)]
We write $\bprjX{\Upsilon}{\Upsilon'}$ when $\vdash_\Phi \Upsilon$ for the mapping of the backprojection operation over all types in $\Upsilon$.
\end{definition}

\begin{lemma} 
If $\ctxtrans{\Phi'}{\Upsilon}{\Gamma}$ and $\bprjX{\Upsilon}{\Upsilon'}$ then $\ctxtrans{\Phi}{\Upsilon}{\Gamma}$.
\end{lemma}

\begin{definition}[Modular Propositions]
We say a proposition $P(\Gamma, \st, \iota)$ is \emph{modular} under $\Phi$ if for all $\Phi''$ such that $\vdash \Phi\Phi''$ and all $\tc \in \text{dom}(\Phi'')$, we have that if $\bprj{\Phi\Phi''}{\tc'}{\st}{\st'}$ and $P(\Gamma, \st', \iota)$ then $P(\Gamma, \st, \iota)$.
\end{definition} 

Note that for propositions constrained to only hold for $\st : \kappa$ such that $\kappa$ does not contain $\kty$, the proposition is modular trivially because backprojection is the identity relation in that case. In other cases, the proposition simply must not ``know'' about future tycons or treat ``other'' tycons in a special way (e.g. counting how many there are). We expect that this will generally be straightforward to establish. Note that this is a property of the invariant, and can thus be established modularly, not a proof obligation for every composition.

\begin{definition}[Backprojection (External Terms)]
If $\vdash \Phi'$ and $\ctxtrans{\Phi'}{\Upsilon}{\Gamma}$ and $\eana{\Upsilon}{\Phi'}{e}{\st}{\iota}$ or $\esyn{\Upsilon}{\Phi'}{e}{\st}{\iota}$ then we define $\bprjX{e}{e'}$ by mapping the following transformation over all sub-terms $e''$: \begin{enumerate}
\item If $e''=\eintro{\sttmidx}{\es}$ such that \begin{enumerate}[(1)]
  \item $\tcdef{\tc}{\tcsig{\ktyidx}{\chi}}{\tcstruct{\stx{schema}}{\omega}} \in \Phi$
  \item $\introsig{\klitidx} \in \chi$
  \item $\sofkz{\emptyset}{\emptyset}{\Phi}{\stmidx}{\klitidx}$
  \item $\keyw{ana~intro}={\stx{def}} \in \omega$
  \item $|\es| = n$
  \item $\keyw{args}(n)=\stx{args}$
  \item $\stx{def}(\sttyidx)(\stmidx)(\stx{args}) \Downarrow_{\es;\Upsilon;\Phi} \sqitm{\qitm}$
  \item $\tdeabs{\Phi}{c}{\srep{\st}}{\emptyset}{\ity_\text{abs}}{\memD}$
  \item $\edeabs{c}{{\es;\Upsilon;\Phi}}{\qitm}{\memD}{\emptyset}{\iota_\text{abs}}{\memD'}{\memG}$
  \item $\memD' \leadsto \delta : \Delta_\text{abs}$
  \item $\memG \leadsto \gamma : \Gamma_\text{abs}$
  \item $\Delta_\text{abs}~\Gamma_\text{abs} \vdash \iota_\text{abs} : \tau_\text{abs}$
\end{enumerate}

We generate $\eintro{\sqity{\qity}}{\es'}$ where $\bprjX{\es}{\es'}$ maps backprojection recursively over all terms in $\es$ for which a type was recorded in $\memG$. All others can be left alone (they have no bearing on the type or translation).

\item If $e''=\etarg{\opname{op}}{\sttmidx}{e_\text{targ}}{\es}$ the procedure is analagous.
\end{enumerate}
\end{definition}

Comparing (ana-intro) and (ana-intro-other), and (syn-targ) and (syn-targ-other), it is straightforward to see that term translations are invariant with respect to backprojection, and types respect backprojection.

\begin{lemma}
If $\vdash \Phi'$ and $\ctxtrans{\Phi'}{\Upsilon}{\Gamma}$ and $\eana{\Upsilon}{\Phi'}{e}{\st}{\iota}$ or $\esyn{\Upsilon}{\Phi'}{e}{\st}{\iota}$ then $\bprjX{e}{e'}$ and $\bprjX{\Upsilon}{\Upsilon'}$ and $\ctxtrans{\Phi}{\Upsilon'}{\Gamma}$ and $\bprjX{\st}{\st'}$ and $\eana{\Upsilon'}{\Phi}{e}{\st'}{\iota}$.
\end{lemma}

The end result is that we have our conservativity theorem.

\begin{theorem}[Conservativity]\label{thm:conservativity} If $\vdash \Phi$ and $\tc \in \text{dom}(\Phi)$ and a tycon invariant for $\tc$ holds under $\Phi$: \begin{itemize}
\item For all $\Upsilon, e, \sttyidx$, if $\eana{\Upsilon}{\Phi}{e}{\sty{\tc}{\sttyidx}}{\iota}$ and $\ctxtransX{\Upsilon}{\Gamma}$ and $\vdash_\Phi {\sty{\tc}{\sttyidx}} \leadsto \tau$  then $P(\Gamma, \sttyidx, \iota)$.
\end{itemize} then for all $\Phi' = \Phi, \tcdef{\tc'}{\tcsig{\kappa'}{\chi'}}{\theta'}$ such that $\vdash \Phi'$, the same tycon invariant holds under $\Phi'$: \begin{itemize}
\item For all $\Upsilon, e, \sttyidx$, if $\eana{\Upsilon}{\Phi'}{e}{\sty{\tc}{\sttyidx}}{\iota}$ and $\vdash_{\Phi'} \Upsilon \leadsto \Gamma$ and $\vdash_{\Phi'}{\sty{\tc}{\sttyidx}}\leadsto{\tau}$ then $P(\Gamma, \sttyidx, \iota)$.
\end{itemize}
(if proposition $P(\Gamma, \st, \iota)$ is \emph{modular})
\end{theorem}
\begin{proof-sketch}
We simply backproject our typing derivation, apply the original tycon invariant, then apply the definition of modular propositions.\end{proof-sketch}

This section has, obviously, been less detailed than the remainder of the supplement, essentially because the lemmas above involve a rather large number of cases where nothing of note is happening, and we simply ran out of time to inductively specify the full details of backprojection and prove all of them. Backprojection is a rather simple conceptual mapping, so we believe that the level of detail above is sufficiently convincing, and we plan on writing out the full details (which we anticipate will be another 20 or so pages) well before the notification date.

% \subsection{Decidability}
% Not going to prove this so probably take it out.
\section{Discussion}
\subsection{Record Types}
In the paper, we presented labeled products rather than the more conventional record types, both to emphasize that different variants have different trade-offs, and because it made our examples simpler.

One strategy for supporting records themselves would be to specify the intro operator such that records that do not have sorted indices are uninhabited, then provide a helper static function that generates only sorted indices and require that all type construction pass through that. This notion of a ``type constructor constructor'' could perhaps be integrated into the calculus.

An alternative strategy may have been to use an abstract kind that ensured that such type indices could not have been constructed, but to be compatible with our equality kind restriction, this would require support for abstract equality kinds, analagous to abstract equality types in SML. We chose not to formalize these for simplicity, and to demonstrate the general technique above. This could also have been used for the labeled product example.

\subsection{Conjectures}
Other properties that we conjecture are true but have not yet proven include decidability of typing (which requires proving strong normalization of the SL), unicity of typing (i.e. that types and translations, if they exist, are unique; this requires proving determinism of normalization), and stability (i.e. that extending the tycon context doesn't change the meaning of already well-typed terms; this is essentially trivial by inspection of the rules, and we proved stability of kinding and tycon context validity above because these were needed for other purposes, but ran out of time and space in the paper to even mention this). Note that because these have no formal development, we did not mention them as contributions in the paper.

\subsection{Additional Examples}
We have developed additional examples, and developed detailed proof sketches of tycon invariants with them. These will also be available in the final supplement, but due to recent changes in our calculus, and the tedium of writing ``code'' using TeX macros, these also didn't make the cut in the submitted supplement. There is nothing conceptually novel in these examples, and we did not claim that we had additional complete examples available upon submission in the paper.

Note that because of our simplification related to inductive kinds here, the regular string example cannot be encoded (kind $\krx$ is an inductive sum).


% We recommend abbrvnat bibliography style.
\include{att-pldi15-supplement-figures}

\clearpage
\bibliographystyle{abbrv}

% The bibliography should be embedded for final submission.

\bibliography{../research}
%\softraggedright
%P. Q. Smith, and X. Y. Jones. ...reference text...
\end{document}
